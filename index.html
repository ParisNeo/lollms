<!DOCTYPE html>
<html lang="en"> <!-- lang attribute will be updated by i18n -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="appTitle">Simplified LoLLMs Chat</title>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <!-- Tailwind CSS via Play CDN (for development/demo) -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <!-- Marked.js for Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- KaTeX for Math Rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" crossorigin="anonymous"></script>
    <!-- CodeMirror 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/theme/material-darker.min.css"> <!-- Default theme, can be overridden for light mode -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/meta.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/python/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/mode/shell/shell.min.js"></script>
    <!-- Pyodide (for Python execution) -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>

    <style>
        /* Custom scrollbar for webkit browsers */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-track { background: #2d3748; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #555; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #777; }

        /* CodeMirror styling adjustments */
        .cm-editor { border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em; width: 100%; box-sizing: border-box; }
        .dark .cm-editor { border-color: #4a5568; }
        .code-block-container .cm-editor { max-width: 100%; }
        .code-block-header { background-color: #f0f0f0; padding: 4px 8px; font-size: 0.8em; border-top-left-radius: 4px; border-top-right-radius: 4px; display: flex; justify-content: space-between; align-items: center;}
        .dark .code-block-header { background-color: #2c333d; color: #e2e8f0; }
        .code-block-buttons button { background-color: #e0e0e0; border: none; padding: 2px 6px; font-size: 0.8em; cursor: pointer; border-radius: 3px; margin-left: 5px;}
        .dark .code-block-buttons button { background-color: #4a5568; color: #e2e8f0; }
        .code-block-buttons button:hover { background-color: #d0d0d0; }
        .dark .code-block-buttons button:hover { background-color: #5a6678; }
        
        /* KaTeX display math */
        .katex-display { margin: 0.5em 0 !important; }
        /* Message Bubbles */
        .message-container { display: flex; flex-direction: column; position: relative; }
        .message-bubble { max-width: 85%; padding: 10px 15px; border-radius: 15px; margin-bottom: 10px; word-wrap: break-word; position: relative; }
        .user-bubble { background-color: #dbeafe; /* blue-100 */ align-self: flex-end; border-bottom-right-radius: 5px; }
        .dark .user-bubble { background-color: #2b6cb0; /* blue-700 */ color: #e2e8f0; }
        .ai-bubble { background-color: #f3f4f6; /* gray-100 */ align-self: flex-start; border-bottom-left-radius: 5px; }
        .dark .ai-bubble { background-color: #4a5568; /* gray-700 */ color: #e2e8f0; }
        .system-bubble { background-color: #fef3c7; color: #78350f; align-self: center; font-style: italic; font-size: 0.9em; text-align: center; width: 90%; border-radius: 8px; }
        .dark .system-bubble { background-color: #4a5568; color: #fefcbf; }
        .sender-name { font-size: 0.8em; font-weight: bold; margin-bottom: 4px; color: #4b5563; }
        .dark .sender-name { color: #a0aec0; }
        
        /* RAG Toggle & Datastore Selector */
        .rag-controls { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem; }
        .rag-toggle { padding: 6px 12px; border-radius: 20px; cursor: pointer; transition: background-color 0.3s, color 0.3s; font-weight: 500; border: 1px solid transparent; }
        .rag-toggle-off { background-color: #e5e7eb; color: #4b5563; border-color: #d1d5db; }
        .dark .rag-toggle-off { background-color: #4a5568; color: #e2e8f0; border-color: #718096; }
        .rag-toggle-on { background-color: #10b981; color: white; }
        .dark .rag-toggle-on { background-color: #2f855a; } /* Darker green */
        .rag-toggle:disabled { opacity: 0.5; cursor: not-allowed; }
        #ragDataStoreSelect { font-size: 0.8rem; padding: 4px 8px; border-radius: 6px; border-color: #d1d5db; background-color: white; }
        .dark #ragDataStoreSelect { border-color: #718096; background-color: #2d3748; color: #e2e8f0; }

        /* Star Icon & Discussion List Actions */
        .discussion-item-actions { display: none; gap: 0.25rem; position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%); background-color: rgba(249, 250, 251, 0.8); padding: 2px 4px; border-radius: 4px; z-index: 10;}
        .dark .discussion-item-actions { background-color: rgba(45, 55, 72, 0.8); }
        .discussion-item:hover .discussion-item-actions { display: flex; }
        .discussion-action-btn { background: none; border: none; padding: 2px; cursor: pointer; color: #6b7280; }
        .dark .discussion-action-btn { color: #a0aec0; }
        .discussion-action-btn:hover { color: #1f2937; }
        .dark .discussion-action-btn:hover { color: #e2e8f0; }
        .star-icon { cursor: pointer; color: #d1d5db; }
        .dark .star-icon { color: #718096; }
        .star-icon.starred { color: #facc15; }
        .dark .star-icon.starred { color: #f6e05e; } /* Brighter yellow for dark */

        /* Grade Buttons */
        .grade-btn { background: none; border: none; padding: 2px; cursor: pointer; opacity: 0.6; }
        .dark .grade-btn { /* No specific dark needed if colors are distinct */ }
        .grade-btn:hover { opacity: 1; }
        .grade-btn.selected-up { color: #10b981; opacity: 1; }
        .grade-btn.selected-down { color: #ef4444; opacity: 1; }
        .grade-score { font-size: 0.8em; margin: 0 5px; color: #6b7280; }
        .dark .grade-score { color: #a0aec0; }

        /* Message Footer & Actions */
        .message-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 6px; font-size: 0.75rem; color: #6b7280; padding-top: 4px; border-top: 1px solid rgba(0,0,0,0.05); }
        .dark .message-footer { color: #a0aec0; border-top-color: rgba(255,255,255,0.1); }
        .message-details span { margin-right: 8px; }
        .message-actions { display: none; gap: 0.5rem; }
        .message-bubble:hover .message-actions { display: inline-flex; }
        .message-action-btn { background: none; border: none; padding: 0; cursor: pointer; color: #9ca3af; }
        .dark .message-action-btn { color: #718096; }
        .message-action-btn:hover { color: #374151; }
        .dark .message-action-btn:hover { color: #cbd5e0; }
        .message-action-btn svg { width: 0.875rem; height: 0.875rem; }

        /* Think Block */
        .think-block { background-color: #fffbeb; border: 1px dashed #fcd34d; border-radius: 4px; margin: 8px 0; }
        .dark .think-block { background-color: #42310d; border-color: #b45309; }
        .think-block summary { cursor: pointer; padding: 4px 8px; font-size: 0.8em; font-style: italic; color: #92400e; user-select: none; }
        .dark .think-block summary { color: #fde68a; }
        .think-block .think-content { padding: 5px 10px; font-size: 0.9em; color: #57534e; max-height: 200px; overflow-y: auto; background-color: #fefce8; border-top: 1px dashed #fcd34d; }
        .dark .think-block .think-content { background-color: #35280a; color: #d6ccb9; border-top-color: #b45309; }

        /* Image Previews for Upload */
        #imageUploadPreviewContainer { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px; max-height: 150px; overflow-y: auto; padding: 5px; border: 1px dashed #ccc; border-radius: 4px; }
        .dark #imageUploadPreviewContainer { border-color: #4a5568; }
        .image-preview-item { position: relative; }
        .image-preview-item img { width: 70px; height: 70px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; }
        .dark .image-preview-item img { border-color: #4a5568; }
        .remove-preview-btn { position: absolute; top: -5px; right: -5px; background-color: rgba(255,0,0,0.7); color: white; border: none; border-radius: 50%; width: 18px; height: 18px; font-size: 10px; line-height: 16px; text-align: center; cursor: pointer; font-weight: bold; }
        .remove-preview-btn:hover { background-color: red; }
        
        /* Images in Chat Bubbles */
        .message-images-container { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 8px; }
        .message-image-item { max-width: 150px; max-height: 150px; border-radius: 8px; overflow: hidden; cursor: pointer; }
        .message-image-item img { width: 100%; height: 100%; object-fit: cover; display: block; }
        
        /* Modal Styles */
        .modal { position: fixed; inset: 0; background-color: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 50; opacity: 0; pointer-events: none; transition: opacity 0.3s ease-in-out; padding: 1rem;}
        .modal.active { opacity: 1; pointer-events: auto; }
        .modal-content { background-color: white; padding: 1.5rem 2rem; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); max-width: 95vw; width: 600px; max-height: 90vh; display: flex; flex-direction: column; }
        .dark .modal-content { background-color: #2d3748; /* gray-800 */ color: #e2e8f0; }
        #loginModal .modal-content { width: 400px; }
        #dataStoresModal .modal-content, #fileManagementModal .modal-content, #promptsModal .modal-content, #friendsModal .modal-content { width: 700px; } /* Wider modals */
        .modal-header { border-bottom: 1px solid #e5e7eb; padding-bottom: 0.75rem; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;}
        .dark .modal-header { border-bottom-color: #4a5568; }
        .modal-title { font-size: 1.125rem; font-weight: 600; color: #1f2937; }
        .dark .modal-title { color: #e2e8f0; }
        .modal-body { flex-grow: 1; overflow-y: auto; padding-right: 0.5rem; /* For scrollbar spacing */ }
        .modal-footer { border-top: 1px solid #e5e7eb; padding-top: 1rem; margin-top: 1rem; display: flex; justify-content: flex-end; gap: 0.75rem; }
        .dark .modal-footer { border-top-color: #4a5568; }
        .modal-close-btn { position: absolute; top: 0.75rem; right: 0.75rem; color: #9ca3af; background: none; border: none; cursor: pointer; padding: 0.25rem;}
        .dark .modal-close-btn { color: #718096; }
        .modal-close-btn:hover { color: #1f2937; }
        .dark .modal-close-btn:hover { color: #e2e8f0; }
        
        /* Sidebar button styles */
        .sidebar-btn { display: flex; align-items: center; width: 100%; text-align: left; padding: 0.5rem 0.75rem; font-size: 0.875rem; color: #4b5563; border-radius: 0.375rem; background-color: #f9fafb; border: 1px solid #e5e7eb; }
        .dark .sidebar-btn { background-color: #2d3748; border-color: #4a5568; color: #cbd5e0; }
        .sidebar-btn:hover { background-color: #f3f4f6; }
        .dark .sidebar-btn:hover { background-color: #4a5568; }
        .sidebar-btn svg { margin-right: 0.5rem; width: 1rem; height: 1rem; color: #6b7280; }
        .dark .sidebar-btn svg { color: #a0aec0; }
        
        /* Settings Modal Tabs */
        #settingsModal .modal-content { display: flex; flex-direction: row; padding:0; } /* Override standard padding */
        .settings-tabs { width: 180px; background-color: #f9fafb; border-right: 1px solid #e5e7eb; padding: 1rem; flex-shrink: 0; }
        .dark .settings-tabs { background-color: #1a202c; border-right-color: #4a5568; }
        .settings-tab-btn { display: block; width: 100%; text-align: left; padding: 0.5rem 0.75rem; margin-bottom: 0.25rem; border-radius: 0.25rem; font-size: 0.875rem; }
        .settings-tab-btn.active { background-color: #e0e7ff; color: #3730a3; font-weight: 500; }
        .dark .settings-tab-btn.active { background-color: #3c366b; color: #c7d2fe; }
        .settings-tab-btn:not(.active):hover { background-color: #eef2ff; }
        .dark .settings-tab-btn:not(.active):hover { background-color: #2d3748; }
        .settings-content-pane { flex-grow: 1; padding: 1.5rem 2rem; overflow-y: auto; }
        
        /* Tab styles for other modals (e.g., Prompts, Data Stores, Friends) */
        .modal-tabs { display: flex; border-bottom: 1px solid #e5e7eb; margin-bottom: 1rem; }
        .dark .modal-tabs { border-bottom-color: #4a5568; }
        .modal-tab-btn { padding: 0.5rem 1rem; font-size: 0.875rem; cursor: pointer; color: #6b7280; border-bottom: 2px solid transparent; }
        .dark .modal-tab-btn { color: #a0aec0; }
        .modal-tab-btn.active { color: #3b82f6; border-bottom-color: #3b82f6; font-weight: 500; }
        .dark .modal-tab-btn.active { color: #60a5fa; border-bottom-color: #60a5fa; }
        .modal-tab-content { display: none; }
        .modal-tab-content.active { display: block; }

        /* Initial App Loading / Error Message */
        #appLoadingMessage { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255,255,255,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; text-align: center; }
        .dark #appLoadingMessage { background-color: rgba(26, 32, 44, 0.9); } /* gray-900 with opacity */
    </style>
</head>
<body class="bg-gray-100 text-gray-900 dark:bg-gray-900 dark:text-gray-100">

    <div id="appLoadingMessage">
        <img src="/logo.png" alt="Loading LoLLMs" class="h-20 mx-auto mb-4">
        <p class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-2" data-i18n="appLoading">Loading Application...</p>
        <p id="appLoadingStatus" class="text-gray-600 dark:text-gray-400" data-i18n="appLoadingPleaseWait">Please wait.</p>
    </div>

    <div id="app-container" class="flex h-screen overflow-hidden" style="display: none;">

        <!-- Sidebar -->
        <aside class="w-72 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex flex-col">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700">
                 <img src="/logo.png" alt="Logo" class="h-10 mx-auto mb-2">
                 <h2 class="text-xl font-semibold text-center text-gray-700 dark:text-gray-200" data-i18n="sidebarTitle">Lollms Chat</h2>
            </div>
            <div class="p-3 border-b border-gray-200 dark:border-gray-700">
                <button id="newDiscussionBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md shadow-sm transition duration-150 ease-in-out flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                    <span data-i18n="newDiscussionButton">New Discussion</span>
                </button>
            </div>
            <div id="discussionListContainer" class="flex-1 overflow-y-auto p-2 space-y-1">
                <p class="text-gray-500 dark:text-gray-400 text-sm text-center italic p-4" data-i18n="loadingDiscussions">Loading discussions...</p>
            </div>
            <div class="p-3 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-850 space-y-3">
                <div id="userInfo" class="text-sm text-center text-gray-700 dark:text-gray-300">
                    <span data-i18n="loggedInAs">Logged in as:</span> <span id="usernameDisplay" class="font-semibold">...</span>
                    <span id="adminBadge" class="ml-1 text-xs bg-red-100 text-red-800 px-1.5 py-0.5 rounded-full font-medium" style="display: none;" data-i18n="adminBadge">Admin</span>
                </div>
                 <div class="space-y-2">
                     <button id="settingsBtn" class="sidebar-btn">
                         <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 0 1 0 1.255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.063-.374-.313-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 0 1 0-1.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg>
                         <span data-i18n="settingsButton">Settings</span>
                     </button>
                     <button id="promptsBtn" class="sidebar-btn"> <!-- New -->
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.34 15.84c-.688 0-1.25-.562-1.25-1.25s.562-1.25 1.25-1.25m0 2.5c.688 0 1.25-.562 1.25-1.25S11.028 13.34 10.34 13.34m0 2.5v-2.5m2.906.375c.414-.414.414-1.086 0-1.5-.414-.414-1.086-.414-1.5 0m1.5 1.5 .03-.03m-.03.03-.03-.03m2.907 2.907c.414.414 1.086.414 1.5 0 .414-.414.414-1.086 0-1.5m-1.5 1.5-.03.03m.03-.03.03-.03M5.657 7.05c.414-.414 1.086-.414 1.5 0s.414 1.086 0 1.5m-1.5-1.5.03-.03m-.03.03-.03-.03m12.728 0L18.384 8.468M5.657 16.95l1.414-1.414" /></svg>
                        <span data-i18n="promptsButton">Prompts</span>
                     </button>
                     <button id="dataStoresBtn" class="sidebar-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 6.375c0 2.278-3.694 4.125-8.25 4.125S3.75 8.653 3.75 6.375m16.5 0c0-2.278-3.694-4.125-8.25-4.125S3.75 4.097 3.75 6.375m16.5 0v11.25c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125V6.375m16.5 0v3.75m-16.5-3.75v3.75m16.5 0v3.75C20.25 16.153 16.556 18 12 18s-8.25-1.847-8.25-4.125v-3.75m16.5 0c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125" /></svg>
                        <span data-i18n="dataStoresButton">Data Stores</span>
                     </button>
                     <button id="friendsBtn" class="sidebar-btn"> <!-- New -->
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 0 0 3.741-.479 3 3 0 0 0-4.682-2.72m.94 3.198.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0 1 12 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 0 1 6 18.719m12 0a5.971 5.971 0 0 0-.94-3.197m0 0A5.995 5.995 0 0 0 12 12.75a5.995 5.995 0 0 0-5.06 2.772m0 0a3 3 0 0 0-4.681 2.72 8.986 8.986 0 0 0 3.74.477m.94-3.197a5.971 5.971 0 0 0-.94 3.197M15 6.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Zm6 3a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Zm-13.5 0a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Z" /></svg>
                        <span data-i18n="friendsButton">Friends</span>
                     </button>
                     <!-- filesBtn removed, functionality integrated into Data Stores modal -->
                     <a href="/admin" id="adminLink" class="sidebar-btn" style="display: none;">
                          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-9.75 0h9.75" /></svg>
                         <span data-i18n="adminPanelButton">Admin Panel</span>
                     </a>
                     <div class="flex space-x-2">
                         <button id="exportDataBtn" class="flex-1 text-xs bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 py-1 px-2 rounded border border-gray-300 dark:border-gray-600" data-i18n="exportDataButton">Export Data</button>
                         <button id="importDataBtn" class="flex-1 text-xs bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 py-1 px-2 rounded border border-gray-300 dark:border-gray-600" data-i18n="importDataButton">Import Data</button>
                     </div>
                     <button id="logoutBtn" class="sidebar-btn text-red-600 hover:bg-red-50 dark:hover:bg-red-900/50 border-red-200 dark:border-red-700/50 dark:text-red-400">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15m3 0 3-3m0 0-3-3m3 3H9" /></svg>
                        <span data-i18n="logoutButton">Logout</span>
                    </button>
                 </div>
            </div>
        </aside>

        <!-- Main Chat Area -->
        <main class="flex-1 flex flex-col bg-gray-50 dark:bg-gray-850">
            <header class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 p-3 flex items-center justify-between min-h-[65px] shadow-sm">
                <h3 id="discussionTitle" class="text-lg font-semibold text-gray-800 dark:text-gray-100 truncate px-2" data-i18n="selectOrCreateDiscussion">Select or Create a Discussion</h3>
                <div class="flex items-center space-x-2">
                    <button id="insertPromptBtn" class="p-1.5 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700" title="Insert Prompt">
                         <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-gray-500 dark:text-gray-400"><path stroke-linecap="round" stroke-linejoin="round" d="M10.34 15.84c-.688 0-1.25-.562-1.25-1.25s.562-1.25 1.25-1.25m0 2.5c.688 0 1.25-.562 1.25-1.25S11.028 13.34 10.34 13.34m0 2.5v-2.5m2.906.375c.414-.414.414-1.086 0-1.5-.414-.414-1.086-.414-1.5 0m1.5 1.5 .03-.03m-.03.03-.03-.03m2.907 2.907c.414.414 1.086.414 1.5 0 .414-.414.414-1.086 0-1.5m-1.5 1.5-.03.03m.03-.03.03-.03M5.657 7.05c.414-.414 1.086-.414 1.5 0s.414 1.086 0 1.5m-1.5-1.5.03-.03m-.03.03-.03-.03m12.728 0L18.384 8.468M5.657 16.95l1.414-1.414" /></svg>
                    </button>
                    <div class="rag-controls">
                        <button id="ragToggleBtn" class="rag-toggle rag-toggle-off self-center" title="Toggle RAG" data-i18n-title="toggleRagTitle">RAG</button>
                        <select id="ragDataStoreSelect" class="text-xs rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 bg-white dark:bg-gray-700 dark:text-gray-200" style="display: none;">
                            <option value="" data-i18n="selectRagDataStore">Select RAG Data Store</option>
                        </select>
                    </div>
                </div>
            </header>

            <div id="chatMessages" class="flex-1 overflow-y-auto p-4 flex flex-col space-y-2">
                <div class="text-center text-gray-500 dark:text-gray-400 italic mt-10" data-i18n="selectDiscussionToChat">Select a discussion to start chatting.</div>
            </div>

            <footer class="bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 p-3 shadow-inner">
                 <div id="imageUploadPreviewContainer" class="mb-2" style="display: none;"></div>
                <div class="flex items-end space-x-3">
                    <label for="imageUploadInput" class="p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer self-end">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-gray-500 dark:text-gray-400"><path stroke-linecap="round" stroke-linejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm10.5-11.25h.008v.008h-.008V8.25Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" /></svg>
                    </label>
                    <input type="file" id="imageUploadInput" multiple accept="image/*" class="hidden">
                    <textarea id="messageInput" rows="1" class="flex-1 rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-200 focus:ring-opacity-50 p-2 text-sm bg-white dark:bg-gray-700 dark:text-gray-100" placeholder="Type your message... (Shift+Enter for new line)" data-i18n-placeholder="typeYourMessage" style="resize: none; overflow-y: hidden;"></textarea>
                    <button id="sendMessageBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-md shadow-sm transition duration-150 ease-in-out self-end disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5" /></svg>
                    </button>
                </div>
                <div id="statusMessage" class="text-xs text-red-600 dark:text-red-400 mt-1 h-4"></div>
                <div id="pyodideStatus" class="text-xs text-blue-600 dark:text-blue-400 mt-1 h-4"></div>
            </footer>
        </main>
    </div>

    <!-- Modals Container -->
    <div>
        <!-- Login Modal -->
        <div id="loginModal" class="modal">
            <div class="modal-content">
                <div class="modal-header"><h3 class="modal-title" data-i18n="loginTitle">Login Required</h3></div>
                <div class="modal-body space-y-4">
                    <img src="/logo.png" alt="Logo" class="h-16 mx-auto mb-4">
                    <div>
                        <label for="loginUsername" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" data-i18n="usernameLabel">Username</label>
                        <input type="text" id="loginUsername" class="w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm bg-white dark:bg-gray-700 dark:text-gray-100" placeholder="Enter your username" data-i18n-placeholder="usernamePlaceholder">
                    </div>
                    <div>
                        <label for="loginPassword" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" data-i18n="passwordLabel">Password</label>
                        <input type="password" id="loginPassword" class="w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm bg-white dark:bg-gray-700 dark:text-gray-100" placeholder="Enter your password" data-i18n-placeholder="passwordPlaceholder">
                    </div>
                    <div id="loginStatus" class="text-xs text-red-600 dark:text-red-400 mt-1 h-4"></div>
                </div>
                <div class="modal-footer">
                    <button id="loginSubmitBtn" class="w-full px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" data-i18n="loginButton">Login</button>
                </div>
            </div>
        </div>

        <!-- Rename Discussion Modal -->
        <div id="renameModal" class="modal">
            <div class="modal-content">
                <button class="modal-close-btn" onclick="closeModal('renameModal')">×</button>
                <div class="modal-header"><h3 class="modal-title" data-i18n="renameDiscussionTitle">Rename Discussion</h3></div>
                <div class="modal-body">
                    <label for="renameInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" data-i18n="newDiscussionTitleLabel">New discussion title:</label>
                    <input type="text" id="renameInput" class="w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm bg-white dark:bg-gray-700 dark:text-gray-100" data-i18n-placeholder="enterNewTitlePlaceholder">
                    <div id="renameStatus" class="text-xs text-red-600 dark:text-red-400 mt-1 h-4"></div>
                    <input type="hidden" id="renameDiscussionIdInput">
                </div>
                <div class="modal-footer">
                    <button onclick="closeModal('renameModal')" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 text-sm font-medium rounded-md hover:bg-gray-300 dark:hover:bg-gray-500" data-i18n="cancelButton">Cancel</button>
                    <button id="confirmRenameBtn" class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700" data-i18n="renameButton">Rename</button>
                </div>
            </div>
        </div>
        
        <!-- Send Discussion Modal -->
        <div id="sendDiscussionModal" class="modal">
            <div class="modal-content">
                <button class="modal-close-btn" onclick="closeModal('sendDiscussionModal')">×</button>
                <div class="modal-header"><h3 class="modal-title" data-i18n="sendDiscussionTitle">Send Discussion</h3></div>
                <div class="modal-body">
                    <label for="sendTargetFriendSelect" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" data-i18n="sendToFriendLabel">Send to Friend:</label>
                    <select id="sendTargetFriendSelect" class="w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm bg-white dark:bg-gray-700 dark:text-gray-100">
                        <option value="" data-i18n="selectFriendPlaceholder">-- Select a Friend --</option>
                    </select>
                    <div id="sendDiscussionStatus" class="text-xs text-red-600 dark:text-red-400 mt-1 h-4"></div>
                    <input type="hidden" id="sendDiscussionIdInput">
                </div>
                <div class="modal-footer">
                    <button onclick="closeModal('sendDiscussionModal')" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 text-sm font-medium rounded-md hover:bg-gray-300 dark:hover:bg-gray-500" data-i18n="cancelButton">Cancel</button>
                    <button id="confirmSendDiscussionBtn" class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700" data-i18n="sendButton">Send</button>
                </div>
            </div>
        </div>

        <!-- Edit Message Modal -->
        <div id="editMessageModal" class="modal">
            <div class="modal-content">
                <button class="modal-close-btn" onclick="closeModal('editMessageModal')">×</button>
                <div class="modal-header"><h3 class="modal-title" data-i18n="editMessageTitle">Edit Message</h3></div>
                <div class="modal-body">
                    <label for="editMessageInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" data-i18n="messageContentLabel">Message content:</label>
                    <textarea id="editMessageInput" rows="5" class="w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm bg-white dark:bg-gray-700 dark:text-gray-100"></textarea>
                    <div id="editMessageStatus" class="text-xs text-red-600 dark:text-red-400 mt-1 h-4"></div>
                    <input type="hidden" id="editMessageIdInput">
                </div>
                <div class="modal-footer">
                    <button onclick="closeModal('editMessageModal')" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 text-sm font-medium rounded-md hover:bg-gray-300 dark:hover:bg-gray-500" data-i18n="cancelButton">Cancel</button>
                    <button id="confirmEditMessageBtn" class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700" data-i18n="saveChangesButton">Save Changes</button>
                </div>
            </div>
        </div>

        <!-- Export Modal -->
        <div id="exportModal" class="modal">
             <div class="modal-content">
                 <button class="modal-close-btn" onclick="closeModal('exportModal')">×</button>
                 <div class="modal-header"><h3 class="modal-title" data-i18n="exportDataTitle">Export Data</h3></div>
                 <div class="modal-body">
                     <p class="text-sm text-gray-600 dark:text-gray-300 mb-3" data-i18n="exportSelectDiscussions">Select discussions to export (leave all unchecked to export all):</p>
                     <div id="exportDiscussionList" class="max-h-60 overflow-y-auto border border-gray-200 dark:border-gray-600 rounded p-3 space-y-2 bg-gray-50 dark:bg-gray-700">
                         <p class="text-gray-500 dark:text-gray-400 italic" data-i18n="loadingDiscussions">Loading discussions...</p>
                     </div>
                 </div>
                 <div class="modal-footer">
                     <button onclick="closeModal('exportModal')" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 text-sm font-medium rounded-md hover:bg-gray-300 dark:hover:bg-gray-500" data-i18n="cancelButton">Cancel</button>
                     <button id="confirmExportBtn" class="px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-md hover:bg-green-700" data-i18n="exportSelectedButton">Export Selected</button>
                 </div>
            </div>
        </div>

        <!-- Import Modal -->
         <div id="importModal" class="modal">
            <div class="modal-content">
                <button class="modal-close-btn" onclick="closeModal('importModal')">×</button>
                <div class="modal-header"><h3 class="modal-title" data-i18n="importDiscussionsTitle">Import Discussions</h3></div>
                <div class="modal-body">
                    <div class="mb-4">
                        <label for="importFile" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" data-i18n="selectExportedJsonFile">Select Exported JSON File (.json):</label>
                        <input type="file" id="importFile" accept=".json" class="block w-full text-sm text-gray-500 dark:text-gray-300 file:mr-4 file:py-1.5 file:px-3 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 dark:file:bg-blue-700 file:text-blue-700 dark:file:text-blue-100 hover:file:bg-blue-100 dark:hover:file:bg-blue-600 border border-gray-300 dark:border-gray-600 rounded-md cursor-pointer"/>
                    </div>
                    <div id="importPreviewArea" class="mb-4" style="display: none;">
                        <p class="text-sm text-gray-600 dark:text-gray-300 mb-2" data-i18n="importSelectDiscussionsFromFile">Select discussions to import from the file:</p>
                         <div id="importDiscussionList" class="max-h-60 overflow-y-auto border border-gray-200 dark:border-gray-600 rounded p-3 space-y-2 bg-gray-50 dark:bg-gray-700"></div>
                    </div>
                    <p id="importStatus" class="text-sm text-red-600 dark:text-red-400 h-4"></p>
                </div>
                <div class="modal-footer">
                    <button onclick="closeModal('importModal')" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 text-sm font-medium rounded-md hover:bg-gray-300 dark:hover:bg-gray-500" data-i18n="cancelButton">Cancel</button>
                    <button id="confirmImportBtn" class="px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-md hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled data-i18n="importSelectedButton">Import Selected</button>
                </div>
            </div>
        </div>

        <!-- Settings Modal (New Tabbed Layout) -->
        <div id="settingsModal" class="modal">
            <div class="modal-content"> <!-- Flex row applied here for tabs -->
                <div class="settings-tabs">
                    <h3 class="modal-title mb-4" data-i18n="userSettingsTitle">User Settings</h3>
                    <button class="settings-tab-btn active" data-tab="userProfileTab" data-i18n="settingsTabUserProfile">User Profile</button>
                    <button class="settings-tab-btn" data-tab="llmSettingsTab" data-i18n="settingsTabLLM">LLM</button>
                    <button class="settings-tab-btn" data-tab="ragSettingsTab" data-i18n="settingsTabRAG">RAG</button>
                    <button class="settings-tab-btn" data-tab="appearanceSettingsTab" data-i18n="settingsTabAppearance">Appearance</button>
                </div>
                <div class="settings-content-pane">
                    <button class="modal-close-btn" onclick="closeModal('settingsModal')">×</button>
                    <!-- User Profile Tab Content -->
                    <div id="userProfileTab" class="settings-tab-content active space-y-5 divide-y divide-gray-200 dark:divide-gray-700">
                        <div class="pt-3">
                            <h4 class="text-md font-medium text-gray-800 dark:text-gray-100 mb-2" data-i18n="changePasswordTitle">Change Password</h4>
                            <div>
                                <label for="currentPassword" class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-i18n="currentPasswordLabel">Current Password</label>
                                <input type="password" id="currentPassword" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm bg-white dark:bg-gray-700 dark:text-gray-100">
                            </div>
                            <div>
                                <label for="newPassword" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mt-2" data-i18n="newPasswordLabel">New Password</label>
                                <input type="password" id="newPassword" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm bg-white dark:bg-gray-700 dark:text-gray-100">
                            </div>
                            <div>
                                <label for="confirmNewPassword" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mt-2" data-i18n="confirmNewPasswordLabel">Confirm New Password</label>
                                <input type="password" id="confirmNewPassword" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm bg-white dark:bg-gray-700 dark:text-gray-100">
                            </div>
                            <div class="text-right mt-3">
                                 <button id="savePasswordBtn" class="px-3 py-1.5 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 disabled:opacity-50" data-i18n="savePasswordButton">Save Password</button>
                            </div>
                        </div>
                    </div>
                    <!-- LLM Settings Tab Content -->
                    <div id="llmSettingsTab" class="settings-tab-content space-y-5 divide-y divide-gray-200 dark:divide-gray-700">
                        <div class="pt-3">
                            <h4 class="text-md font-medium text-gray-800 dark:text-gray-100 mb-2" data-i18n="llmConfigurationTitle">LLM Configuration</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label for="settingsLollmsModelSelect" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" data-i18n="defaultLLMModelLabel">Default LLM Model</label>
                                    <select id="settingsLollmsModelSelect" class="block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm bg-white dark:bg-gray-700 dark:text-gray-100">
                                        <option data-i18n="loadingModels">Loading models...</option>
                                    </select>
                                </div>
                                <!-- Vectorizer is now in RAG settings -->
                            </div>
                            <div class="text-right mt-3">
                                 <button id="saveModelSettingsBtn" class="px-3 py-1.5 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 disabled:opacity-50" data-i18n="saveModelButton">Save Model</button>
                            </div>
                        </div>
                        <div class="pt-4">
                            <h4 class="text-md font-medium text-gray-800 dark:text-gray-100 mb-2" data-i18n="llmGenerationParametersTitle">LLM Generation Parameters</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <div>
                                    <label for="settingsTemperature" class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-i18n="temperatureLabel">Temperature</label>
                                    <input type="number" id="settingsTemperature" step="0.01" min="0" max="2" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm bg-white dark:bg-gray-700 dark:text-gray-100" placeholder="e.g., 0.7">
                                </div>
                                <div>
                                    <label for="settingsTopK" class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-i18n="topKLabel">Top K</label>
                                    <input type="number" id="settingsTopK" step="1" min="1" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm bg-white dark:bg-gray-700 dark:text-gray-100" placeholder="e.g., 50">
                                </div>
                                <div>
                                    <label for="settingsTopP" class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-i18n="topPLabel">Top P</label>
                                    <input type="number" id="settingsTopP" step="0.01" min="0" max="1" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm bg-white dark:bg-gray-700 dark:text-gray-100" placeholder="e.g., 0.95">
                                </div>
                                <div>
                                    <label for="settingsRepeatPenalty" class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-i18n="repeatPenaltyLabel">Repeat Penalty</label>
                                    <input type="number" id="settingsRepeatPenalty" step="0.01" min="0" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm bg-white dark:bg-gray-700 dark:text-gray-100" placeholder="e.g., 1.1">
                                </div>
                                <div>
                                    <label for="settingsRepeatLastN" class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-i18n="repeatLastNLabel">Repeat Last N</label>
                                    <input type="number" id="settingsRepeatLastN" step="1" min="0" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm bg-white dark:bg-gray-700 dark:text-gray-100" placeholder="e.g., 64">
                                </div>
                            </div>
                            <div class="text-right mt-3">
                                <button id="saveLLMParamsBtn" class="px-3 py-1.5 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 disabled:opacity-50" data-i18n="saveLLMParamsButton">Save LLM Parameters</button>
                            </div>
                        </div>
                    </div>
                     <!-- RAG Settings Tab Content -->
                    <div id="ragSettingsTab" class="settings-tab-content space-y-5 divide-y divide-gray-200 dark:divide-gray-700">
                        <div class="pt-3">
                            <h4 class="text-md font-medium text-gray-800 dark:text-gray-100 mb-2" data-i18n="ragConfigurationTitle">RAG Configuration</h4>
                             <div>
                                <label for="settingsVectorizerSelect" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" data-i18n="defaultRagVectorizerLabel">Default RAG Vectorizer</label>
                                <select id="settingsVectorizerSelect" class="block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm bg-white dark:bg-gray-700 dark:text-gray-100">
                                     <option data-i18n="loadingVectorizers">Loading vectorizers...</option>
                                </select>
                            </div>
                            <div class="mt-4">
                                <label for="settingsRagTopK" class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-i18n="ragTopKLabel">RAG Top-K Chunks</label>
                                <input type="number" id="settingsRagTopK" step="1" min="1" max="20" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm bg-white dark:bg-gray-700 dark:text-gray-100" placeholder="e.g., 3">
                            </div>
                            <div class="text-right mt-3">
                                 <button id="saveRagSettingsBtn" class="px-3 py-1.5 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 disabled:opacity-50" data-i18n="saveRagSettingsButton">Save RAG Settings</button>
                            </div>
                        </div>
                    </div>
                    <!-- Appearance Tab Content -->
                    <div id="appearanceSettingsTab" class="settings-tab-content space-y-5 divide-y divide-gray-200 dark:divide-gray-700">
                        <div class="pt-3">
                            <h4 class="text-md font-medium text-gray-800 dark:text-gray-100 mb-2" data-i18n="languageSettingsTitle">Language</h4>
                            <div>
                                <label for="languageSelect" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" data-i18n="selectLanguageLabel">Select Language</label>
                                <select id="languageSelect" class="block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm bg-white dark:bg-gray-700 dark:text-gray-100">
                                    <option value="en">English</option>
                                    <option value="fr">Français</option>
                                    <!-- Add more languages here -->
                                </select>
                            </div>
                        </div>
                        <div class="pt-4">
                            <h4 class="text-md font-medium text-gray-800 dark:text-gray-100 mb-2" data-i18n="themeSettingsTitle">Theme</h4>
                            <div class="flex items-center space-x-4">
                                <button id="themeLightBtn" class="px-3 py-1.5 border rounded-md text-sm" data-i18n="themeLight">Light</button>
                                <button id="themeDarkBtn" class="px-3 py-1.5 border rounded-md text-sm" data-i18n="themeDark">Dark</button>
                                <button id="themeSystemBtn" class="px-3 py-1.5 border rounded-md text-sm" data-i18n="themeSystem">System</button>
                            </div>
                        </div>
                         <div class="text-right mt-3">
                            <button id="saveAppearanceSettingsBtn" class="px-3 py-1.5 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 disabled:opacity-50" data-i18n="saveAppearanceButton">Save Appearance</button>
                        </div>
                    </div>
                    <div id="settingsStatus" class="text-sm h-4 pt-3"></div>
                </div> <!-- End content-pane -->
                 <div class="modal-footer" style="width: calc(100% - 180px); position:absolute; bottom:0; right:0; background-color: white; dark:background-color: #2d3748; padding: 1rem 2rem;"> <!-- Footer outside content-pane for consistent position -->
                    <button onclick="closeModal('settingsModal')" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 text-sm font-medium rounded-md hover:bg-gray-300 dark:hover:bg-gray-500" data-i18n="closeButton">Close</button>
                </div>
            </div>
        </div>

        <!-- Data Stores Management Modal (Updated with Tabs) -->
        <div id="dataStoresModal" class="modal">
            <div class="modal-content">
                <button class="modal-close-btn" onclick="closeModal('dataStoresModal')">×</button>
                <div class="modal-header"><h3 class="modal-title" data-i18n="manageDataStoresTitle">Manage Data Stores (RAG)</h3></div>
                <div class="modal-tabs">
                    <button class="modal-tab-btn active" data-tab="myStoresTab" data-i18n="myDataStoresTab">My Data Stores</button>
                    <button class="modal-tab-btn" data-tab="sharedStoresTab" data-i18n="sharedWithMeTab">Shared With Me</button>
                    <button class="modal-tab-btn" data-tab="storeStoreTab" data-i18n="dataStoreStoreTab">Data Store Store</button>
                </div>
                <div class="modal-body">
                    <div id="myStoresTab" class="modal-tab-content active">
                        <button id="openCreateDataStoreModalBtn" class="mb-3 px-3 py-1.5 bg-green-600 text-white text-sm font-medium rounded-md hover:bg-green-700" data-i18n="createNewDataStoreButton">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 mr-1 inline-block"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                            Create New Data Store
                        </button>
                        <section>
                            <h4 class="text-md font-medium text-gray-800 dark:text-gray-100 mb-2" data-i18n="yourDataStoresTitle">Your Data Stores</h4>
                            <div id="ownedDataStoresList" class="max-h-72 overflow-y-auto space-y-2 bg-gray-50 dark:bg-gray-700 border border-gray-100 dark:border-gray-600 rounded p-3">
                                <p class="text-gray-500 dark:text-gray-400 italic" data-i18n="loadingYourStores">Loading your stores...</p>
                            </div>
                        </section>
                    </div>
                    <div id="sharedStoresTab" class="modal-tab-content">
                        <section>
                            <h4 class="text-md font-medium text-gray-800 dark:text-gray-100 mb-2" data-i18n="storesSharedWithYouTitle">Data Stores Shared With You / Added from Store</h4>
                            <div id="sharedDataStoresList" class="max-h-72 overflow-y-auto space-y-2 bg-gray-50 dark:bg-gray-700 border border-gray-100 dark:border-gray-600 rounded p-3">
                               <p class="text-gray-500 dark:text-gray-400 italic" data-i18n="loadingSharedStores">Loading shared stores...</p>
                            </div>
                        </section>
                    </div>
                    <div id="storeStoreTab" class="modal-tab-content">
                        <section>
                            <h4 class="text-md font-medium text-gray-800 dark:text-gray-100 mb-2" data-i18n="publicDataStoreStoreTitle">Public Data Store Store</h4>
                            <div id="publicDataStoresList" class="max-h-72 overflow-y-auto space-y-2 bg-gray-50 dark:bg-gray-700 border border-gray-100 dark:border-gray-600 rounded p-3">
                               <p class="text-gray-500 dark:text-gray-400 italic" data-i18n="loadingPublicStores">Loading public stores...</p>
                            </div>
                        </section>
                    </div>
                </div>
                <div class="modal-footer">
                    <button onclick="closeModal('dataStoresModal')" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 text-sm font-medium rounded-md hover:bg-gray-300 dark:hover:bg-gray-500" data-i18n="closeButton">Close</button>
                </div>
            </div>
        </div>

        <!-- Create Data Store Modal (Simplified) -->
        <div id="createDataStoreModal" class="modal">
            <div class="modal-content" style="width: 500px;">
                 <button class="modal-close-btn" onclick="closeModal('createDataStoreModal')">×</button>
                <div class="modal-header"><h3 class="modal-title" data-i18n="createNewDataStoreTitle">Create New Data Store</h3></div>
                <div class="modal-body space-y-4">
                    <form id="createDataStoreForm" class="space-y-3">
                        <div>
                            <label for="newDataStoreName" class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-i18n="dataStoreNameLabel">Name</label>
                            <input type="text" id="newDataStoreName" required minlength="3" maxlength="100" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm bg-white dark:bg-gray-700 dark:text-gray-100">
                        </div>
                        <div>
                            <label for="newDataStoreDescription" class="block text-sm font-medium text-gray-700 dark:text-gray-300" data-i18n="dataStoreDescriptionLabel">Description (Optional)</label>
                            <textarea id="newDataStoreDescription" rows="2" maxlength="500" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm bg-white dark:bg-gray-700 dark:text-gray-100"></textarea>
                        </div>
                        <div class="flex items-center">
                             <input type="checkbox" id="newDataStoreIsPublic" class="h-4 w-4 rounded border-gray-300 dark:border-gray-600 text-blue-600 focus:ring-blue-500 bg-white dark:bg-gray-700">
                             <label for="newDataStoreIsPublic" class="ml-2 block text-sm text-gray-900 dark:text-gray-100" data-i18n="makePublicInDataStoreStoreLabel">Make Public in Data Store Store</label>
                         </div>
                        <input type="hidden" id="editDataStoreId"> <!-- Used for editing -->
                    </form>
                    <div id="createDataStoreStatus" class="text-sm h-4 mt-2"></div>
                </div>
                <div class="modal-footer">
                    <button onclick="closeModal('createDataStoreModal')" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 text-sm font-medium rounded-md hover:bg-gray-300 dark:hover:bg-gray-500" data-i18n="cancelButton">Cancel</button>
                    <button id="confirmCreateOrUpdateDataStoreBtn" class="px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-md hover:bg-green-700" data-i18n="createStoreButton">Create Store</button>
                </div>
            </div>
        </div>
        
        <!-- Manage Data Store Sharing Modal -->
        <div id="manageDataStoreSharingModal" class="modal">
            <div class="modal-content" style="width: 550px;">
                <button class="modal-close-btn" onclick="closeModal('manageDataStoreSharingModal')">×</button>
                <div class="modal-header"><h3 id="manageDataStoreSharingTitle" class="modal-title" data-i18n="manageSharingTitle">Manage Sharing for Data Store</h3></div>
                <input type="hidden" id="manageSharingDataStoreIdInput">
                <div class="modal-body space-y-4">
                    <section>
                        <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300" data-i18n="currentlySharedWithTitle">Currently Shared With (Friends):</h4>
                        <div id="dsSharedWithList" class="max-h-40 overflow-y-auto mt-1 space-y-1 text-xs">
                            <p class="italic text-gray-500 dark:text-gray-400" data-i18n="notSharedWithAnyFriends">Not shared with any friends directly.</p>
                        </div>
                    </section>
                    <hr class="dark:border-gray-600">
                    <section>
                        <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300" data-i18n="shareWithFriendTitle">Share with another Friend:</h4>
                        <label for="shareDsWithFriendSelect" class="block text-xs font-medium text-gray-700 dark:text-gray-300 mt-1" data-i18n="selectFriendToShareWithLabel">Select Friend:</label>
                        <select id="shareDsWithFriendSelect" class="mt-1 w-full border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm bg-white dark:bg-gray-700 dark:text-gray-100">
                             <option value="" data-i18n="selectFriendPlaceholder">-- Select a Friend --</option>
                        </select>
                        <button id="confirmShareDsWithFriendBtn" class="mt-2 px-3 py-1 bg-blue-600 text-white text-xs font-medium rounded-md hover:bg-blue-700" data-i18n="shareWithSelectedFriendButton">Share</button>
                    </section>
                    <div id="manageDataStoreSharingStatus" class="text-xs text-red-600 dark:text-red-400 h-4"></div>
                </div>
                <div class="modal-footer">
                    <button onclick="closeModal('manageDataStoreSharingModal')" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 text-sm font-medium rounded-md hover:bg-gray-300 dark:hover:bg-gray-500" data-i18n="doneButton">Done</button>
                </div>
            </div>
        </div>

        <!-- File Management Modal (for a selected DataStore) - largely unchanged in structure -->
        <div id="fileManagementModal" class="modal">
            <div class="modal-content">
                <button class="modal-close-btn" onclick="closeModal('fileManagementModal')">×</button>
                <div class="modal-header"><h3 class="modal-title" data-i18n="manageFilesInDataStoreTitle">Manage Files in Data Store: <span id="fileManagerDataStoreName" class="font-normal"></span></h3></div>
                <div class="modal-body space-y-5">
                    <input type="hidden" id="fileManagerCurrentDataStoreId">
                    <div class="border border-gray-200 dark:border-gray-600 rounded-md p-4">
                         <h4 class="text-md font-medium text-gray-800 dark:text-gray-100 mb-3" data-i18n="uploadNewDocumentsTitle">Upload New Documents</h4>
                         <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                             <div>
                                 <label for="fileVectorizerSelect" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" data-i18n="vectorizerForUploadLabel">Vectorizer for Upload</label>
                                 <select id="fileVectorizerSelect" class="block w-full rounded-md border-gray-300 dark:border-gray-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm bg-white dark:bg-gray-700 dark:text-gray-100">
                                     <option value="" data-i18n="selectVectorizerPlaceholderFile">Select Vectorizer</option>
                                 </select>
                             </div>
                             <div>
                                <label for="fileUploadInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" data-i18n="selectFilesLabel">Select Files</label>
                                <input type="file" id="fileUploadInput" multiple class="block w-full text-sm text-gray-500 dark:text-gray-300 file:mr-4 file:py-1.5 file:px-3 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 dark:file:bg-blue-700 file:text-blue-700 dark:file:text-blue-100 hover:file:bg-blue-100 dark:hover:file:bg-blue-600 border border-gray-300 dark:border-gray-600 rounded-md cursor-pointer"/>
                            </div>
                         </div>
                         <div class="text-right mt-3">
                            <button id="confirmUploadBtn" class="px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-md hover:bg-green-700 disabled:opacity-50" disabled>
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 inline-block mr-1 align-text-bottom"><path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0 3 3m-3-3-3 3M6.75 19.5a4.5 4.5 0 0 1-1.41-8.775 5.25 5.25 0 0 1 10.233-2.33 3 3 0 0 1 3.758 3.848A3.752 3.752 0 0 1 18 19.5H6.75Z" /></svg>
                                <span data-i18n="uploadFilesButton">Upload Files</span>
                            </button>
                         </div>
                         <div id="uploadStatus" class="text-sm h-4 mt-2"></div>
                    </div>
                     <div class="border border-gray-200 dark:border-gray-600 rounded-md p-4">
                         <h4 class="text-md font-medium text-gray-800 dark:text-gray-100 mb-3" data-i18n="indexedDocumentsTitle">Indexed Documents in this Store</h4>
                         <div id="indexedFileList" class="max-h-60 overflow-y-auto space-y-2 bg-gray-50 dark:bg-gray-700 border border-gray-100 dark:border-gray-600 rounded p-3">
                            <p class="text-gray-500 dark:text-gray-400 italic" data-i18n="loadingFiles">Loading files...</p>
                         </div>
                          <div id="fileListStatus" class="text-sm h-4 mt-2"></div>
                    </div>
                </div>
                 <div class="modal-footer">
                    <button onclick="closeModal('fileManagementModal')" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 text-sm font-medium rounded-md hover:bg-gray-300 dark:hover:bg-gray-500" data-i18n="closeButton">Close</button>
                </div>
            </div>
        </div>
        
        <!-- Image Viewer Modal (Unchanged) -->
        <div id="imageViewerModal" class="modal">
            <div class="modal-content p-2 relative dark:bg-gray-900" style="max-width: 90vw; max-height: 90vh; width: auto; height: auto;">
                 <button class="modal-close-btn text-2xl font-bold text-white bg-black bg-opacity-50 rounded-full p-1 leading-none" style="top:10px; right:10px; width:30px; height:30px;" onclick="closeModal('imageViewerModal')">×</button>
                <img id="imageViewerSrc" src="" alt="Enlarged Image" class="max-w-full max-h-full object-contain">
            </div>
        </div>

        <!-- Prompts Modal (New) -->
        <div id="promptsModal" class="modal">
            <div class="modal-content">
                <button class="modal-close-btn" onclick="closeModal('promptsModal')">×</button>
                <div class="modal-header"><h3 class="modal-title" data-i18n="managePromptsTitle">Manage Prompts</h3></div>
                <div class="modal-tabs">
                    <button class="modal-tab-btn active" data-tab="myPromptsTab" data-i18n="myPromptsTab">My Prompts</button>
                    <button class="modal-tab-btn" data-tab="promptStoreTab" data-i18n="promptStoreTab">Prompt Store</button>
                </div>
                <div class="modal-body">
                    <div id="myPromptsTab" class="modal-tab-content active">
                        <button id="openCreatePromptModalBtn" class="mb-3 px-3 py-1.5 bg-green-600 text-white text-sm font-medium rounded-md hover:bg-green-700" data-i18n="createNewPromptButton">
                           <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 mr-1 inline-block"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg> Create New Prompt
                        </button>
                        <div id="myPromptsList" class="max-h-80 overflow-y-auto space-y-2">
                            <p class="italic text-gray-500 dark:text-gray-400" data-i18n="loadingYourPrompts">Loading your prompts...</p>
                        </div>
                    </div>
                    <div id="promptStoreTab" class="modal-tab-content">
                        <div id="publicPromptsList" class="max-h-96 overflow-y-auto space-y-2">
                             <p class="italic text-gray-500 dark:text-gray-400" data-i18n="loadingPublicPrompts">Loading public prompts...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button onclick="closeModal('promptsModal')" class="px-4 py-2 bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200 text-sm font-medium rounded-md hover:bg-gray-300 dark:hover:bg-gray-500" data-i18n="closeButton">Close</button>
                </div>
            </div>
        </div>

        <!-- Create/Edit Prompt Modal (Sub-modal for Prompts) -->
        <div id="createEditPromptModal" class="modal">
            <div class="modal-content" style="width: 600px;">
                <button class="modal-close-btn" onclick="closeModal('createEditPromptModal')">×</button>
                <div class="modal-header"><h3 id="createEditPromptTitle" class="modal-title" data-i18n="createPromptTitle">Create New Prompt</h3></div>
                <form id="createEditPromptForm" class="modal-body space-y-3">
                    <input type="hidden" id="editPromptIdInput">
                    <div>
                        <label for="promptName" class="block text-sm font-medium" data-i18n="promptNameLabel">Name</label>
                        <input type="text" id="promptName" required class="mt-1 block w-full input-style">
                    </div>
                    <div>
                        <label for="promptCategory" class="block text-sm font-medium" data-i18n="promptCategoryLabel">Category</label>
                        <input type="text" id="promptCategory" list="promptCategoriesList" class="mt-1 block w-full input-style" placeholder="e.g., Coding, Writing">
                        <datalist id="promptCategoriesList"></datalist>
                    </div>
                    <div>
                        <label for="promptDescription" class="block text-sm font-medium" data-i18n="promptDescriptionLabel">Description (Optional)</label>
                        <textarea id="promptDescription" rows="2" class="mt-1 block w-full input-style"></textarea>
                    </div>
                    <div>
                        <label for="promptContent" class="block text-sm font-medium" data-i18n="promptContentLabel">Content</label>
                        <textarea id="promptContent" rows="5" required class="mt-1 block w-full input-style"></textarea>
                    </div>
                     <div class="flex items-center">
                         <input type="checkbox" id="promptIsPublic" class="h-4 w-4 rounded border-gray-300 dark:border-gray-600 text-blue-600 focus:ring-blue-500 bg-white dark:bg-gray-700">
                         <label for="promptIsPublic" class="ml-2 block text-sm text-gray-900 dark:text-gray-100" data-i18n="makePromptPublicLabel">Make Public in Prompt Store</label>
                     </div>
                    <div id="createEditPromptStatus" class="text-xs text-red-600 dark:text-red-400 h-4"></div>
                </form>
                <div class="modal-footer">
                    <button onclick="closeModal('createEditPromptModal')" class="px-4 py-2 btn-secondary" data-i18n="cancelButton">Cancel</button>
                    <button id="confirmSavePromptBtn" class="px-4 py-2 btn-primary" data-i18n="savePromptButton">Save Prompt</button>
                </div>
            </div>
        </div>

        <!-- Friends Modal (New) -->
        <div id="friendsModal" class="modal">
            <div class="modal-content">
                <button class="modal-close-btn" onclick="closeModal('friendsModal')">×</button>
                <div class="modal-header"><h3 class="modal-title" data-i18n="manageFriendsTitle">Manage Friends</h3></div>
                <div class="modal-tabs">
                    <button class="modal-tab-btn active" data-tab="myFriendsListTab" data-i18n="myFriendsTab">My Friends</button>
                    <button class="modal-tab-btn" data-tab="incomingRequestsTab" data-i18n="incomingRequestsTab">Incoming Requests</button>
                    <button class="modal-tab-btn" data-tab="outgoingRequestsTab" data-i18n="outgoingRequestsTab">Outgoing Requests</button>
                    <button class="modal-tab-btn" data-tab="findUsersTab" data-i18n="findUsersTab">Find Users</button>
                </div>
                <div class="modal-body">
                    <div id="myFriendsListTab" class="modal-tab-content active">
                        <div id="myFriendsList" class="max-h-80 overflow-y-auto space-y-1">
                             <p class="italic text-gray-500 dark:text-gray-400" data-i18n="loadingFriends">Loading friends...</p>
                        </div>
                    </div>
                    <div id="incomingRequestsTab" class="modal-tab-content">
                        <div id="incomingFriendRequestsList" class="max-h-80 overflow-y-auto space-y-1">
                            <p class="italic text-gray-500 dark:text-gray-400" data-i18n="loadingIncomingRequests">Loading incoming requests...</p>
                        </div>
                    </div>
                    <div id="outgoingRequestsTab" class="modal-tab-content">
                        <div id="outgoingFriendRequestsList" class="max-h-80 overflow-y-auto space-y-1">
                             <p class="italic text-gray-500 dark:text-gray-400" data-i18n="loadingOutgoingRequests">Loading outgoing requests...</p>
                        </div>
                    </div>
                    <div id="findUsersTab" class="modal-tab-content">
                        <label for="findUserUsernameInput" class="block text-sm font-medium" data-i18n="usernameToFindLabel">Username to find/request:</label>
                        <input type="text" id="findUserUsernameInput" class="mt-1 block w-full input-style" placeholder="Enter username">
                        <button id="sendFriendRequestBtn" class="mt-2 px-3 py-1.5 btn-primary" data-i18n="sendFriendRequestButton">Send Friend Request</button>
                        <div id="findUsersStatus" class="text-xs text-red-600 dark:text-red-400 h-4 mt-1"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button onclick="closeModal('friendsModal')" class="px-4 py-2 btn-secondary" data-i18n="closeButton">Close</button>
                </div>
            </div>
        </div>

        <!-- Simple Prompt Selection Dropdown/Popover (Near message input) -->
        <div id="insertPromptDropdown" class="absolute bottom-16 left-12 z-20 w-64 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-lg p-2" style="display:none;">
            <input type="text" id="promptSearchInput" class="w-full text-sm p-1 mb-2 border-gray-300 dark:border-gray-500 rounded-md bg-white dark:bg-gray-600 dark:text-gray-100" placeholder="Search my prompts...">
            <div id="userPromptsForInsertionList" class="max-h-48 overflow-y-auto text-sm">
                <!-- Prompts will be listed here -->
            </div>
        </div>


    </div> <!-- End Modals Container -->

    <script>
        // --- Global State ---
        let currentUser = null; // Includes LLM params, theme, RAG top_k
        let currentDiscussionId = null;
        let discussions = {}; 
        let currentMessages = [];
        let aiMessageStreaming = false;
        let currentAiMessageElement = null;
        let currentAiMessageContent = "";
        let currentAiMessageId = null;
        let codeMirrorInstances = {};
        let pyodide = null;
        let pyodideLoading = false;
        let isRagActive = false;
        let availableLollmsModels = [];
        let availableVectorizers = [];
        let userDefaultVectorizer = null;
        let ownedDataStores = []; 
        let sharedDataStores = []; 
        let availableDataStoresForRag = [];
        let uploadedImageServerPaths = [];
        let tempLoginUsername = null;
        let tempLoginPassword = null;
        let currentLocale = 'en';
        let translations = {};
        let myPromptsCache = []; // Cache for user's prompts for insertion
        let friendsCache = []; // Cache for user's friends for selection

        // --- DOM Elements ---
        // (Many existing DOM elements + new ones for Prompts, Friends, Settings tabs, etc.)
        // App & Login
        const appLoadingMessage = document.getElementById('appLoadingMessage');
        const appLoadingStatus = document.getElementById('appLoadingStatus');
        const appContainer = document.getElementById('app-container');
        const loginModal = document.getElementById('loginModal'); /* ... login inputs ... */
        // Sidebar
        const discussionListContainer = document.getElementById('discussionListContainer');
        const newDiscussionBtn = document.getElementById('newDiscussionBtn');
        const usernameDisplay = document.getElementById('usernameDisplay');
        const adminBadge = document.getElementById('adminBadge'); const adminLink = document.getElementById('adminLink');
        const settingsBtn = document.getElementById('settingsBtn');
        const promptsBtn = document.getElementById('promptsBtn'); // New
        const dataStoresBtn = document.getElementById('dataStoresBtn');
        const friendsBtn = document.getElementById('friendsBtn'); // New
        const exportDataBtn = document.getElementById('exportDataBtn'); const importDataBtn = document.getElementById('importDataBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        // Chat Area
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const discussionTitle = document.getElementById('discussionTitle');
        const ragToggleBtn = document.getElementById('ragToggleBtn');
        const ragDataStoreSelect = document.getElementById('ragDataStoreSelect');
        const imageUploadInput = document.getElementById('imageUploadInput');
        const imageUploadPreviewContainer = document.getElementById('imageUploadPreviewContainer');
        const statusMessage = document.getElementById('statusMessage');
        const pyodideStatus = document.getElementById('pyodideStatus');
        const insertPromptBtn = document.getElementById('insertPromptBtn'); // New
        const insertPromptDropdown = document.getElementById('insertPromptDropdown'); // New
        const promptSearchInput = document.getElementById('promptSearchInput'); // New
        const userPromptsForInsertionList = document.getElementById('userPromptsForInsertionList'); // New
        // Settings Modal Elements
        const settingsModal = document.getElementById('settingsModal');
        const settingsTabs = settingsModal.querySelectorAll('.settings-tab-btn');
        const settingsContentPanes = settingsModal.querySelectorAll('.settings-tab-content');
        const currentPasswordInput = document.getElementById('currentPassword');
        const newPasswordInput = document.getElementById('newPassword');
        const confirmNewPasswordInput = document.getElementById('confirmNewPassword');
        const savePasswordBtn = document.getElementById('savePasswordBtn');
        const settingsLollmsModelSelect = document.getElementById('settingsLollmsModelSelect');
        const saveModelSettingsBtn = document.getElementById('saveModelSettingsBtn'); // Was saveModelAndVectorizerBtn
        const settingsTemperature = document.getElementById('settingsTemperature'); /* ... other LLM params ... */
        const settingsTopK = document.getElementById('settingsTopK');
        const settingsTopP = document.getElementById('settingsTopP');
        const settingsRepeatPenalty = document.getElementById('settingsRepeatPenalty');
        const settingsRepeatLastN = document.getElementById('settingsRepeatLastN');
        const saveLLMParamsBtn = document.getElementById('saveLLMParamsBtn');
        const settingsVectorizerSelect = document.getElementById('settingsVectorizerSelect');
        const settingsRagTopKInput = document.getElementById('settingsRagTopK'); // New
        const saveRagSettingsBtn = document.getElementById('saveRagSettingsBtn'); // New
        const languageSelect = document.getElementById('languageSelect');
        const themeLightBtn = document.getElementById('themeLightBtn');
        const themeDarkBtn = document.getElementById('themeDarkBtn');
        const themeSystemBtn = document.getElementById('themeSystemBtn');
        const saveAppearanceSettingsBtn = document.getElementById('saveAppearanceSettingsBtn'); // New
        const settingsStatus = document.getElementById('settingsStatus');
        // Data Stores Modals
        const dataStoresModal = document.getElementById('dataStoresModal');
        const dataStoresModalTabs = dataStoresModal.querySelectorAll('.modal-tab-btn');
        const dataStoresModalPanes = dataStoresModal.querySelectorAll('.modal-tab-content');
        const openCreateDataStoreModalBtn = document.getElementById('openCreateDataStoreModalBtn');
        const ownedDataStoresList = document.getElementById('ownedDataStoresList');
        const sharedDataStoresList = document.getElementById('sharedDataStoresList'); // For shared *with me*
        const publicDataStoresList = document.getElementById('publicDataStoresList'); // For the "store"
        const createDataStoreModal = document.getElementById('createDataStoreModal');
        const createDataStoreForm = document.getElementById('createDataStoreForm');
        const newDataStoreNameInput = document.getElementById('newDataStoreName');
        const newDataStoreDescriptionInput = document.getElementById('newDataStoreDescription');
        const newDataStoreIsPublicCheckbox = document.getElementById('newDataStoreIsPublic');
        const editDataStoreIdInput = document.getElementById('editDataStoreId');
        const createDataStoreStatus = document.getElementById('createDataStoreStatus');
        const confirmCreateOrUpdateDataStoreBtn = document.getElementById('confirmCreateOrUpdateDataStoreBtn');
        const manageDataStoreSharingModal = document.getElementById('manageDataStoreSharingModal');
        const manageDataStoreSharingTitle = document.getElementById('manageDataStoreSharingTitle');
        const manageSharingDataStoreIdInput = document.getElementById('manageSharingDataStoreIdInput');
        const dsSharedWithList = document.getElementById('dsSharedWithList');
        const shareDsWithFriendSelect = document.getElementById('shareDsWithFriendSelect');
        const confirmShareDsWithFriendBtn = document.getElementById('confirmShareDsWithFriendBtn');
        const manageDataStoreSharingStatus = document.getElementById('manageDataStoreSharingStatus');
        // File Management Modal (largely existing, check data-i18n)
        const fileManagementModal = document.getElementById('fileManagementModal'); /* ... */
        // Prompts Modals
        const promptsModal = document.getElementById('promptsModal');
        const promptsModalTabs = promptsModal.querySelectorAll('.modal-tab-btn');
        const promptsModalPanes = promptsModal.querySelectorAll('.modal-tab-content');
        const openCreatePromptModalBtn = document.getElementById('openCreatePromptModalBtn');
        const myPromptsList = document.getElementById('myPromptsList');
        const publicPromptsList = document.getElementById('publicPromptsList');
        const createEditPromptModal = document.getElementById('createEditPromptModal');
        const createEditPromptTitle = document.getElementById('createEditPromptTitle');
        const createEditPromptForm = document.getElementById('createEditPromptForm');
        const editPromptIdInput = document.getElementById('editPromptIdInput');
        const promptNameInput = document.getElementById('promptName');
        const promptCategoryInput = document.getElementById('promptCategory');
        const promptCategoriesList = document.getElementById('promptCategoriesList');
        const promptDescriptionInput = document.getElementById('promptDescription');
        const promptContentInput = document.getElementById('promptContent');
        const promptIsPublicCheckbox = document.getElementById('promptIsPublic');
        const createEditPromptStatus = document.getElementById('createEditPromptStatus');
        const confirmSavePromptBtn = document.getElementById('confirmSavePromptBtn');
        // Friends Modal
        const friendsModal = document.getElementById('friendsModal');
        const friendsModalTabs = friendsModal.querySelectorAll('.modal-tab-btn');
        const friendsModalPanes = friendsModal.querySelectorAll('.modal-tab-content');
        const myFriendsList = document.getElementById('myFriendsList');
        const incomingFriendRequestsList = document.getElementById('incomingFriendRequestsList');
        const outgoingFriendRequestsList = document.getElementById('outgoingFriendRequestsList');
        const findUserUsernameInput = document.getElementById('findUserUsernameInput');
        const sendFriendRequestBtn = document.getElementById('sendFriendRequestBtn');
        const findUsersStatus = document.getElementById('findUsersStatus');
        // Send Discussion Modal
        const sendDiscussionModal = document.getElementById('sendDiscussionModal');
        const sendTargetFriendSelect = document.getElementById('sendTargetFriendSelect'); // Was sendTargetUsernameInput
        
        // Common modal elements used in apiRequest helper
        const loginSubmitBtn = document.getElementById('loginSubmitBtn');
        const loginUsernameInput = document.getElementById('loginUsername');
        const loginPasswordInput = document.getElementById('loginPassword');
        const loginStatus = document.getElementById('loginStatus');
        const renameInput = document.getElementById('renameInput');
        const renameStatus = document.getElementById('renameStatus');
        const confirmRenameBtn = document.getElementById('confirmRenameBtn');
        const renameDiscussionIdInput = document.getElementById('renameDiscussionIdInput');
        const sendDiscussionStatus = document.getElementById('sendDiscussionStatus');
        const confirmSendDiscussionBtn = document.getElementById('confirmSendDiscussionBtn');
        const sendDiscussionIdInput = document.getElementById('sendDiscussionIdInput');
        const editMessageInput = document.getElementById('editMessageInput');
        const editMessageStatus = document.getElementById('editMessageStatus');
        const confirmEditMessageBtn = document.getElementById('confirmEditMessageBtn');
        const editMessageIdInput = document.getElementById('editMessageIdInput');


        // --- Utility Functions ---
        // (showStatus, populateDropdown, scrollChatToBottom - remain same)
        function showStatus(msg, type = 'info', statusElement = statusMessage) { /* ... unchanged ... */ }
        function populateDropdown(selectElement, items, selectedValue, emptyTextKey = "nothingFound", allowEmpty = false, valueField = "name", textField = "method_name") {
            if (!selectElement) { console.error("populateDropdown: selectElement is null for key", emptyTextKey); return; }
            selectElement.innerHTML = '';
            const localizedEmptyText = translate(emptyTextKey, emptyTextKey); // Translate the empty text
            if (allowEmpty) { const emptyOption = document.createElement('option'); emptyOption.value = ""; emptyOption.textContent = localizedEmptyText; selectElement.appendChild(emptyOption); }
            if (!items || !Array.isArray(items) || items.length === 0) {
                if (!allowEmpty) { const placeholder = document.createElement('option'); placeholder.disabled = true; placeholder.selected = true; placeholder.textContent = localizedEmptyText; selectElement.appendChild(placeholder); }
            } else {
                items.forEach(item => {
                    if (!item || typeof item[valueField] !== 'string') { console.warn(`Dropdown '${selectElement.id}': Skipping invalid item:`, item); return; }
                    const option = document.createElement('option');
                    option.value = item[valueField];
                    option.textContent = item[textField] || item[valueField]; // Use textField if present, else valueField
                    if (item[valueField] === selectedValue) { option.selected = true; }
                    selectElement.appendChild(option);
                });
            }
        }
        function scrollChatToBottom() { requestAnimationFrame(() => { chatMessages.scrollTop = chatMessages.scrollHeight; }); }
        
        // --- Dark Mode / Theme Switching ---
        function applyTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            localStorage.setItem('themePreference', theme);
            // Update CodeMirror theme if instances exist
            Object.values(codeMirrorInstances).forEach(cm => {
                // This is a basic example; a real solution might involve re-creating CM or using CM's theme switching if available
                // For now, material-darker might be okay for both or we choose a neutral one
            });
        }
        function initializeTheme() {
            let theme = localStorage.getItem('themePreference') || 'system';
            if (theme === 'system') {
                theme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            }
            applyTheme(theme);
            // Update buttons in settings if settings modal is open
            if (document.getElementById('settingsModal').classList.contains('active')) {
                updateThemeButtonsState(theme);
            }
        }
        function updateThemeButtonsState(activeTheme) {
            [themeLightBtn, themeDarkBtn, themeSystemBtn].forEach(btn => btn.classList.remove('bg-blue-500', 'text-white', 'dark:bg-blue-400'));
            if (activeTheme === 'light') themeLightBtn.classList.add('bg-blue-500', 'text-white', 'dark:bg-blue-400');
            else if (activeTheme === 'dark') themeDarkBtn.classList.add('bg-blue-500', 'text-white', 'dark:bg-blue-400');
            else themeSystemBtn.classList.add('bg-blue-500', 'text-white', 'dark:bg-blue-400');
        }

        // --- Internationalization (i18n) ---
        async function setLanguage(lang) {
            try {
                const response = await fetch(`/locales/${lang}.json`);
                if (!response.ok) throw new Error(`Failed to load ${lang}.json`);
                translations = await response.json();
                currentLocale = lang;
                localStorage.setItem('selectedLanguage', lang);
                document.documentElement.lang = lang;
                translatePage();
            } catch (error) {
                console.error("Error loading language file:", error);
                if (lang !== 'en') { // Fallback to English if preferred lang fails
                    console.warn("Falling back to English.");
                    await setLanguage('en');
                }
            }
        }
        function translate(key, fallbackText = '') {
            return translations[key] || fallbackText || key;
        }
        function translatePage() {
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.dataset.i18n;
                el.textContent = translate(key, el.textContent);
            });
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.dataset.i18nPlaceholder;
                el.placeholder = translate(key, el.placeholder);
            });
            document.querySelectorAll('[data-i18n-title]').forEach(el => {
                const key = el.dataset.i18nTitle;
                el.title = translate(key, el.title);
            });
            // Special cases for dynamic content might be needed elsewhere
            if (discussionTitle.dataset.i18nDefault) { // For initial discussion title
                 if (discussionTitle.textContent === discussionTitle.dataset.i18nDefault || discussionTitle.textContent === translate(discussionTitle.dataset.i18nDefault)) {
                    discussionTitle.textContent = translate(discussionTitle.dataset.i18nDefault);
                 }
            }
            if (languageSelect) languageSelect.value = currentLocale; // Update language selector
        }
        async function initializeLanguage() {
            const savedLang = localStorage.getItem('selectedLanguage') || navigator.language.split('-')[0] || 'en';
            await setLanguage(savedLang);
        }

        // --- API Helper --- (largely unchanged, temp creds logic is fine)
        async function apiRequest(url, options = {}) { /* ... unchanged ... */ }

        // --- Initialization ---
        window.onload = async () => {
            marked.setOptions({ highlight: (code, lang) => code, gfm: true, breaks: true });
            await initializeLanguage(); // Load language first
            initializeTheme(); // Then theme
            await attemptInitialAuthAndLoad();
            imageUploadInput.addEventListener('change', handleImageFileSelection);

            // Event listeners for theme buttons in settings
            themeLightBtn.onclick = () => applyTheme('light');
            themeDarkBtn.onclick = () => applyTheme('dark');
            themeSystemBtn.onclick = () => {
                const systemTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
                applyTheme(systemTheme); // Apply immediately
                localStorage.setItem('themePreference', 'system'); // Store 'system'
                updateThemeButtonsState('system');
            };
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                if (localStorage.getItem('themePreference') === 'system') {
                    applyTheme(e.matches ? 'dark' : 'light');
                }
            });
        };
        // (Rest of window.onload like attemptInitialAuthAndLoad)
        // ... (attemptInitialAuthAndLoad, initializeAppContent, handleLoginAttempt, handleLogout - mostly unchanged, but initializeAppContent and handleLogout clear/set new states)

        async function attemptInitialAuthAndLoad() { /* ... unchanged from previous ... */ }
        async function initializeAppContent() {
            appLoadingStatus.textContent = translate("loadingUserData");
            usernameDisplay.textContent = currentUser.username;
            userDefaultVectorizer = currentUser.safe_store_vectorizer;

            if (currentUser.is_admin) {
                adminBadge.style.display = 'inline-block';
                adminLink.style.display = 'flex';
            }
            
            appLoadingStatus.textContent = translate("loadingDiscussionsDataStores");
            await Promise.all([
                loadDiscussions(),
                loadDataStores(), // Includes owned and shared
                loadFriendsAndRequests(), // New
                loadMyPrompts() // New
            ]);
            
            appLoadingStatus.textContent = translate("loadingModelsVectorizers");
            await loadAvailableLollmsModels();
            await loadAvailableVectorizers(); // For global user default and RAG store settings
            
            updateRagToggleButtonState();
            
            // Core event listeners
            confirmRenameBtn.onclick = confirmInlineRename;
            confirmSendDiscussionBtn.onclick = confirmSendDiscussion;
            confirmEditMessageBtn.onclick = confirmMessageEdit;
            logoutBtn.onclick = handleLogout;
            loginSubmitBtn.onclick = handleLoginAttempt;
            loginPasswordInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleLoginAttempt(); });
            
            // Settings modal tabs
            settingsTabs.forEach(button => {
                button.addEventListener('click', () => {
                    settingsTabs.forEach(btn => btn.classList.remove('active'));
                    settingsContentPanes.forEach(pane => pane.classList.remove('active'));
                    button.classList.add('active');
                    document.getElementById(button.dataset.tab).classList.add('active');
                });
            });
            // General modal tabs (for Prompts, Data Stores, Friends)
            document.querySelectorAll('.modal-tabs .modal-tab-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const parentModal = button.closest('.modal');
                    parentModal.querySelectorAll('.modal-tab-btn').forEach(btn => btn.classList.remove('active'));
                    parentModal.querySelectorAll('.modal-tab-content').forEach(pane => pane.classList.remove('active'));
                    button.classList.add('active');
                    parentModal.querySelector(`#${button.dataset.tab}`).classList.add('active');
                });
            });

            // New sidebar button listeners
            promptsBtn.onclick = () => openModal('promptsModal');
            friendsBtn.onclick = () => openModal('friendsModal');
            
            // Insert Prompt Dropdown
            insertPromptBtn.onclick = (event) => {
                event.stopPropagation();
                toggleInsertPromptDropdown();
            };
            document.addEventListener('click', (event) => { // Close dropdown if clicked outside
                if (!insertPromptDropdown.contains(event.target) && event.target !== insertPromptBtn) {
                    insertPromptDropdown.style.display = 'none';
                }
            });
            promptSearchInput.oninput = filterUserPromptsForInsertion;


            // Init Create/Edit Prompt Modal Datalist
            PROMPT_CATEGORIES_DEFAULT.forEach(cat => {
                const option = document.createElement('option'); option.value = cat;
                promptCategoriesList.appendChild(option);
            });

            createDataStoreForm.addEventListener('submit', (e) => {e.preventDefault(); handleCreateOrUpdateDataStore();});
            confirmCreateOrUpdateDataStoreBtn.onclick = handleCreateOrUpdateDataStore; // If form is not used directly
            openCreateDataStoreModalBtn.onclick = () => openCreateDataStoreModal();

            createEditPromptForm.addEventListener('submit', (e) => {e.preventDefault(); handleSavePrompt(); });
            confirmSavePromptBtn.onclick = handleSavePrompt;
            openCreatePromptModalBtn.onclick = () => openCreateEditPromptModal(); // For new prompt

            sendFriendRequestBtn.onclick = handleSendFriendRequest;


            showStatus(translate("readyStatus"), 'success');
        }

        // --- Login and Logout ---
        async function handleLoginAttempt() { /* ... unchanged ... */ }
        async function handleLogout() { /* ... clear new states like friendsCache, myPromptsCache ... */
            // ... (existing logout logic) ...
            myPromptsCache = []; friendsCache = [];
            // Clear specific UI elements for new modals if needed
        }


        // --- Modal Management --- (openModal to populate new modals, tab switching logic)
        function openModal(modalId, allowOverlayClose = true) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('active');
                if (modalId === 'loginModal') { /* ... */ }
                else if (modalId === 'settingsModal') { populateSettingsModal(); }
                else if (modalId === 'dataStoresModal') { populateDataStoresModal(); }
                else if (modalId === 'promptsModal') { populatePromptsModal(); } // New
                else if (modalId === 'friendsModal') { populateFriendsModal(); } // New
                // ... other specific modal population logic ...
            }
        }
        // (closeModal unchanged)
        
        // Generic Tab switcher for modals that use it (Prompts, Data Stores, Friends)
        function switchModalTab(modalElement, tabButton) {
            modalElement.querySelectorAll('.modal-tab-btn').forEach(btn => btn.classList.remove('active'));
            modalElement.querySelectorAll('.modal-tab-content').forEach(pane => pane.classList.remove('active'));
            tabButton.classList.add('active');
            modalElement.querySelector(`#${tabButton.dataset.tab}`).classList.add('active');
        }


        // --- Discussion Management --- (send discussion to use friend list)
        // (loadDiscussions, renderDiscussionList, newDiscussionBtn.onclick, selectDiscussion, initiateInlineRename, confirmInlineRename - largely unchanged)
        // (deleteInlineDiscussion, toggleStarDiscussion - unchanged)
        function initiateSendDiscussion(id) { // Updated to use friend select
            if (!discussions[id]) return;
            sendDiscussionIdInput.value = id;
            document.getElementById('sendDiscussionModal').querySelector('.modal-title').textContent = `${translate("sendDiscussionTitle")}: "${discussions[id].title}"`;
            
            sendTargetFriendSelect.innerHTML = `<option value="">${translate("selectFriendPlaceholder")}</option>`;
            friendsCache.forEach(friend => {
                if (friend.status === 'accepted') {
                    const option = document.createElement('option');
                    option.value = friend.friend_username;
                    option.textContent = friend.friend_username;
                    sendTargetFriendSelect.appendChild(option);
                }
            });
            showStatus('', 'info', sendDiscussionStatus);
            openModal('sendDiscussionModal');
        }
        async function confirmSendDiscussion() { // Updated
            const discussionId = sendDiscussionIdInput.value;
            const targetUsername = sendTargetFriendSelect.value; // Changed from input to select
            if (!discussionId || !targetUsername) {
                showStatus(translate("targetFriendRequiredError"), 'error', sendDiscussionStatus); return;
            }
            showStatus(translate("sendingDiscussionTo", { username: targetUsername }), 'info', sendDiscussionStatus);
            try {
                await apiRequest(`/api/discussions/${discussionId}/send`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ target_username: targetUsername }),
                    statusElement: sendDiscussionStatus
                });
                showStatus(translate("discussionSentSuccess"), 'success', sendDiscussionStatus);
                setTimeout(() => closeModal('sendDiscussionModal'), 1500);
            } catch (error) { console.error("Send discussion failed:", error); }
        }
        
        // --- Chat Interaction --- (sendMessage, handleStreamChunk, handleStreamEnd - RAG top_k integration)
        async function sendMessage() {
            // ... (existing prompt and image checks) ...
            const formData = new FormData();
            formData.append('prompt', prompt);
            formData.append('image_server_paths_json', JSON.stringify(uploadedImageServerPaths.map(img => img.server_path)));
            formData.append('use_rag', isRagActive);
            if(isRagActive && discussions[currentDiscussionId] && discussions[currentDiscussionId].rag_datastore_id) {
                formData.append('rag_datastore_id', discussions[currentDiscussionId].rag_datastore_id);
            }
            // RAG Top K is now handled by backend using user's preference or default
            // No need to send it from client for each message, unless we want per-message override.
            // ... (rest of sendMessage remains similar) ...
        }
        // (handleStreamChunk, handleStreamEnd, refreshMessagesAfterStream - unchanged)

        // --- Message Rendering --- (clearChatArea, renderMessages, renderMessage - i18n for system messages)
        // (renderProcessedContent, renderCodeMirrorBlocks, gradeMessage, initiateEditMessage, confirmMessageEdit, deleteMessage - mostly unchanged)

        // --- Pyodide (Unchanged) ---
        // (loadPyodide, executePythonCode, showPyodideStatus)

        // --- Settings Modal Logic (Updated for Tabs and New Settings) ---
        settingsBtn.onclick = () => openModal('settingsModal');
        // (loadAvailableLollmsModels - unchanged)
        
        async function populateSettingsModal() {
            // User Profile
            currentPasswordInput.value = ''; newPasswordInput.value = ''; confirmNewPasswordInput.value = '';
            savePasswordBtn.disabled = false; // Enable by default, validation will handle
            
            // LLM
            populateDropdown(settingsLollmsModelSelect, availableLollmsModels, currentUser.lollms_model_name, "noModelsFound");
            saveModelSettingsBtn.disabled = true;
            settingsTemperature.value = currentUser.llm_temperature ?? '';
            settingsTopK.value = currentUser.llm_top_k ?? '';
            settingsTopP.value = currentUser.llm_top_p ?? '';
            settingsRepeatPenalty.value = currentUser.llm_repeat_penalty ?? '';
            settingsRepeatLastN.value = currentUser.llm_repeat_last_n ?? '';
            saveLLMParamsBtn.disabled = true;

            // RAG
            populateDropdown(settingsVectorizerSelect, availableVectorizers, userDefaultVectorizer, "noVectorizersFound", true);
            settingsRagTopKInput.value = currentUser.rag_top_k || DEFAULT_RAG_TOP_K;
            saveRagSettingsBtn.disabled = true;

            // Appearance
            languageSelect.value = currentLocale;
            updateThemeButtonsState(localStorage.getItem('themePreference') || 'system');
            saveAppearanceSettingsBtn.disabled = true;

            showStatus('', 'info', settingsStatus);
            // Activate the first tab (or last opened if stored)
            settingsTabs[0].click(); 
        }
        
        // Save Password
        savePasswordBtn.onclick = async () => {
            const currentPass = currentPasswordInput.value;
            const newPass = newPasswordInput.value;
            const confirmPass = confirmNewPasswordInput.value;
            if (!currentPass || !newPass || !confirmPass) {
                showStatus(translate("allPasswordFieldsRequired"), 'error', settingsStatus); return;
            }
            if (newPass !== confirmPass) {
                showStatus(translate("newPasswordsDoNotMatch"), 'error', settingsStatus); return;
            }
            if (newPass.length < 8) {
                showStatus(translate("passwordTooShort"), 'error', settingsStatus); return;
            }
            showStatus(translate("savingPassword"), 'info', settingsStatus); savePasswordBtn.disabled = true;
            try {
                await apiRequest('/api/users/me/password', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ current_password: currentPass, new_password: newPass }),
                    statusElement: settingsStatus
                });
                showStatus(translate("passwordSavedSuccess"), 'success', settingsStatus);
                currentPasswordInput.value = ''; newPasswordInput.value = ''; confirmNewPasswordInput.value = '';
            } catch (error) { console.error("Failed to save password:", error); }
            finally { savePasswordBtn.disabled = false; }
        };

        // Save Model Settings (Only model name now)
        settingsLollmsModelSelect.onchange = () => { saveModelSettingsBtn.disabled = (settingsLollmsModelSelect.value === currentUser.lollms_model_name);};
        saveModelSettingsBtn.onclick = async () => {
            const selectedModel = settingsLollmsModelSelect.value;
            if (!selectedModel || selectedModel === currentUser.lollms_model_name) return;
            showStatus(translate("savingModel"), 'info', settingsStatus); saveModelSettingsBtn.disabled = true;
            try {
                const formData = new FormData(); formData.append('model_name', selectedModel);
                await apiRequest('/api/config/lollms-model', { method: 'POST', body: formData, statusElement: settingsStatus });
                currentUser.lollms_model_name = selectedModel;
                showStatus(translate("modelSavedSuccess"), 'success', settingsStatus);
            } catch (error) { console.error("Failed to save model:", error); }
            finally { saveModelSettingsBtn.disabled = false; }
        };

        // Save LLM Params (Unchanged logic, new button if needed or merged)
        [settingsTemperature, settingsTopK, settingsTopP, settingsRepeatPenalty, settingsRepeatLastN].forEach(el => {
            el.oninput = () => { saveLLMParamsBtn.disabled = false; };
        });
        saveLLMParamsBtn.onclick = async () => { /* ... unchanged from previous ... */ };
        
        // Save RAG Settings (Vectorizer and Top K)
        settingsVectorizerSelect.onchange = () => { saveRagSettingsBtn.disabled = (settingsVectorizerSelect.value === userDefaultVectorizer && parseInt(settingsRagTopKInput.value) === (currentUser.rag_top_k || DEFAULT_RAG_TOP_K));};
        settingsRagTopKInput.oninput = () => { saveRagSettingsBtn.disabled = (settingsVectorizerSelect.value === userDefaultVectorizer && parseInt(settingsRagTopKInput.value) === (currentUser.rag_top_k || DEFAULT_RAG_TOP_K));};
        saveRagSettingsBtn.onclick = async () => {
            const selectedVectorizer = settingsVectorizerSelect.value;
            const selectedRagTopK = parseInt(settingsRagTopKInput.value);
            let vectorizerChanged = selectedVectorizer && selectedVectorizer !== userDefaultVectorizer;
            let ragTopKChanged = selectedRagTopK && selectedRagTopK !== (currentUser.rag_top_k || DEFAULT_RAG_TOP_K);

            if (!vectorizerChanged && !ragTopKChanged) return;
            showStatus(translate("savingRagSettings"), 'info', settingsStatus); saveRagSettingsBtn.disabled = true;
            try {
                // Separate API for default vectorizer if needed, or part of user preferences
                if (vectorizerChanged) { // This needs a specific API endpoint or to be part of preferences. For now, assuming preferences.
                    // await apiRequest('/api/config/default-vectorizer', { method: 'POST', body: new FormData().append('vectorizer_name',selectedVectorizer), statusElement: settingsStatus });
                    // userDefaultVectorizer = selectedVectorizer;
                    // currentUser.safe_store_vectorizer = selectedVectorizer;
                }
                // Save RAG Top K via user preferences endpoint
                await apiRequest('/api/users/me/preferences', {
                    method: 'PUT', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ safe_store_vectorizer: selectedVectorizer, rag_top_k: selectedRagTopK }), // Assuming backend handles this
                    statusElement: settingsStatus
                });
                if(vectorizerChanged) {userDefaultVectorizer = selectedVectorizer; currentUser.safe_store_vectorizer = selectedVectorizer;}
                if(ragTopKChanged) {currentUser.rag_top_k = selectedRagTopK;}

                showStatus(translate("ragSettingsSavedSuccess"), 'success', settingsStatus);
            } catch (error) { console.error("Failed to save RAG settings:", error); }
            finally { saveRagSettingsBtn.disabled = false; }
        };
        
        // Save Appearance Settings
        languageSelect.onchange = () => saveAppearanceSettingsBtn.disabled = false;
        [themeLightBtn, themeDarkBtn, themeSystemBtn].forEach(btn => btn.onclick = () => {
            saveAppearanceSettingsBtn.disabled = false;
            // Actual theme application is handled by their direct onclicks
        });
        saveAppearanceSettingsBtn.onclick = async () => {
            const selectedLang = languageSelect.value;
            const selectedTheme = localStorage.getItem('themePreference') || 'system'; // Theme already applied and stored

            showStatus(translate("savingAppearanceSettings"), 'info', settingsStatus); saveAppearanceSettingsBtn.disabled = true;
            try {
                await apiRequest('/api/users/me/preferences', {
                    method: 'PUT', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ theme_preference: selectedTheme }), // Send only theme as lang is client-side for now
                    statusElement: settingsStatus
                });
                currentUser.theme_preference = selectedTheme; // Update local state
                if (currentLocale !== selectedLang) {
                    await setLanguage(selectedLang); // Change language and re-translate
                }
                showStatus(translate("appearanceSettingsSavedSuccess"), 'success', settingsStatus);
                saveAppearanceSettingsBtn.disabled = true; // Disable after successful save
            } catch (error) { console.error("Failed to save appearance settings:", error); }
            finally { /* saveAppearanceSettingsBtn re-enabled by oninput/onchange */ }
        };

        // --- Data Store Management (Updated for new Modals & Tabs) ---
        // (loadDataStores, populateRagDataStoreSelect - largely same logic)
        // (ragDataStoreSelect.onchange - same)
        // (deleteDataStore - same, but called from new UI context)
        dataStoresBtn.onclick = () => openModal('dataStoresModal');
        async function loadDataStores() { /* ... unchanged from previous ... */ }
        function populateRagDataStoreSelect() { /* ... unchanged ... */ }
        
        function populateDataStoresModal() {
            // My Data Stores Tab
            ownedDataStoresList.innerHTML = '';
            if (ownedDataStores.length === 0) {
                ownedDataStoresList.innerHTML = `<p class="text-gray-500 dark:text-gray-400 italic">${translate("noDataStoresCreated")}</p>`;
            } else {
                ownedDataStores.forEach(ds => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center py-1.5 px-2 hover:bg-gray-100 dark:hover:bg-gray-600 rounded text-sm';
                    div.innerHTML = `
                        <div class="flex-1">
                            <strong class="text-gray-800 dark:text-gray-100">${ds.name}</strong>
                            <span class="ml-2 text-xs ${ds.is_public_in_store ? 'text-green-600 dark:text-green-400' : 'text-gray-500 dark:text-gray-400'}">
                                ${ds.is_public_in_store ? `(${translate("publicInStore")})` : `(${translate("private")})`}
                            </span>
                            <p class="text-xs text-gray-500 dark:text-gray-400 truncate">${ds.description || translate("noDescription")}</p>
                        </div>
                        <div class="space-x-1">
                            <button title="${translate("manageFilesButtonTitle")}" onclick="openFileManagerForStore('${ds.id}', '${ds.name}')" class="p-1 hover:bg-blue-100 dark:hover:bg-blue-700 rounded"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 text-blue-600 dark:text-blue-400"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 9.776c.112-.017.227-.026.344-.026h15.812c.117 0 .232.009.344.026m-16.5 0a2.25 2.25 0 0 0-1.883 2.542l.857 6a2.25 2.25 0 0 0 2.227 1.932H19.05a2.25 2.25 0 0 0 2.227-1.932l.857-6a2.25 2.25 0 0 0-1.883-2.542m-16.5 0V6A2.25 2.25 0 0 1 6 3.75h3.879a1.5 1.5 0 0 1 1.06.44l2.122 2.12a1.5 1.5 0 0 0 1.06.44H18A2.25 2.25 0 0 1 20.25 9v.776" /></svg></button>
                            <button title="${translate("manageSharingButtonTitle")}" onclick="openManageDataStoreSharingModal('${ds.id}', '${ds.name}')" class="p-1 hover:bg-green-100 dark:hover:bg-green-700 rounded"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 text-green-600 dark:text-green-400"><path stroke-linecap="round" stroke-linejoin="round" d="M7.217 10.907a2.25 2.25 0 1 0 0-4.5 2.25 2.25 0 0 0 0 4.5Zm0 0v(.001M4.5 19.5h15a2.25 2.25 0 0 0 2.25-2.25V6.75A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25v10.5A2.25 2.25 0 0 0 4.5 19.5Zm6-10.125a1.875 1.875 0 1 1-3.75 0 1.875 1.875 0 0 1 3.75 0Zm1.294 6.336a6.721 6.721 0 0 1-3.17.789 6.721 6.721 0 0 1-3.168-.789 3.376 3.376 0 0 1 6.338 0Z" /></svg></button>
                            <button title="${translate("editButtonTitle")}" onclick="openEditDataStoreModal('${ds.id}', '${ds.name}', '${ds.description || ''}', ${ds.is_public_in_store})" class="p-1 hover:bg-yellow-100 dark:hover:bg-yellow-600 rounded"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 text-yellow-600 dark:text-yellow-400"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.82a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125" /></svg></button>
                            <button title="${translate("deleteButtonTitle")}" onclick="deleteDataStore('${ds.id}', '${ds.name}')" class="p-1 hover:bg-red-100 dark:hover:bg-red-700 rounded"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 text-red-600 dark:text-red-400"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12.508 0A48.067 48.067 0 0 1 7.8 5.397m7.454 0M12 10.75h.008v.008H12v-.008Z" /></svg></button>
                        </div>
                    `;
                    ownedDataStoresList.appendChild(div);
                });
            }
            // Shared With Me Tab
            sharedDataStoresList.innerHTML = '';
            const actualSharedStores = sharedDataStores.filter(ds => ds.owner_username !== currentUser.username); // Filter out stores user might own but are listed as shared (edge case)
            if (actualSharedStores.length === 0) {
                sharedDataStoresList.innerHTML = `<p class="text-gray-500 dark:text-gray-400 italic">${translate("noStoresSharedWithYou")}</p>`;
            } else {
                 actualSharedStores.forEach(ds => {
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center py-1.5 px-2 text-sm';
                    div.innerHTML = `
                        <div class="flex-1">
                            <strong class="text-gray-800 dark:text-gray-100">${ds.name}</strong> <span class="text-xs text-gray-500 dark:text-gray-400">(${translate("ownedBy", {username: ds.owner_username})})</span>
                            <p class="text-xs text-gray-500 dark:text-gray-400 truncate">${ds.description || translate("noDescription")}</p>
                        </div>
                        <button title="${translate("useForRagButtonTitle")}" onclick="setDiscussionRagStore('${ds.id}')" class="p-1 text-xs bg-blue-100 dark:bg-blue-700 text-blue-700 dark:text-blue-100 rounded hover:bg-blue-200 dark:hover:bg-blue-600">${translate("useForRagButton")}</button>
                    `; // Maybe add "Remove from my interface" if it was added from store
                    sharedDataStoresList.appendChild(div);
                });
            }
            // Data Store Store Tab
            populatePublicDataStoresList();
        }
        function openCreateDataStoreModal(storeToEdit = null) {
            createDataStoreForm.reset();
            editDataStoreIdInput.value = storeToEdit ? storeToEdit.id : '';
            newDataStoreNameInput.value = storeToEdit ? storeToEdit.name : '';
            newDataStoreDescriptionInput.value = storeToEdit ? storeToEdit.description : '';
            newDataStoreIsPublicCheckbox.checked = storeToEdit ? storeToEdit.is_public_in_store : false;
            confirmCreateOrUpdateDataStoreBtn.textContent = storeToEdit ? translate("updateStoreButton") : translate("createStoreButton");
            createDataStoreModal.querySelector('.modal-title').textContent = storeToEdit ? translate("editDataStoreTitle") : translate("createNewDataStoreTitle");
            showStatus('', 'info', createDataStoreStatus);
            openModal('createDataStoreModal');
        }
        function openEditDataStoreModal(id, name, description, isPublic) {
            openCreateDataStoreModal({id, name, description, is_public_in_store: isPublic});
        }
        async function handleCreateOrUpdateDataStore() {
            const name = newDataStoreNameInput.value.trim();
            const description = newDataStoreDescriptionInput.value.trim();
            const isPublic = newDataStoreIsPublicCheckbox.checked;
            const storeId = editDataStoreIdInput.value;
            if (!name) { showStatus(translate("dataStoreNameRequired"), "error", createDataStoreStatus); return; }
            
            const payload = { name, description, is_public_in_store: isPublic };
            const method = storeId ? 'PUT' : 'POST';
            const url = storeId ? `/api/datastores/${storeId}` : '/api/datastores';
            const actionText = storeId ? translate("updatingDataStore") : translate("creatingDataStore");

            showStatus(actionText, "info", createDataStoreStatus);
            try {
                await apiRequest(url, {
                    method: method, headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload), statusElement: createDataStoreStatus
                });
                showStatus(storeId ? translate("dataStoreUpdatedSuccess") : translate("dataStoreCreatedSuccess"), "success", createDataStoreStatus);
                await loadDataStores(); // Refresh lists
                setTimeout(() => closeModal('createDataStoreModal'), 1000);
            } catch (error) { console.error("Data Store C/U failed:", error); }
        }
        async function deleteDataStore(id, name) { /* ... unchanged, add i18n to confirm ... */ }

        // New: Populate Public Data Stores List
        async function populatePublicDataStoresList() {
            publicDataStoresList.innerHTML = `<p class="italic text-gray-500 dark:text-gray-400">${translate("loadingPublicStores")}</p>`;
            try {
                const response = await apiRequest('/api/datastores/store');
                const stores = await response.json();
                publicDataStoresList.innerHTML = '';
                if (stores.length === 0) {
                    publicDataStoresList.innerHTML = `<p class="italic text-gray-500 dark:text-gray-400">${translate("noPublicStoresAvailable")}</p>`;
                } else {
                    stores.forEach(ds => {
                        const div = document.createElement('div');
                        div.className = 'flex justify-between items-center py-1.5 px-2 text-sm';
                        div.innerHTML = `
                            <div>
                                <strong class="text-gray-800 dark:text-gray-100">${ds.name}</strong>
                                <span class="text-xs text-gray-500 dark:text-gray-400"> (${translate("ownedBy", {username: ds.owner_username})})</span>
                                <p class="text-xs text-gray-500 dark:text-gray-400 truncate">${ds.description || translate("noDescription")}</p>
                            </div>
                            ${ds.owner_username !== currentUser.username ? 
                                `<button onclick="addPublicStoreToInterface('${ds.id}')" class="p-1 text-xs bg-green-100 dark:bg-green-700 text-green-700 dark:text-green-100 rounded hover:bg-green-200 dark:hover:bg-green-600">${translate("addToMyInterfaceButton")}</button>`
                                : `<span class="text-xs text-gray-400 dark:text-gray-500 italic">(${translate("ownedByYou")})</span>`
                            }
                        `;
                        publicDataStoresList.appendChild(div);
                    });
                }
            } catch (error) {
                console.error("Failed to load public data stores:", error);
                publicDataStoresList.innerHTML = `<p class="text-red-500 dark:text-red-400 italic">${translate("errorLoadingPublicStores")}</p>`;
            }
        }
        async function addPublicStoreToInterface(storeId) {
            showStatus(translate("addingStoreToInterface"), 'info');
            try {
                await apiRequest(`/api/datastores/${storeId}/add_to_my_interface`, { method: 'POST' });
                showStatus(translate("storeAddedSuccess"), 'success');
                await loadDataStores(); // Refresh shared list
            } catch (error) { console.error("Failed to add public store:", error); /* Status already shown by apiRequest */ }
        }
        
        // Manage Data Store Sharing Modal
        let currentManageSharingDsId = null;
        async function openManageDataStoreSharingModal(datastoreId, datastoreName) {
            currentManageSharingDsId = datastoreId;
            manageDataStoreSharingTitle.textContent = `${translate("manageSharingTitle")}: "${datastoreName}"`;
            manageSharingDataStoreIdInput.value = datastoreId;
            dsSharedWithList.innerHTML = `<p class="italic text-gray-500 dark:text-gray-400">${translate("loadingSharedUsers")}</p>`;
            shareDsWithFriendSelect.innerHTML = `<option value="">${translate("selectFriendPlaceholder")}</option>`;
            friendsCache.forEach(friend => {
                if (friend.status === 'accepted') {
                    const option = document.createElement('option');
                    option.value = friend.friend_username;
                    option.textContent = friend.friend_username;
                    shareDsWithFriendSelect.appendChild(option);
                }
            });
            showStatus('', 'info', manageDataStoreSharingStatus);
            openModal('manageDataStoreSharingModal');
            await loadDsSharedWithUsers(datastoreId);
        }
        async function loadDsSharedWithUsers(datastoreId) {
            try {
                const response = await apiRequest(`/api/datastores/${datastoreId}/shared_with`);
                const users = await response.json();
                dsSharedWithList.innerHTML = '';
                if (users.length === 0) {
                    dsSharedWithList.innerHTML = `<p class="italic text-gray-500 dark:text-gray-400">${translate("notSharedWithAnyFriends")}</p>`;
                } else {
                    users.forEach(user => {
                        const item = document.createElement('div');
                        item.className = 'flex justify-between items-center';
                        item.innerHTML = `<span>${user.username}</span> <button onclick="unshareDsFromFriend('${datastoreId}', '${user.username}')" class="text-red-500 dark:text-red-400 hover:underline text-xs">${translate("removeAccessButton")}</button>`;
                        dsSharedWithList.appendChild(item);
                    });
                }
            } catch (error) {
                dsSharedWithList.innerHTML = `<p class="text-red-500 dark:text-red-400 italic">${translate("errorLoadingSharedUsers")}</p>`;
            }
        }
        confirmShareDsWithFriendBtn.onclick = async () => {
            const friendUsername = shareDsWithFriendSelect.value;
            if (!currentManageSharingDsId || !friendUsername) {
                showStatus(translate("selectFriendToShareWithError"), 'error', manageDataStoreSharingStatus); return;
            }
            showStatus(translate("sharingDataStoreWith", {username: friendUsername}), 'info', manageDataStoreSharingStatus);
            try {
                await apiRequest(`/api/datastores/${currentManageSharingDsId}/share_with_friend`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ target_username: friendUsername, permission_level: "read_query" }),
                    statusElement: manageDataStoreSharingStatus
                });
                showStatus(translate("dataStoreSharedSuccess"), 'success', manageDataStoreSharingStatus);
                await loadDsSharedWithUsers(currentManageSharingDsId); // Refresh list
                shareDsWithFriendSelect.value = ""; // Reset dropdown
            } catch (error) { console.error("Share DS with friend failed:", error); }
        };
        async function unshareDsFromFriend(datastoreId, friendUsername) {
            if (!confirm(translate("confirmUnshareDs", {username: friendUsername}))) return;
            showStatus(translate("unsharingDataStoreFrom", {username: friendUsername}), 'info', manageDataStoreSharingStatus);
            try {
                await apiRequest(`/api/datastores/${datastoreId}/unshare_from_friend/${friendUsername}`, { method: 'DELETE', statusElement: manageDataStoreSharingStatus });
                showStatus(translate("dataStoreUnsharedSuccess"), 'success', manageDataStoreSharingStatus);
                await loadDsSharedWithUsers(datastoreId); // Refresh list
            } catch (error) { console.error("Unshare DS from friend failed:", error); }
        }


        // --- File Management (Per-DataStore, largely same, needs i18n) ---
        // (openFileManagerForStore, loadIndexedRagFilesInStore, updateConfirmUploadBtnState, confirmUploadBtn.onclick, renderRagFileList, deleteRagFileInModal)
        // filesBtn is removed, functionality is via Data Stores modal.

        // --- RAG Toggle Logic --- (setDiscussionRagStore for shared stores)
        // (ragToggleBtn.onclick, updateRagToggleButtonState - unchanged)
        function setDiscussionRagStore(datastoreId) { /* ... unchanged, add i18n ... */ }
        
        // --- Image Upload Handling & Viewer (Unchanged) ---
        // (handleImageFileSelection, renderImagePreview, viewImage)

        // --- Export / Import Logic (Updated for prompts) ---
        // (populateExportModal, exportDataBtn.onclick, confirmExportBtn.onclick - update to include prompts)
        // (importDataBtn.onclick, importFile.onchange, confirmImportBtn.onclick - update to handle prompts in import file)

        // --- Prompt Management (New) ---
        function openCreateEditPromptModal(promptToEdit = null) {
            createEditPromptForm.reset();
            editPromptIdInput.value = promptToEdit ? promptToEdit.id : '';
            promptNameInput.value = promptToEdit ? promptToEdit.name : '';
            promptCategoryInput.value = promptToEdit ? promptToEdit.category : '';
            promptDescriptionInput.value = promptToEdit ? promptToEdit.description : '';
            promptContentInput.value = promptToEdit ? promptToEdit.content : '';
            promptIsPublicCheckbox.checked = promptToEdit ? promptToEdit.is_public : false;
            createEditPromptTitle.textContent = promptToEdit ? translate("editPromptTitle") : translate("createPromptTitle");
            confirmSavePromptBtn.textContent = promptToEdit ? translate("updatePromptButton") : translate("createPromptButton");
            showStatus('', 'info', createEditPromptStatus);
            openModal('createEditPromptModal');
        }
        async function handleSavePrompt() {
            const promptId = editPromptIdInput.value;
            const payload = {
                name: promptNameInput.value.trim(), category: promptCategoryInput.value.trim() || null,
                description: promptDescriptionInput.value.trim() || null, content: promptContentInput.value.trim(),
                is_public: promptIsPublicCheckbox.checked
            };
            if (!payload.name || !payload.content) {
                showStatus(translate("promptNameContentRequired"), 'error', createEditPromptStatus); return;
            }
            const method = promptId ? 'PUT' : 'POST';
            const url = promptId ? `/api/prompts/${promptId}` : '/api/prompts';
            const actionText = promptId ? translate("updatingPrompt") : translate("creatingPrompt");
            showStatus(actionText, 'info', createEditPromptStatus);
            try {
                await apiRequest(url, {
                    method: method, headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload), statusElement: createEditPromptStatus
                });
                showStatus(promptId ? translate("promptUpdatedSuccess") : translate("promptCreatedSuccess"), 'success', createEditPromptStatus);
                await loadMyPrompts(); // Refresh My Prompts list
                if (payload.is_public || (promptId && myPromptsCache.find(p=>p.id==promptId)?.is_public)) {
                    await populatePublicPromptsList(); // Refresh store if public status changed
                }
                setTimeout(() => closeModal('createEditPromptModal'), 1000);
            } catch (error) { console.error("Save prompt failed:", error); }
        }
        async function loadMyPrompts() {
            myPromptsList.innerHTML = `<p class="italic text-gray-500 dark:text-gray-400">${translate("loadingYourPrompts")}</p>`;
            try {
                const response = await apiRequest('/api/prompts/mine');
                myPromptsCache = await response.json();
                renderMyPromptsList();
                populateUserPromptsForInsertion(); // Update dropdown for chat input
            } catch (error) {
                console.error("Failed to load my prompts:", error);
                myPromptsList.innerHTML = `<p class="text-red-500 dark:text-red-400 italic">${translate("errorLoadingYourPrompts")}</p>`;
            }
        }
        function renderMyPromptsList() {
            myPromptsList.innerHTML = '';
            if (myPromptsCache.length === 0) {
                myPromptsList.innerHTML = `<p class="italic text-gray-500 dark:text-gray-400">${translate("noPromptsCreatedYet")}</p>`; return;
            }
            myPromptsCache.forEach(p => {
                const div = document.createElement('div');
                div.className = 'p-2 border-b dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700/50';
                div.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <strong class="text-gray-800 dark:text-gray-100">${p.name}</strong>
                            <span class="ml-2 text-xs ${p.is_public ? 'text-green-600 dark:text-green-400' : 'text-gray-500 dark:text-gray-400'}">
                                ${p.is_public ? `(${translate("publicInStore")})` : `(${translate("private")})`}
                            </span>
                        </div>
                        <div class="space-x-1 text-xs">
                            <button onclick="openCreateEditPromptModal(myPromptsCache.find(pr=>pr.id===${p.id}))" class="text-blue-600 dark:text-blue-400 hover:underline">${translate("editButton")}</button>
                            <button onclick="deletePrompt(${p.id}, '${p.name}')" class="text-red-600 dark:text-red-400 hover:underline">${translate("deleteButton")}</button>
                        </div>
                    </div>
                    ${p.category ? `<p class="text-xs text-gray-500 dark:text-gray-400">${translate("categoryLabel")}: ${p.category}</p>` : ''}
                    ${p.description ? `<p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">${p.description}</p>` : ''}
                    <pre class="mt-1 p-1 bg-gray-100 dark:bg-gray-700 text-xs max-h-20 overflow-y-auto rounded whitespace-pre-wrap">${p.content}</pre>
                `;
                myPromptsList.appendChild(div);
            });
        }
        async function deletePrompt(promptId, promptName) {
            if (!confirm(translate("confirmDeletePrompt", {name: promptName}))) return;
            showStatus(translate("deletingPrompt"), 'info');
            try {
                await apiRequest(`/api/prompts/${promptId}`, { method: 'DELETE' });
                showStatus(translate("promptDeletedSuccess"), 'success');
                await loadMyPrompts(); // Refresh list
                await populatePublicPromptsList(); // Refresh store if it was public
            } catch (error) { console.error("Delete prompt failed:", error); }
        }
        async function populatePublicPromptsList() {
            publicPromptsList.innerHTML = `<p class="italic text-gray-500 dark:text-gray-400">${translate("loadingPublicPrompts")}</p>`;
            try {
                const response = await apiRequest('/api/prompts/store');
                const prompts = await response.json();
                publicPromptsList.innerHTML = '';
                if (prompts.length === 0) {
                    publicPromptsList.innerHTML = `<p class="italic text-gray-500 dark:text-gray-400">${translate("noPublicPromptsAvailable")}</p>`;
                } else {
                    prompts.forEach(p => {
                        const div = document.createElement('div');
                        div.className = 'p-2 border-b dark:border-gray-600';
                        div.innerHTML = `
                            <div class="flex justify-between items-center">
                                <div>
                                    <strong class="text-gray-800 dark:text-gray-100">${p.name}</strong>
                                    <span class="text-xs text-gray-500 dark:text-gray-400"> (${translate("byUser", {username: p.owner_username})})</span>
                                </div>
                                <div class="space-x-1 text-xs">
                                    <button onclick="usePromptContent('${p.content.replace(/'/g, "\\'")}')" class="text-blue-600 dark:text-blue-400 hover:underline">${translate("useButton")}</button>
                                    ${p.owner_username !== currentUser.username ? `<button onclick="addPublicPromptToMine(${p.id})" class="text-green-600 dark:text-green-400 hover:underline">${translate("addToMyPromptsButton")}</button>` : ''}
                                </div>
                            </div>
                            ${p.category ? `<p class="text-xs text-gray-500 dark:text-gray-400">${translate("categoryLabel")}: ${p.category}</p>` : ''}
                            ${p.description ? `<p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">${p.description}</p>` : ''}
                            <pre class="mt-1 p-1 bg-gray-100 dark:bg-gray-700 text-xs max-h-20 overflow-y-auto rounded whitespace-pre-wrap">${p.content}</pre>
                        `;
                        publicPromptsList.appendChild(div);
                    });
                }
            } catch (error) {
                console.error("Failed to load public prompts:", error);
                publicPromptsList.innerHTML = `<p class="text-red-500 dark:text-red-400 italic">${translate("errorLoadingPublicPrompts")}</p>`;
            }
        }
        function usePromptContent(content) {
            messageInput.value = content;
            autoGrowTextarea(messageInput);
            messageInput.focus();
            closeModal('promptsModal');
        }
        async function addPublicPromptToMine(promptId) {
            showStatus(translate("addingPromptToYours"), 'info');
            try {
                await apiRequest(`/api/prompts/${promptId}/add_to_my_prompts`, { method: 'POST' });
                showStatus(translate("promptAddedToYoursSuccess"), 'success');
                await loadMyPrompts(); // Refresh your list
            } catch (error) { console.error("Failed to add public prompt:", error); }
        }
        function populatePromptsModal() {
            loadMyPrompts();
            populatePublicPromptsList();
            // Activate first tab by default
            promptsModalTabs[0].click();
        }
        // Insert Prompt Dropdown Logic
        function toggleInsertPromptDropdown() {
            if (insertPromptDropdown.style.display === 'none') {
                populateUserPromptsForInsertion();
                insertPromptDropdown.style.display = 'block';
                promptSearchInput.value = ''; promptSearchInput.focus();
            } else {
                insertPromptDropdown.style.display = 'none';
            }
        }
        function populateUserPromptsForInsertion(filterText = "") {
            userPromptsForInsertionList.innerHTML = '';
            const filtered = myPromptsCache.filter(p => p.name.toLowerCase().includes(filterText.toLowerCase()));
            if (filtered.length === 0) {
                userPromptsForInsertionList.innerHTML = `<p class="px-2 py-1 text-gray-500 dark:text-gray-400">${translate("noPromptsFound")}</p>`;
            }
            filtered.forEach(p => {
                const item = document.createElement('div');
                item.className = 'px-2 py-1 hover:bg-gray-100 dark:hover:bg-gray-600 cursor-pointer rounded';
                item.textContent = p.name;
                item.onclick = () => {
                    messageInput.value += (messageInput.value ? "\n" : "") + p.content;
                    autoGrowTextarea(messageInput);
                    messageInput.focus();
                    insertPromptDropdown.style.display = 'none';
                };
                userPromptsForInsertionList.appendChild(item);
            });
        }
        function filterUserPromptsForInsertion() {
            populateUserPromptsForInsertion(promptSearchInput.value);
        }


        // --- Friend Management (New) ---
        async function loadFriendsAndRequests() {
            await Promise.all([loadMyFriendsList(), loadIncomingRequests(), loadOutgoingRequests()]);
        }
        async function loadMyFriendsList() {
            myFriendsList.innerHTML = `<p class="italic text-gray-500 dark:text-gray-400">${translate("loadingFriends")}</p>`;
            try {
                const response = await apiRequest('/api/friendships');
                friendsCache = await response.json(); // Cache for other uses e.g. sharing
                myFriendsList.innerHTML = '';
                if (friendsCache.filter(f => f.status === 'accepted').length === 0) {
                    myFriendsList.innerHTML = `<p class="italic text-gray-500 dark:text-gray-400">${translate("noFriendsYet")}</p>`;
                } else {
                    friendsCache.forEach(f => {
                        if (f.status === 'accepted') {
                            const div = document.createElement('div');
                            div.className = 'flex justify-between items-center p-1.5 border-b dark:border-gray-600';
                            div.innerHTML = `
                                <span>${f.friend_username}</span>
                                <button onclick="unfriendUser('${f.friend_username}')" class="text-xs text-red-500 dark:text-red-400 hover:underline">${translate("unfriendButton")}</button>
                            `;
                            myFriendsList.appendChild(div);
                        }
                    });
                }
            } catch (error) { myFriendsList.innerHTML = `<p class="text-red-500 dark:text-red-400 italic">${translate("errorLoadingFriends")}</p>`; }
        }
        async function loadIncomingRequests() { /* ... similar list rendering ... */ }
        async function loadOutgoingRequests() { /* ... similar list rendering ... */ }
        
        async function handleSendFriendRequest() {
            const targetUsername = findUserUsernameInput.value.trim();
            if (!targetUsername) { showStatus(translate("usernameRequired"), 'error', findUsersStatus); return; }
            showStatus(translate("sendingFriendRequestTo", {username: targetUsername}), 'info', findUsersStatus);
            try {
                await apiRequest('/api/friendships/request', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({target_username: targetUsername}), statusElement: findUsersStatus
                });
                showStatus(translate("friendRequestSentSuccess"), 'success', findUsersStatus);
                findUserUsernameInput.value = '';
                await loadOutgoingRequests(); // Refresh outgoing list
            } catch (error) { /* API request shows error */ }
        }
        async function acceptFriendRequest(friendshipId) { /* API call and refresh lists */ }
        async function declineFriendRequest(friendshipId) { /* API call and refresh lists */ }
        async function cancelFriendRequest(friendshipId) { /* API call and refresh lists */ }
        async function unfriendUser(friendUsername) { /* API call and refresh lists */ }

        function populateFriendsModal() {
            loadFriendsAndRequests();
             // Activate first tab by default
            friendsModalTabs[0].click();
        }

        // Add more specific list rendering for incoming/outgoing requests similar to loadMyFriendsList
        // Add event handlers for accept, decline, cancel, unfriend buttons which call the API and refresh lists.

    </script>
</body>
</html>
