<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate-key="document_title">Simplified LoLLMs Chat</title>
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js"></script>
    <link rel="stylesheet" href="/style.css">
</head>
<body>

    <div id="appLoadingMessage" class="fixed inset-0 z-[100] flex flex-col items-center justify-center text-center p-4">
        <img src="/logo.png" alt="Loading LoLLMs" class="h-20 w-20 md:h-24 md:w-24 mx-auto mb-6 animate-pulse" data-translate-alt="logo_alt">
        <p class="text-2xl md:text-3xl font-bold mb-3" data-translate-key="app_loading_title">Loading Application...</p>
        <div class="w-full max-w-xs md:max-w-sm rounded-full h-2.5 mb-2 overflow-hidden">
            <div id="appLoadingProgress" class="h-2.5 rounded-full transition-all duration-300 ease-linear" style="width: 0%"></div>
        </div>
        <p id="appLoadingStatus" class="text-sm md:text-base" data-translate-key="app_loading_status_default">Please wait.</p>
    </div>

    <div id="app-container" class="flex h-screen overflow-hidden" style="display: none;">

        <aside class="w-72 border-r border-gray-700 flex flex-col shadow-lg">
            <div class="p-4 border-b border-gray-700 flex items-center space-x-3">
                 <img src="/logo.png" alt="Logo" class="h-10 w-10 rounded-full shadow" data-translate-alt="logo_alt">
                 <div>
                    <h2 class="text-xl font-semibold text-gray-50" data-translate-key="lollms_chat_title_sidebar">Lollms Chat</h2>
                    <p class="text-xs" data-translate-key="simplified_version_subtitle">Simplified Version</p>
                 </div>
            </div>
            <div class="p-3 border-b border-gray-700">
                <button id="newDiscussionBtn" class="w-full  font-medium py-2.5 px-4 rounded-lg shadow-md hover:shadow-lg transition duration-150 ease-in-out flex items-center justify-center text-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                    <span data-translate-key="new_discussion_btn">New Discussion</span>
                </button>
            </div>
            <div class="p-3 border-b border-gray-700">
                <input type="text" id="discussionSearchInput" data-translate-placeholder="discussion_search_placeholder" placeholder="Search discussions..." class="w-full px-3 py-2 border border-gray-600 rounded-lg text-sm  focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 placeholder-gray-500">
            </div>
            <div id="discussionListContainer" class="flex-1 overflow-y-auto p-2 space-y-1">
                <p class=" text-sm text-center italic p-4" data-translate-key="loading_discussions_placeholder">Loading discussions...</p>
            </div>
            <div class="p-3 border-t border-gray-700">
                <div id="userInfoContainer" class="relative">
                    <button id="userMenuToggleBtn" class="w-full flex items-center justify-between text-sm p-2 rounded-lg transition-colors focus:outline-none">
                        <div class="flex items-center">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center mr-3">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 ">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
                                </svg>
                            </div>
                            <div class="flex flex-col items-start">
                                <span id="usernameDisplay" class="font-medium  text-sm" data-translate-key="username_display_default">...</span>
                                <span id="adminBadge" class="text-xs text-red-400 font-medium" style="display: none;" data-translate-key="admin_badge_text">Administrator</span>
                            </div>
                        </div>
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 transition-transform transform" id="userMenuArrow">
                            <path stroke-linecap="round" stroke-linejoin="round" d="m19.5 8.25-7.5 7.5-7.5-7.5" />
                        </svg>
                    </button>

                    <!-- Dropdown Menu -->
                    <div id="userMenuDropdown" class="absolute bottom-full left-0 right-0 mb-2 w-full border border-gray-600 rounded-lg shadow-xl py-2 z-20" style="display: none;">
                        <div class="px-1">
                            <button id="friendsMessagesBtn" class="w-full flex items-center px-3 py-2 text-sm  rounded-md transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-3">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 0 0 3.741-.479 3 3 0 0 0-4.682-2.72m.243-3.72a9.094 9.094 0 0 1-3.741-.479 3 3 0 0 1-4.682-2.72m.243 3.72a9.094 9.094 0 0 0-3.741-.479 3 3 0 0 0-4.682-2.72M12 12.75a3 3 0 1 1 0-6 3 3 0 0 1 0 6Zm0 0a9.094 9.094 0 0 0-3.741-.479 3 3 0 0 0-4.682-2.72M12 12.75a9.094 9.094 0 0 1 3.741-.479 3 3 0 0 1 4.682-2.72M12 12.75a3 3 0 1 1 0-6 3 3 0 0 1 0 6Zm7.5-3.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Zm-15 0a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                                </svg>
                                <span data-translate-key="friends_messages_btn_text">Friends & Messages</span>
                            </button>
                        </div>
                        <!-- Separator if needed -->
                        <div class="my-1 border-t border-gray-700"></div>                        
                        <!-- Main Menu Items -->
                        <div class="px-1">
                            <button id="settingsBtn" class="w-full flex items-center px-3 py-2 text-sm rounded-md transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-3">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 0 1 0 1.255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.063-.374-.313-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 0 1 0-1.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281Z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
                                </svg>
                                <span data-translate-key="settings_btn_text">Settings</span>
                            </button>

                            <button id="dataStoresBtn" class="w-full flex items-center px-3 py-2 text-sm rounded-md transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-3">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 6.375c0 2.278-3.694 4.125-8.25 4.125S3.75 8.653 3.75 6.375m16.5 0c0-2.278-3.694-4.125-8.25-4.125S3.75 4.097 3.75 6.375m16.5 0v11.25c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125V6.375m16.5 0v3.75m-16.5-3.75v3.75m16.5 0v3.75C20.25 16.153 16.556 18 12 18s-8.25-1.847-8.25-4.125v-3.75m16.5 0c0 2.278-3.694 4.125-8.25 4.125s-8.25-1.847-8.25-4.125" />
                                </svg>
                                <span data-translate-key="data_stores_btn_text">Data Stores</span>
                            </button>

                            <a href="/admin" id="adminLink" class="w-full flex items-center px-3 py-2 text-sm rounded-md transition-colors" style="display: none;">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-3">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-9.75 0h9.75" />
                                </svg>
                                <span data-translate-key="admin_panel_link_text">Admin Panel</span>
                            </a>
                        </div>

                        <!-- Separator -->
                        <div class="my-2 border-t border-gray-700"></div>

                        <!-- Data Management Section -->
                        <div class="px-1">
                            <div class="px-3 py-1">
                                <span class="text-xs font-medium  uppercase tracking-wide">Data Management</span>
                            </div>
                            <div class="flex px-3 py-2 space-x-2">
                                <button id="exportDataBtn" class="flex-1 text-xs   py-2 px-3 rounded-md transition-colors border border-gray-600" data-translate-key="export_data_btn_text">
                                    Export
                                </button>
                                <button id="importDataBtn" class="flex-1 text-xs   py-2 px-3 rounded-md transition-colors border border-gray-600" data-translate-key="import_data_btn_text">
                                    Import
                                </button>
                            </div>
                        </div>

                        <!-- Separator -->
                        <div class="my-2 border-t border-gray-700"></div>

                        <!-- Logout Section -->
                        <div class="px-1">
                            <button id="logoutBtn" class="w-full flex items-center px-3 py-2 text-sm text-red-400 hover:text-red-300 rounded-md transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 mr-3">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15m3 0 3-3m0 0-3-3m3 3H9" />
                                </svg>
                                <span data-translate-key="logout_btn_text">Sign Out</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </aside>

        <main class="flex-1 flex flex-col ">
            <header class=" border-b border-gray-700 p-3 flex items-center justify-between min-h-[65px] shadow-md">
                <h3 id="discussionTitle" class="text-lg font-semibold  truncate px-2" data-translate-key="default_discussion_title">Select or Create a Discussion</h3>
                <div class="flex items-center space-x-3">
                    <div class="rag-controls">
                        <button id="ragToggleBtn" class="rag-toggle rag-toggle-off self-center" data-translate-key="rag_toggle_btn_text" data-translate-title="rag_toggle_btn_title_off">RAG</button>
                        <select id="ragDataStoreSelect" class="text-xs rounded-md border-gray-600 shadow-sm focus:border-blue-500 focus:ring-blue-500  py-1 px-1.5" style="display: none;">
                            <option value="" data-translate-key="rag_select_default_option">Select RAG Data Store</option>
                        </select>
                    </div>
                    <div class="language-controls">
                        <label for="languageSelector" class="sr-only" data-translate-key="language_selector_label_sr">Select Language</label>
                        <select id="languageSelector" class="text-xs rounded-md border-gray-600 shadow-sm focus:border-blue-500 focus:ring-blue-500 py-1.5 px-2"></select>
                    </div>
                    <!-- Dark/Light Mode Toggle -->
                    <div class="theme-toggle-controls">
                        <button id="themeToggleBtn" title="Toggle Dark/Light Mode" class="p-2 rounded-full   transition-colors">
                            <svg id="themeIconSun" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 hidden">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z" />
                            </svg>
                            <svg id="themeIconMoon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 hidden">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.72 9.72 0 0 1 18 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 0 0 3 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 0 0 9.002-5.998Z" />
                            </svg>
                        </button>
                    </div>
                </div>
            </header>

            <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-2">
                <div class="text-center  italic mt-10" data-translate-key="chat_area_empty_placeholder">Select a discussion to start chatting.</div>
            </div>

            <footer class=" border-t border-gray-700 p-3 shadow-inner-top">
                <div id="imageUploadPreviewContainer" class="mb-2" style="display: none;"></div>
               <div class="flex items-end space-x-3">
                   <label for="imageUploadInput" class="p-2.5 rounded-lg  cursor-pointer self-end transition-colors" title="Upload Images">
                       <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 hover:"><path stroke-linecap="round" stroke-linejoin="round" d="m2.25 15.75 5.159-5.159a2.25 2.25 0 0 1 3.182 0l5.159 5.159m-1.5-1.5 1.409-1.409a2.25 2.25 0 0 1 3.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 0 0 1.5-1.5V6a1.5 1.5 0 0 0-1.5-1.5H3.75A1.5 1.5 0 0 0 2.25 6v12a1.5 1.5 0 0 0 1.5 1.5Zm10.5-11.25h.008v.008h-.008V8.25Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" /></svg>
                   </label>
                   <input type="file" id="imageUploadInput" multiple accept="image/*" class="hidden">
                   <textarea id="messageInput" rows="1" class="flex-1 rounded-lg  border-gray-600  shadow-sm focus:border-blue-500 focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 p-2.5 text-sm placeholder-gray-500" data-translate-placeholder="message_input_placeholder" placeholder="Type your message... (Shift+Enter for new line)" style="resize: none; overflow-y: hidden;"></textarea>
                   <button id="sendMessageBtn" class="font-medium py-2.5 px-4 rounded-lg shadow-md hover:shadow-lg transition duration-150 ease-in-out self-end disabled:opacity-60 disabled:cursor-not-allowed" disabled title="Send Message">
                       <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5" /></svg>
                   </button>
                   <button id="stopGenerationBtn" class="bg-red-600 hover:bg-red-700 font-medium py-2.5 px-4 rounded-lg shadow-md hover:shadow-lg transition duration-150 ease-in-out self-end" style="display: none;" title="Stop Generation">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M5.25 7.5A2.25 2.25 0 0 1 7.5 5.25h9a2.25 2.25 0 0 1 2.25 2.25v9a2.25 2.25 0 0 1-2.25 2.25h-9a2.25 2.25 0 0 1-2.25-2.25v-9Z" /></svg>
                   </button>
               </div>
               <div id="statusMessage" class="text-xs  mt-1.5 h-4 text-center"></div>
               <div id="pyodideStatus" class="text-xs text-blue-400 mt-1 h-4 text-center"></div>
           </footer>
        </main>
    </div>

    <div id="modalsContainer">
        <div id="sendPersonalityModal" class="modal">
            <div class="modal-content">
                <button class="modal-close-btn" onclick="closeModal('sendPersonalityModal')">X</button>
                <div class="modal-header"><h3 id="sendPersonalityModalTitle" class="modal-title">Send Personality</h3></div>
                <div class="modal-body py-4">
                    <label for="sendPersonalityTargetUsername" class="block text-sm font-medium mb-1">Send to Friend (Username):</label>
                    <input type="text" id="sendPersonalityTargetUsername" class="input-field w-full" placeholder="Enter friend's username">
                    <!-- Optional: Dropdown of friends -->
                    <div id="sendPersonalityStatus" class="text-xs text-red-400 mt-1 h-4"></div>
                    <input type="hidden" id="sendPersonalityIdInput">
                </div>
                <div class="modal-footer">
                    <button onclick="closeModal('sendPersonalityModal')" class="btn btn-secondary">Cancel</button>
                    <button id="confirmSendPersonalityBtn" class="btn btn-primary">Send Personality</button>
                </div>
            </div>
        </div>        
        <div id="friendsMessagesModal" class="modal">
            <div class="modal-content bg-gray-800 text-gray-200 shadow-xl rounded-lg" style="max-width: 700px; display: flex; flex-direction: column; max-height: 80vh;">
                <div class="modal-header border-b border-gray-700 flex-shrink-0">
                    <h3 class="modal-title text-lg font-semibold" data-translate-key="friends_messages_modal_title">Friends & Messages</h3>
                    <button class="modal-close-btn text-gray-400 absolute top-3 right-3" onclick="closeModal('friendsMessagesModal')">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" /></svg>
                    </button>
                </div>

                <nav class="flex border-b border-gray-700 flex-shrink-0">
                    <button data-tab="friendsListTab" class="friends-messages-tab-btn active-tab flex-1 py-3 px-4 text-sm font-medium text-center" data-translate-key="friends_tab_list">My Friends</button>
                    <button data-tab="friendRequestsTab" class="friends-messages-tab-btn flex-1 py-3 px-4 text-sm font-medium text-center relative" data-translate-key="friends_tab_requests">
                        Friend Requests
                        <span id="friendRequestsBadge" class="absolute top-1 right-2 bg-red-500 text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                    </button>
                    <button data-tab="directMessagesTab" class="friends-messages-tab-btn flex-1 py-3 px-4 text-sm font-medium text-center" data-translate-key="friends_tab_messages">Messages</button>
                </nav>

                <div class="modal-body overflow-y-auto flex-grow p-4 space-y-4">
                    <!-- Friends List Tab Content -->
                    <div id="friendsListTab" class="friends-messages-tab-content">
                        <div class="mb-4">
                            <label for="addFriendInput" class="sr-only" data-translate-key="add_friend_label_sr">Add Friend by Username</label>
                            <div class="flex space-x-2">
                                <input type="text" id="addFriendInput" class="input-field flex-grow" data-translate-placeholder="add_friend_placeholder" placeholder="Enter username to add friend...">
                                <button id="sendFriendRequestBtn" class="btn btn-primary whitespace-nowrap" data-translate-key="add_friend_btn">Send Request</button>
                            </div>
                            <div id="addFriendStatus" class="text-sm h-4 mt-1"></div>
                        </div>
                        <h4 class="text-md font-semibold mb-2" data-translate-key="friends_list_header">Your Friends</h4>
                        <div id="friendsListContainerFM" class="space-y-2"> <!-- FM for Friends Modal -->
                            <!-- Friend items will be populated here -->
                            <p class="italic text-sm text-gray-400" data-translate-key="loading_friends_list">Loading friends...</p>
                        </div>
                    </div>

                    <!-- Friend Requests Tab Content -->
                    <div id="friendRequestsTab" class="friends-messages-tab-content" style="display: none;">
                        <h4 class="text-md font-semibold mb-2" data-translate-key="pending_requests_header">Pending Friend Requests</h4>
                        <div id="pendingRequestsContainer" class="space-y-2">
                            <!-- Pending requests will be populated here -->
                            <p class="italic text-sm text-gray-400" data-translate-key="loading_pending_requests">Loading requests...</p>
                        </div>
                    </div>

                    <!-- Direct Messages Tab Content (Placeholder) -->
                    <!-- Inside #friendsMessagesModal -> #directMessagesTab -->
                    <div id="directMessagesTab" class="friends-messages-tab-content h-full flex flex-col" style="display: none;"> <!-- Added h-full flex flex-col -->
                        <div class="flex-shrink-0 mb-3">
                            <input type="text" id="dmSearchUsersInput" class="input-field w-full" data-translate-placeholder="dm_search_user_placeholder" placeholder="Search users or start new DM...">
                            <div id="dmSearchResults" class="absolute z-10 w-full bg-gray-700 border border-gray-600 rounded-md shadow-lg max-h-40 overflow-y-auto mt-1 hidden">
                                <!-- Search results will appear here -->
                            </div>
                        </div>

                        <h4 class="text-md font-semibold mb-2 flex-shrink-0" data-translate-key="direct_messages_conversations_header">Conversations</h4>
                        <div id="dmConversationsList" class="space-y-1 overflow-y-auto flex-grow mb-3 border border-gray-700 rounded-md p-2">
                            <p class="italic text-sm text-gray-400" data-translate-key="dm_loading_conversations">Loading conversations...</p>
                        </div>

                        <!-- DM Chat Area (Initially hidden or shows placeholder) -->
                        <div id="dmChatArea" class="flex-grow flex flex-col border border-gray-700 rounded-md hidden">
                            <div id="dmChatHeader" class="p-2 border-b border-gray-700 bg-gray-750 text-sm font-semibold flex-shrink-0">
                                <!-- Chatting with User X -->
                            </div>
                            <div id="dmChatMessages" class="flex-grow overflow-y-auto p-3 space-y-2 bg-gray-850">
                                <!-- DM messages will appear here -->
                                <p class="italic text-sm text-gray-500 text-center py-10" data-translate-key="dm_select_conversation_placeholder">Select a conversation to view messages.</p>
                            </div>
                            <div id="dmChatInputContainer" class="p-2 border-t border-gray-700 flex-shrink-0">
                                <div class="flex items-center space-x-2">
                                    <input type="text" id="directMessageInput" class="input-field flex-grow" data-translate-placeholder="dm_type_message_placeholder" placeholder="Type a message...">
                                    <button id="sendDirectMessageBtn" class="btn btn-primary" data-translate-key="send_btn">Send</button>
                                </div>
                                <div id="dmSendStatus" class="text-xs h-4 mt-1 text-center"></div>
                            </div>
                        </div>
                        <div id="dmNoConversationSelected" class="flex-grow flex items-center justify-center">
                            <p class="italic text-sm text-gray-500" data-translate-key="dm_select_or_start_conversation">Select a conversation or search to start a new one.</p>
                        </div>
                    </div>
                </div>

                <div class="modal-footer border-t border-gray-700 flex-shrink-0">
                    <button onclick="closeModal('friendsMessagesModal')" class="btn btn-secondary" data-translate-key="close_btn">Close</button>
                </div>
            </div>
        </div>

        <div id="loginModal" class="modal"><div class="modal-content">
            <div class="modal-header"><h3 class="modal-title" data-translate-key="login_modal_title">Login Required</h3></div>
            <div class="modal-body space-y-4 py-4">
                <img src="/logo.png" alt="Logo" class="h-16 mx-auto mb-4" data-translate-alt="logo_alt">
                <div>
                    <label for="loginUsername" class="block text-sm font-medium  mb-1" data-translate-key="login_username_label">Username</label>
                    <input type="text" id="loginUsername" class="w-full sm:text-sm" data-translate-placeholder="login_username_placeholder" placeholder="Enter your username">
                </div>
                <div>
                    <label for="loginPassword" class="block text-sm font-medium  mb-1" data-translate-key="login_password_label">Password</label>
                    <input type="password" id="loginPassword" class="w-full sm:text-sm" data-translate-placeholder="login_password_placeholder" placeholder="Enter your password">
                </div>
                <div id="loginStatus" class="text-xs text-red-400 mt-1 h-4"></div>
            </div>
            <div class="modal-footer">
                <button id="loginSubmitBtn" class="w-full px-4 py-2 text-sm font-medium rounded-md  focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-blue-500" data-translate-key="login_submit_btn">Login</button>
            </div>
        </div></div>
        <div id="renameModal" class="modal"><div class="modal-content">
            <button class="modal-close-btn" onclick="closeModal('renameModal')"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" /></svg></button>
            <div class="modal-header"><h3 class="modal-title" data-translate-key="rename_modal_title">Rename Discussion</h3></div>
            <div class="modal-body py-4">
                <label for="renameInput" class="block text-sm font-medium  mb-1" data-translate-key="rename_input_label">New discussion title:</label>
                <input type="text" id="renameInput" class="w-full sm:text-sm" data-translate-placeholder="rename_input_placeholder" placeholder="Enter new title">
                <div id="renameStatus" class="text-xs text-red-400 mt-1 h-4"></div>
                <input type="hidden" id="renameDiscussionIdInput">
            </div>
            <div class="modal-footer">
                <button onclick="closeModal('renameModal')" class="px-4 py-2   text-sm font-medium rounded-md " data-translate-key="cancel_btn">Cancel</button>
                <button id="confirmRenameBtn" class="px-4 py-2 text-sm font-medium rounded-md " data-translate-key="rename_btn">Rename</button>
            </div>
        </div></div>
        <div id="sendDiscussionModal" class="modal"><div class="modal-content">
            <button class="modal-close-btn" onclick="closeModal('sendDiscussionModal')"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" /></svg></button>
            <div class="modal-header"><h3 class="modal-title" data-translate-key="send_discussion_modal_title_default">Send Discussion</h3></div>
            <div class="modal-body py-4">
                <label for="sendTargetUsername" class="block text-sm font-medium  mb-1" data-translate-key="send_discussion_target_user_label">Target Username:</label>
                <input type="text" id="sendTargetUsername" class="w-full sm:text-sm" data-translate-placeholder="send_discussion_target_user_placeholder" placeholder="Enter username of recipient">
                <div id="sendDiscussionStatus" class="text-xs text-red-400 mt-1 h-4"></div>
                <input type="hidden" id="sendDiscussionIdInput">
            </div>
            <div class="modal-footer">
                <button onclick="closeModal('sendDiscussionModal')" class="px-4 py-2   text-sm font-medium rounded-md " data-translate-key="cancel_btn">Cancel</button>
                <button id="confirmSendDiscussionBtn" class="px-4 py-2 text-sm font-medium rounded-md " data-translate-key="send_btn">Send</button>
            </div>
        </div></div>
        <div id="editMessageModal" class="modal"><div class="modal-content">
            <button class="modal-close-btn" onclick="closeModal('editMessageModal')"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" /></svg></button>
            <div class="modal-header"><h3 class="modal-title" data-translate-key="edit_message_modal_title">Edit Message</h3></div>
            <div class="modal-body py-4">
                <label for="editMessageInput" class="block text-sm font-medium  mb-1" data-translate-key="edit_message_input_label">Message content:</label>
                <textarea id="editMessageInput" rows="5" class="w-full sm:text-sm"></textarea>
                <div id="editMessageStatus" class="text-xs text-red-400 mt-1 h-4"></div>
                <input type="hidden" id="editMessageIdInput">
            </div>
            <div class="modal-footer">
                <button onclick="closeModal('editMessageModal')" class="px-4 py-2   text-sm font-medium rounded-md " data-translate-key="cancel_btn">Cancel</button>
                <button id="confirmEditMessageBtn" class="px-4 py-2 text-sm font-medium rounded-md " data-translate-key="save_changes_btn">Save Changes</button>
            </div>
        </div></div>
        <div id="exportModal" class="modal"><div class="modal-content">
             <button class="modal-close-btn" onclick="closeModal('exportModal')"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" /></svg></button>
             <div class="modal-header"><h3 class="modal-title" data-translate-key="export_modal_title">Export Data</h3></div>
             <div class="modal-body py-4">
                 <p class="text-sm mb-3" data-translate-key="export_modal_description">Select discussions to export (leave all unchecked to export all):</p>
                 <div id="exportDiscussionList" class="max-h-60 overflow-y-auto border border-gray-700 rounded p-3 space-y-2 ">
                     <p class=" italic" data-translate-key="loading_discussions_placeholder">Loading discussions...</p>
                 </div>
             </div>
             <div class="modal-footer">
                 <button onclick="closeModal('exportModal')" class="px-4 py-2   text-sm font-medium rounded-md " data-translate-key="cancel_btn">Cancel</button>
                 <button id="confirmExportBtn" class="px-4 py-2 bg-green-600  text-sm font-medium rounded-md hover:bg-green-700" data-translate-key="export_selected_btn">Export Selected</button>
             </div>
        </div></div>
         <div id="importModal" class="modal"><div class="modal-content">
            <button class="modal-close-btn" onclick="closeModal('importModal')"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" /></svg></button>
            <div class="modal-header"><h3 class="modal-title" data-translate-key="import_modal_title">Import Discussions</h3></div>
            <div class="modal-body py-4">
                <div class="mb-4">
                    <label for="importFile" class="block text-sm font-medium  mb-1" data-translate-key="import_file_label">Select Exported JSON File (.json):</label>
                    <input type="file" id="importFile" accept=".json" class="block w-full text-sm file:mr-4 file:py-1.5 file:px-3 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-700 file:text-blue-100 hover:file: border border-gray-600 rounded-md cursor-pointer"/>
                </div>
                <div id="importPreviewArea" class="mb-4" style="display: none;">
                    <p class="text-sm mb-2" data-translate-key="import_preview_description">Select discussions to import from the file:</p>
                     <div id="importDiscussionList" class="max-h-60 overflow-y-auto border border-gray-700 rounded p-3 space-y-2 "></div>
                </div>
                <p id="importStatus" class="text-sm text-red-400 h-4"></p>
            </div>
            <div class="modal-footer">
                <button onclick="closeModal('importModal')" class="px-4 py-2   text-sm font-medium rounded-md " data-translate-key="cancel_btn">Cancel</button>
                <button id="confirmImportBtn" class="px-4 py-2 bg-green-600  text-sm font-medium rounded-md hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed" data-translate-key="import_selected_btn" disabled>Import Selected</button>
            </div>
        </div></div>
        <div id="settingsModal" class="modal"><div class="modal-content">
            <button class="modal-close-btn" onclick="closeModal('settingsModal')"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" /></svg></button>
            <div class="modal-header">
                <h3 class="modal-title" data-translate-key="settings_modal_title">User Settings</h3>
            </div>
            <div class="modal-body flex flex-row flex-grow overflow-hidden">
                <nav class="w-52 border-r border-gray-700 pr-3 mr-3 py-3 space-y-1 flex-shrink-0 overflow-y-auto">
                    <button data-tab="llmConfigTab" class="settings-tab-btn active-tab w-full text-left px-3 py-2 rounded-md text-sm font-medium" data-translate-key="settings_tab_llm_config">LLM Configuration</button>
                    <button data-tab="llmParamsTab" class="settings-tab-btn w-full text-left px-3 py-2 rounded-md text-sm font-medium" data-translate-key="settings_tab_llm_params">LLM Parameters</button>
                    <button data-tab="accountTab" class="settings-tab-btn w-full text-left px-3 py-2 rounded-md text-sm font-medium" data-translate-key="settings_tab_account">Account Settings</button>
                    <button data-tab="profileTab" class="settings-tab-btn w-full text-left px-3 py-2 rounded-md text-sm font-medium" data-translate-key="settings_tab_profile">User Profile</button>
                    <button data-tab="personalitiesTab" class="settings-tab-btn w-full text-left px-3 py-2 rounded-md text-sm font-medium" data-translate-key="settings_tab_personalities">Personalities</button>
                    <button data-tab="ragParamsTab" class="settings-tab-btn w-full text-left px-3 py-2 rounded-md text-sm font-medium" data-translate-key="settings_tab_rag_params">RAG Parameters</button>                    
                </nav>
                <div class="flex-grow overflow-y-auto pl-3 py-3 pr-1">
                    <div id="llmConfigTab" class="settings-tab-content"><div class="space-y-3">
                        <h4 class="text-md font-semibold  mb-1" data-translate-key="settings_llm_config_model_header">Default LLM Model</h4>
                        <div>
                            <select id="settingsLollmsModelSelect" class="block w-full rounded-md sm:text-sm">
                                <option data-translate-key="settings_llm_models_loading">Loading models...</option>
                            </select>
                        </div>
                        <div class="text-right">
                             <button id="saveModelAndVectorizerBtn" class="px-3 py-1.5   text-sm font-medium rounded-md  disabled:opacity-50" data-translate-key="settings_llm_config_save_model_btn">Save Model</button>
                        </div>
                        <div id="settingsStatus_llmConfig" class="text-sm h-4"></div>
                    </div></div>
                    <div id="llmParamsTab" class="settings-tab-content" style="display: none;"><div class="space-y-4">
                        <h4 class="text-md font-semibold  mb-1" data-translate-key="settings_llm_params_header">LLM Generation Parameters</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="settingsTemperature" class="block text-sm font-medium " data-translate-key="settings_llm_param_temp_label">Temperature</label>
                                <input type="number" id="settingsTemperature" step="0.01" min="0" max="2" class="mt-1 block w-full sm:text-sm" placeholder="e.g., 0.7">
                            </div>
                            <div>
                                <label for="settingsTopK" class="block text-sm font-medium " data-translate-key="settings_llm_param_topk_label">Top K</label>
                                <input type="number" id="settingsTopK" step="1" min="1" class="mt-1 block w-full sm:text-sm" placeholder="e.g., 50">
                            </div>
                            <div>
                                <label for="settingsTopP" class="block text-sm font-medium " data-translate-key="settings_llm_param_topp_label">Top P</label>
                                <input type="number" id="settingsTopP" step="0.01" min="0" max="1" class="mt-1 block w-full sm:text-sm" placeholder="e.g., 0.95">
                            </div>
                            <div>
                                <label for="settingsRepeatPenalty" class="block text-sm font-medium " data-translate-key="settings_llm_param_repeatpenalty_label">Repeat Penalty</label>
                                <input type="number" id="settingsRepeatPenalty" step="0.01" min="0" class="mt-1 block w-full sm:text-sm" placeholder="e.g., 1.1">
                            </div>
                            <div>
                                <label for="settingsRepeatLastN" class="block text-sm font-medium " data-translate-key="settings_llm_param_repeatlastn_label">Repeat Last N</label>
                                <input type="number" id="settingsRepeatLastN" step="1" min="0" class="mt-1 block w-full sm:text-sm" placeholder="e.g., 64">
                            </div>
                        </div>
                        <div class="text-right">
                            <button id="saveLLMParamsBtn" class="px-3 py-1.5   text-sm font-medium rounded-md  disabled:opacity-50" data-translate-key="settings_llm_params_save_btn">Save LLM Parameters</button>
                        </div>
                        <div id="settingsStatus_llmParams" class="text-sm h-4"></div>
                    </div></div>
                    <div id="accountTab" class="settings-tab-content" style="display: none;"><div class="space-y-3">
                        <h4 class="text-md font-semibold  mb-1" data-translate-key="settings_account_change_pwd_header">Change Password</h4>
                        <div>
                            <label for="settingsCurrentPassword" class="block text-sm font-medium " data-translate-key="settings_account_current_pwd_label">Current Password</label>
                            <input type="password" id="settingsCurrentPassword" autocomplete="current-password" class="mt-1 block w-full sm:text-sm" data-translate-placeholder="settings_account_current_pwd_placeholder" placeholder="Enter current password">
                        </div>
                        <div>
                            <label for="settingsNewPassword" class="block text-sm font-medium " data-translate-key="settings_account_new_pwd_label">New Password</label>
                            <input type="password" id="settingsNewPassword" autocomplete="new-password" class="mt-1 block w-full sm:text-sm" data-translate-placeholder="settings_account_new_pwd_placeholder" placeholder="Enter new password (min 8 characters)">
                        </div>
                        <div>
                            <label for="settingsConfirmPassword" class="block text-sm font-medium " data-translate-key="settings_account_confirm_pwd_label">Confirm New Password</label>
                            <input type="password" id="settingsConfirmPassword" autocomplete="new-password" class="mt-1 block w-full sm:text-sm" data-translate-placeholder="settings_account_confirm_pwd_placeholder" placeholder="Confirm new password">
                        </div>
                        <div class="text-right">
                            <button id="changePasswordBtn" class="px-3 py-1.5 bg-orange-600  text-sm font-medium rounded-md hover:bg-orange-700 disabled:opacity-50" data-translate-key="settings_account_change_pwd_btn" disabled>Change Password</button>
                        </div>
                        <div id="passwordChangeStatus" class="text-sm h-4"></div>
                    </div></div>
                    <!-- Profile Tab -->
                    <div id="profileTab" class="settings-tab-content" style="display: none;"><div class="space-y-4">
                        <h4 class="text-md font-semibold mb-1" data-translate-key="settings_profile_header">User Profile</h4>
                        <div>
                            <label for="settingsFirstName" class="block text-sm font-medium" data-translate-key="settings_profile_firstname_label">First Name</label>
                            <input type="text" id="settingsFirstName" class="mt-1 block w-full sm:text-sm" placeholder="Optional">
                        </div>
                        <div>
                            <label for="settingsFamilyName" class="block text-sm font-medium" data-translate-key="settings_profile_familyname_label">Family Name</label>
                            <input type="text" id="settingsFamilyName" class="mt-1 block w-full sm:text-sm" placeholder="Optional">
                        </div>
                        <div>
                            <label for="settingsEmail" class="block text-sm font-medium" data-translate-key="settings_profile_email_label">Email</label>
                            <input type="email" id="settingsEmail" class="mt-1 block w-full sm:text-sm" placeholder="Optional">
                        </div>
                        <div>
                            <label for="settingsBirthDate" class="block text-sm font-medium" data-translate-key="settings_profile_birthdate_label">Birth Date</label>
                            <input type="date" id="settingsBirthDate" class="mt-1 block w-full sm:text-sm">
                        </div>
                        <div class="text-right">
                            <button id="saveProfileBtn" class="px-3 py-1.5  text-sm font-medium rounded-md disabled:opacity-50" data-translate-key="settings_profile_save_btn">Save Profile</button>
                        </div>
                        <div id="settingsStatus_profile" class="text-sm h-4"></div>
                    </div></div>

                    <!-- Personalities Tab -->
                    <div id="personalitiesTab" class="settings-tab-content" style="display: none;"><div class="space-y-4">
                        <h4 class="text-md font-semibold mb-1" data-translate-key="settings_personalities_header">Personalities</h4>
                        <div>
                            <label for="settingsActivePersonality" class="block text-sm font-medium" data-translate-key="settings_personalities_active_label">Active Personality</label>
                            <select id="settingsActivePersonality" class="mt-1 block w-full sm:text-sm">
                                <option value="" data-translate-key="settings_personalities_none_active">None (Default)</option>
                                <!-- Options populated by JS -->
                            </select>
                        </div>
                        <div class="mt-4">
                            <h5 class="text-sm font-medium mb-2" data-translate-key="settings_personalities_manage_header">Manage Your Personalities</h5>
                            <div id="userPersonalitiesList" class="max-h-40 overflow-y-auto border border-gray-700 rounded p-2 space-y-1 mb-2">
                                <!-- User's personalities listed here -->
                            </div>
                            <button id="createNewPersonalityBtn" class="text-sm text-blue-400 hover:text-blue-300" data-translate-key="settings_personalities_create_new_btn">+ Create New Personality</button>
                        </div>
                        <div class="mt-4">
                            <h5 class="text-sm font-medium mb-2" data-translate-key="settings_personalities_public_header">Available Public Personalities</h5>
                            <div id="publicPersonalitiesList" class="max-h-40 overflow-y-auto border border-gray-700 rounded p-2 space-y-1">
                                <!-- Public personalities listed here -->
                            </div>
                        </div>
                        <div class="text-right">
                            <button id="saveActivePersonalityBtn" class="px-3 py-1.5  text-sm font-medium rounded-md disabled:opacity-50" data-translate-key="settings_personalities_save_active_btn">Save Active Personality</button>
                        </div>
                        <div id="settingsStatus_personalities" class="text-sm h-4"></div>
                    </div></div>
                    <!-- Personality Editor Modal (Separate Modal) -->
                    <div id="personalityEditorModal" class="modal">
                        <div class="modal-content bg-gray-800 text-gray-200 shadow-xl rounded-lg" style="max-width: 550px; display: flex; flex-direction: column; max-height: 85vh;"> <!-- Adjusted max-width, flex column, max-height -->
                            <div class="modal-header border-b border-gray-700 flex-shrink-0"> <!-- flex-shrink-0 for header -->
                                <h3 id="personalityEditorTitle" class="modal-title text-lg font-semibold" data-translate-key="personality_editor_title_create">Create New Personality</h3>
                                <button class="modal-close-btn text-gray-400 absolute top-3 right-3" onclick="closeModal('personalityEditorModal')">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" /></svg>
                                </button>
                            </div>

                            <div class="modal-body py-4 px-6 space-y-4 overflow-y-auto flex-grow"> <!-- Added overflow-y-auto and flex-grow -->
                                <input type="hidden" id="personalityEditorId">

                                <div>
                                    <label for="personalityName" class="block text-sm font-medium text-gray-300" data-translate-key="personality_editor_name_label">Name*</label>
                                    <input type="text" id="personalityName" required class="input-field mt-1 w-full" data-translate-placeholder="personality_editor_name_placeholder" placeholder="e.g., Creative Writer">
                                </div>

                                <div>
                                    <label for="personalityCategory" class="block text-sm font-medium text-gray-300" data-translate-key="personality_editor_category_label">Category</label>
                                    <input type="text" id="personalityCategory" class="input-field mt-1 w-full" data-translate-placeholder="personality_editor_category_placeholder" placeholder="e.g., Writing, Coding, Fun">
                                </div>

                                <div>
                                    <label for="personalityAuthor" class="block text-sm font-medium text-gray-300" data-translate-key="personality_editor_author_label">Author</label>
                                    <input type="text" id="personalityAuthor" class="input-field mt-1 w-full" data-translate-placeholder="personality_editor_author_placeholder" placeholder="Your name or organization">
                                </div>
                                
                                <div>
                                    <label for="personalityIconUpload" class="block text-sm font-medium text-gray-300" data-translate-key="personality_editor_icon_label">Icon (Image)</label>
                                    <input type="file" id="personalityIconUpload" accept="image/png, image/jpeg, image/webp, image/gif" class="input-file mt-1 block w-full text-sm">
                                    <div class="mt-2">
                                        <img id="personalityIconPreview" src="#" alt="Icon Preview" class="h-20 w-20 object-cover rounded-md border border-gray-600 hidden bg-gray-700" data-translate-alt="personality_icon_preview_alt">
                                        <input type="hidden" id="personalityIconBase64">
                                    </div>
                                </div>

                                <div>
                                    <label for="personalityDescription" class="block text-sm font-medium text-gray-300" data-translate-key="personality_editor_description_label">Description</label>
                                    <textarea id="personalityDescription" rows="3" class="input-field mt-1 w-full" data-translate-placeholder="personality_editor_description_placeholder" placeholder="Briefly describe this personality's purpose and style..."></textarea>
                                </div>

                                <div>
                                    <label for="personalityPromptText" class="block text-sm font-medium text-gray-300" data-translate-key="personality_editor_prompt_label">System Prompt*</label>
                                    <textarea id="personalityPromptText" rows="8" required class="input-field mt-1 w-full font-mono text-sm" data-translate-placeholder="personality_editor_prompt_placeholder" placeholder="Enter the core instructions, role, and context for the AI..."></textarea>
                                </div>
                                
                                <div>
                                    <label for="personalityDisclaimer" class="block text-sm font-medium text-gray-300" data-translate-key="personality_editor_disclaimer_label">Disclaimer</label>
                                    <textarea id="personalityDisclaimer" rows="3" class="input-field mt-1 w-full" data-translate-placeholder="personality_editor_disclaimer_placeholder" placeholder="Optional warnings, limitations, or disclaimers for users..."></textarea>
                                </div>

                                <div>
                                    <label for="personalityScriptCode" class="block text-sm font-medium text-gray-300" data-translate-key="personality_editor_script_label">Script Code (Python)</label>
                                    <textarea id="personalityScriptCode" rows="5" class="input-field mt-1 w-full font-mono text-sm" data-translate-placeholder="personality_editor_script_placeholder" placeholder="Optional Python script to be executed with the personality..."></textarea>
                                </div>
                            </div>

                            <div class="modal-footer border-t border-gray-700 flex-shrink-0"> <!-- flex-shrink-0 for footer -->
                                <button onclick="closeModal('personalityEditorModal')" class="btn btn-secondary" data-translate-key="cancel_btn">Cancel</button>
                                <button id="savePersonalityBtn" class="btn btn-primary" data-translate-key="save_personality_btn">Save Personality</button>
                            </div>
                            <div id="personalityEditorStatus" class="text-sm h-4 text-center py-2 bg-gray-800 flex-shrink-0"></div> <!-- Status also flex-shrink-0 -->
                        </div>
                    </div>


                    <!-- LLM Params Tab (Update) -->
                    <div id="llmParamsTab" class="settings-tab-content" style="display: none;"><div class="space-y-4">
                        <h4 class="text-md font-semibold mb-1" data-translate-key="settings_llm_params_header">LLM Generation Parameters</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Existing params: Temperature, TopK, TopP, RepeatPenalty, RepeatLastN -->
                            <div>
                                <label for="settingsTemperature" class="block text-sm font-medium" data-translate-key="settings_llm_param_temp_label">Temperature</label>
                                <input type="number" id="settingsTemperature" step="0.01" min="0" max="2" class="mt-1 block w-full sm:text-sm" placeholder="e.g., 0.7">
                            </div>
                            <div>
                                <label for="settingsTopK" class="block text-sm font-medium" data-translate-key="settings_llm_param_topk_label">Top K</label>
                                <input type="number" id="settingsTopK" step="1" min="1" class="mt-1 block w-full sm:text-sm" placeholder="e.g., 50">
                            </div>
                            <div>
                                <label for="settingsTopP" class="block text-sm font-medium" data-translate-key="settings_llm_param_topp_label">Top P</label>
                                <input type="number" id="settingsTopP" step="0.01" min="0" max="1" class="mt-1 block w-full sm:text-sm" placeholder="e.g., 0.95">
                            </div>
                            <div>
                                <label for="settingsRepeatPenalty" class="block text-sm font-medium" data-translate-key="settings_llm_param_repeatpenalty_label">Repeat Penalty</label>
                                <input type="number" id="settingsRepeatPenalty" step="0.01" min="0" class="mt-1 block w-full sm:text-sm" placeholder="e.g., 1.1">
                            </div>
                            <div>
                                <label for="settingsRepeatLastN" class="block text-sm font-medium" data-translate-key="settings_llm_param_repeatlastn_label">Repeat Last N</label>
                                <input type="number" id="settingsRepeatLastN" step="1" min="0" class="mt-1 block w-full sm:text-sm" placeholder="e.g., 64">
                            </div>
                            <div class="md:col-span-2"> <!-- Spans two columns or single on small screens -->
                                <label for="settingsPutThoughts" class="flex items-center">
                                    <input type="checkbox" id="settingsPutThoughts" class="h-4 w-4 rounded border-gray-600 text-blue-500 bg-gray-700 shadow-sm focus:border-blue-500 focus:ring-2 focus:ring-offset-0 focus:ring-blue-500 focus:ring-opacity-50">
                                    <span class="ml-2 text-sm" data-translate-key="settings_llm_param_put_thoughts_label">Put Thoughts in Context (<code class="text-xs"><think></code> blocks)</span>
                                </label>
                            </div>
                        </div>
                        <div class="text-right">
                            <button id="saveLLMParamsBtn" class="px-3 py-1.5  text-sm font-medium rounded-md disabled:opacity-50" data-translate-key="settings_llm_params_save_btn">Save LLM Parameters</button>
                        </div>
                        <div id="settingsStatus_llmParams" class="text-sm h-4"></div>
                    </div></div>

                    <!-- RAG Params Tab -->
                    <div id="ragParamsTab" class="settings-tab-content" style="display: none;"><div class="space-y-4">
                        <h4 class="text-md font-semibold mb-1" data-translate-key="settings_rag_params_header">RAG Parameters</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="settingsRagTopK" class="block text-sm font-medium" data-translate-key="settings_rag_param_topk_label">RAG Top K</label>
                                <input type="number" id="settingsRagTopK" step="1" min="1" class="mt-1 block w-full sm:text-sm" placeholder="e.g., 5">
                            </div>
                            <div> <!-- This is where the vectorizer select should go -->
                                <label for="settingsDefaultVectorizer" class="block text-sm font-medium" data-translate-key="settings_rag_param_default_vectorizer_label">Default Vectorizer</label>
                                <select id="settingsDefaultVectorizer" class="mt-1 block w-full sm:text-sm">
                                    <option value="" data-translate-key="settings_vectorizer_loading">Loading vectorizers...</option>
                                </select>
                            </div>
                            <div>
                                <label for="settingsRagGraphResponseType" class="block text-sm font-medium" data-translate-key="settings_rag_param_graph_response_type_label">Graph Response Type</label>
                                <select id="settingsRagGraphResponseType" class="mt-1 block w-full sm:text-sm">
                                    <option value="chunks_summary" data-translate-key="settings_rag_graph_resp_chunks_summary">Chunks Summary</option>
                                    <option value="graph_only" data-translate-key="settings_rag_graph_resp_graph_only">Graph Only</option>
                                    <option value="full" data-translate-key="settings_rag_graph_resp_full">Full Response</option>
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <label for="settingsRagUseGraph" class="flex items-center">
                                    <input type="checkbox" id="settingsRagUseGraph" class="h-4 w-4 rounded border-gray-600 text-blue-500 bg-gray-700 shadow-sm focus:border-blue-500 focus:ring-2 focus:ring-offset-0 focus:ring-blue-500 focus:ring-opacity-50">
                                    <span class="ml-2 text-sm" data-translate-key="settings_rag_param_use_graph_label">Use Graph for RAG (if available)</span>
                                </label>
                            </div>
                        </div>
                        <div class="text-right">
                            <button id="saveRagParamsBtn" class="px-3 py-1.5  text-sm font-medium rounded-md disabled:opacity-50" data-translate-key="settings_rag_params_save_btn">Save RAG Parameters</button>
                        </div>
                        <div id="settingsStatus_ragParams" class="text-sm h-4"></div>
                    </div></div>              
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeModal('settingsModal')" class="px-4 py-2   text-sm font-medium rounded-md " data-translate-key="close_btn">Close</button>
            </div>
        </div></div>
        <div id="dataStoresModal" class="modal"><div class="modal-content">
            <button class="modal-close-btn" onclick="closeModal('dataStoresModal')"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" /></svg></button>
            <div class="modal-header"><h3 class="modal-title" data-translate-key="datastores_modal_title">Manage Data Stores (RAG)</h3></div>
            <div class="modal-body space-y-6 py-4">
                <section class="border border-gray-700 rounded-md p-4">
                    <h4 class="text-md font-medium  mb-3" data-translate-key="datastores_create_header">Create New Data Store</h4>
                    <form id="createDataStoreForm" class="space-y-3">
                        <div>
                            <label for="newDataStoreName" class="block text-sm font-medium " data-translate-key="datastores_name_label">Name</label>
                            <input type="text" id="newDataStoreName" required minlength="3" maxlength="100" class="mt-1 block w-full sm:text-sm">
                        </div>
                        <div>
                            <label for="newDataStoreDescription" class="block text-sm font-medium " data-translate-key="datastores_description_label">Description (Optional)</label>
                            <textarea id="newDataStoreDescription" rows="2" maxlength="500" class="mt-1 block w-full sm:text-sm"></textarea>
                        </div>
                        <div class="text-right">
                            <button type="submit" class="px-4 py-2 bg-green-600  text-sm font-medium rounded-md hover:bg-green-700" data-translate-key="datastores_create_btn">Create Store</button>
                        </div>
                    </form>
                    <div id="createDataStoreStatus" class="text-sm h-4 mt-2"></div>
                </section>
                <section>
                    <h4 class="text-md font-medium  mb-2" data-translate-key="datastores_owned_header">Your Data Stores</h4>
                    <div id="ownedDataStoresList" class="max-h-48 overflow-y-auto space-y-2  border border-gray-600 rounded p-3">
                        <p class=" italic" data-translate-key="datastores_loading_owned">Loading your stores...</p>
                    </div>
                </section>
                <section>
                    <h4 class="text-md font-medium  mb-2" data-translate-key="datastores_shared_header">Data Stores Shared With You</h4>
                    <div id="sharedDataStoresList" class="max-h-48 overflow-y-auto space-y-2  border border-gray-600 rounded p-3">
                       <p class=" italic" data-translate-key="datastores_loading_shared">Loading shared stores...</p>
                    </div>
                </section>
            </div>
            <div class="modal-footer">
                <button onclick="closeModal('dataStoresModal')" class="px-4 py-2   text-sm font-medium rounded-md " data-translate-key="close_btn">Close</button>
            </div>
        </div></div>
        <div id="shareDataStoreModal" class="modal"><div class="modal-content" style="width: 450px;">
            <button class="modal-close-btn" onclick="closeModal('shareDataStoreModal')"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" /></svg></button>
            <div class="modal-header"><h3 id="shareDataStoreTitle" class="modal-title" data-translate-key="share_datastore_modal_title_default">Share Data Store</h3></div>
            <div class="modal-body py-4">
                <label for="shareTargetUsernameDS" class="block text-sm font-medium  mb-1" data-translate-key="share_datastore_target_user_label">Share with Username:</label>
                <input type="text" id="shareTargetUsernameDS" class="w-full sm:text-sm" data-translate-placeholder="share_datastore_target_user_placeholder" placeholder="Enter username to share with">
                <div id="shareDataStoreStatus" class="text-xs text-red-400 mt-1 h-4"></div>
                <input type="hidden" id="shareDataStoreIdInput">
            </div>
            <div class="modal-footer">
                <button onclick="closeModal('shareDataStoreModal')" class="px-4 py-2   text-sm font-medium rounded-md " data-translate-key="cancel_btn">Cancel</button>
                <button id="confirmShareDataStoreBtn" class="px-4 py-2   text-sm font-medium rounded-md " data-translate-key="share_btn">Share</button>
            </div>
        </div></div>
        <div id="fileManagementModal" class="modal"><div class="modal-content">
            <button class="modal-close-btn" onclick="closeModal('fileManagementModal')"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" /></svg></button>
            <div class="modal-header"><h3 class="modal-title"><span data-translate-key="file_manager_modal_title_prefix">Manage Files in Data Store:</span> <span id="fileManagerDataStoreName" class="font-normal"></span></h3></div>
            <div class="modal-body space-y-5 py-4">
                <input type="hidden" id="fileManagerCurrentDataStoreId">
                <div class="border border-gray-700 rounded-md p-4">
                     <h4 class="text-md font-medium  mb-3" data-translate-key="file_manager_upload_header">Upload New Documents</h4>
                     <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                         <div>
                             <label for="fileVectorizerSelect" class="block text-sm font-medium  mb-1" data-translate-key="file_manager_vectorizer_label">Vectorizer for Upload</label>
                             <select id="fileVectorizerSelect" class="block w-full rounded-md sm:text-sm">
                                 <option value="" data-translate-key="file_manager_vectorizer_select_default">Select Vectorizer</option>
                             </select>
                         </div>
                         <div>
                            <label for="fileUploadInputFS" class="block text-sm font-medium  mb-1" data-translate-key="file_manager_select_files_label">Select Files</label>
                            <input type="file" id="fileUploadInputFS" multiple class="block w-full text-sm file:mr-4 file:py-1.5 file:px-3 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-700 file:text-blue-100 hover:file: border border-gray-600 rounded-md cursor-pointer"/>
                        </div>
                     </div>
                     <div class="text-right mt-3">
                        <button id="confirmUploadBtn" class="px-4 py-2 bg-green-600  text-sm font-medium rounded-md hover:bg-green-700 disabled:opacity-50" disabled>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 inline-block mr-1 align-text-bottom"><path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0 3 3m-3-3-3 3M6.75 19.5a4.5 4.5 0 0 1-1.41-8.775 5.25 5.25 0 0 1 10.233-2.33 3 3 0 0 1 3.758 3.848A3.752 3.752 0 0 1 18 19.5H6.75Z" /></svg>
                            <span data-translate-key="file_manager_upload_btn">Upload Files</span>
                        </button>
                     </div>
                     <div id="uploadStatus" class="text-sm h-4 mt-2"></div>
                </div>
                 <div class="border border-gray-700 rounded-md p-4">
                     <h4 class="text-md font-medium  mb-3" data-translate-key="file_manager_indexed_docs_header">Indexed Documents in this Store</h4>
                     <div id="indexedFileList" class="max-h-60 overflow-y-auto space-y-2  border border-gray-600 rounded p-3">
                        <p class=" italic" data-translate-key="file_manager_loading_files">Loading files...</p>
                     </div>
                      <div id="fileListStatus" class="text-sm h-4 mt-2"></div>
                </div>
            </div>
             <div class="modal-footer">
                <button onclick="closeModal('fileManagementModal')" class="px-4 py-2   text-sm font-medium rounded-md " data-translate-key="close_btn">Close</button>
            </div>
        </div></div>
        <div id="imageViewerModal" class="modal"><div class="modal-content p-2 relative" style="max-width: 90vw; max-height: 90vh; width: auto; height: auto; background-color:transparent; border:none; box-shadow:none;">
            <button class="modal-close-btn text-2xl font-bold  bg-black bg-opacity-50 rounded-full p-1 leading-none" style="top:10px; right:10px; width:30px; height:30px; z-index:10;" onclick="closeModal('imageViewerModal')"></button>
            <img id="imageViewerSrc" src="" alt="Enlarged Image" class="max-w-full max-h-full object-contain rounded-lg shadow-2xl" data-translate-alt="image_viewer_alt">
        </div></div>
    </div>

    <script src="/main.js"></script>
</body>
</html>
