import{u as R,s as W,a as X,r as v,c as x,w as Q,o as Y,b as r,d as o,h as e,g,q as Z,e as i,a2 as ee,U as te,t as p,f as se,j as _,a3 as ae,a4 as ne,a5 as V,a6 as oe,i as b,_ as j,F as w,m as C,n as I,X as re,P as ie,a7 as le,l as ce,K as ue,v as de,a8 as ve,a9 as pe,aa as fe}from"./index-CFKpK6dV.js";const me={class:"flex flex-col h-full bg-white dark:bg-gray-900"},ge={class:"flex items-center p-3 border-b dark:border-gray-700 bg-gray-50 dark:bg-gray-800 justify-between"},be={class:"flex items-center gap-2 overflow-hidden"},he={key:2,class:"w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center font-bold text-gray-700"},ye={class:"font-bold truncate"},ke={class:"flex items-center gap-1"},xe={key:0,class:"text-xs opacity-75 mb-1 font-bold text-blue-600 dark:text-blue-400"},_e=["onClick"],we={class:"text-[10px] text-gray-400 mt-1 px-1"},Ce={class:"p-3 border-t dark:border-gray-700 bg-gray-50 dark:bg-gray-800"},Ie={key:0,class:"flex gap-2 mb-2 overflow-x-auto pb-1"},Se={class:"truncate max-w-[100px]"},$e=["onClick"],Ge={class:"flex gap-2"},De=["disabled"],Me={__name:"DmWindow",props:{conversation:Object,compact:Boolean},emits:["back"],setup(f,{emit:B}){const a=f,N=B,u=R(),m=W(),S=X(),d=v(""),h=v(null),$=v(null),G=v(null),l=v([]),k=v(!1),F=x(()=>a.conversation.messages),y=x(()=>{var t;return a.conversation.isGroup?a.conversation.name:(t=a.conversation.partner)==null?void 0:t.username});x(()=>m.user);function L(){$.value.click()}function U(t){l.value=Array.from(t.target.files)}async function D(){if(!(!d.value.trim()&&l.value.length===0)){k.value=!0;try{await u.sendDirectMessage({targetId:a.conversation.id,isGroup:a.conversation.isGroup,content:d.value,files:l.value}),d.value="",l.value=[]}finally{k.value=!1}}}function T(){fe(()=>{h.value&&(h.value.scrollTop=h.value.scrollHeight)})}Q(()=>a.conversation.messages.length,T),Y(T);function O(t){S.openImageViewer({imageList:[{src:t,prompt:"DM Image"}],startIndex:0})}function A(t){return new Date(t).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}function E(t){l.value.splice(t,1)}async function K(t){confirm("Delete this message?")&&await u.deleteMessage(t)}async function z(){const t=a.conversation.isGroup?"Leave this group?":"Clear conversation history?";confirm(t)&&(await u.deleteConversation(a.conversation.id,a.conversation.isGroup),a.compact?N("back"):u.activeConversationId=null)}async function H(){await u.exportConversation(a.conversation.id,a.conversation.isGroup,y.value)}function J(){G.value.click()}async function P(t){const n=t.target.files[0];n&&(await u.importConversation(a.conversation.id,a.conversation.isGroup,n),t.target.value="")}return(t,n)=>{var M;return o(),r("div",me,[e("div",ge,[e("div",be,[f.compact?(o(),r("button",{key:0,onClick:n[0]||(n[0]=s=>t.$emit("back")),class:"p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"},[i(ee,{class:"w-5 h-5"})])):g("",!0),f.conversation.isGroup?(o(),r("div",he,p(y.value[0]),1)):(o(),Z(te,{key:1,icon:(M=f.conversation.partner)==null?void 0:M.icon,username:y.value,"size-class":"w-8 h-8"},null,8,["icon","username"])),e("span",ye,p(y.value),1)]),e("div",ke,[i(oe,{icon:"ellipsis-vertical",buttonClass:"btn-icon p-1"},{default:se(()=>[e("button",{onClick:H,class:"menu-item"},[i(ae,{class:"w-4 h-4 mr-2"}),n[3]||(n[3]=_("Export JSON"))]),e("button",{onClick:J,class:"menu-item"},[i(ne,{class:"w-4 h-4 mr-2"}),n[4]||(n[4]=_("Import JSON"))]),n[5]||(n[5]=e("div",{class:"menu-divider"},null,-1)),e("button",{onClick:z,class:"menu-item text-red-500"},[i(V,{class:"w-4 h-4 mr-2"}),_(p(f.conversation.isGroup?"Leave Group":"Clear History"),1)])]),_:1}),e("input",{type:"file",ref_key:"importInput",ref:G,class:"hidden",accept:".json",onChange:P},null,544),e("button",{onClick:n[1]||(n[1]=s=>b(S).isChatSidebarOpen=!1),class:"p-1 rounded hover:bg-gray-200 dark:hover:bg-gray-700"},[i(j,{class:"w-5 h-5"})])])]),e("div",{ref_key:"messageContainer",ref:h,class:"flex-1 overflow-y-auto p-4 space-y-3"},[(o(!0),r(w,null,C(F.value,s=>(o(),r("div",{key:s.id,class:I(["flex flex-col group",s.sender_id===b(m).user.id?"items-end":"items-start"])},[e("div",{class:I(["relative max-w-[85%] p-2 rounded-lg text-sm shadow-sm border dark:border-gray-700",s.sender_id===b(m).user.id?"bg-blue-100 dark:bg-blue-900/30 border-blue-200 dark:border-blue-800":"bg-white dark:bg-gray-800"])},[a.conversation.isGroup&&s.sender_id!==b(m).user.id?(o(),r("div",xe,p(s.sender_username),1)):g("",!0),i(re,{content:s.content},null,8,["content"]),s.image_references&&s.image_references.length>0?(o(),r("div",{key:1,class:I(["mt-2 grid gap-2",s.image_references.length>1?"grid-cols-2":"grid-cols-1"])},[(o(!0),r(w,null,C(s.image_references,c=>(o(),r("div",{key:c,class:"relative group/img cursor-pointer"},[i(le,{src:c,class:"rounded-md max-h-48 object-cover w-full border dark:border-gray-600",onClick:ie(q=>O(c),["stop"])},null,8,["src","onClick"])]))),128))],2)):g("",!0),s.sender_id===b(m).user.id?(o(),r("button",{key:2,onClick:c=>K(s.id),class:"absolute -left-8 top-0 p-1 text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity",title:"Delete"},[i(V,{class:"w-4 h-4"})],8,_e)):g("",!0)],2),e("span",we,p(A(s.sent_at)),1)],2))),128))],512),e("div",Ce,[l.value.length>0?(o(),r("div",Ie,[(o(!0),r(w,null,C(l.value,(s,c)=>(o(),r("div",{key:c,class:"relative bg-white dark:bg-gray-700 rounded border dark:border-gray-600 p-1 text-xs flex items-center shadow-sm"},[e("span",Se,p(s.name),1),e("button",{onClick:q=>E(c),class:"ml-2 text-red-500 hover:text-red-700"},[i(j,{class:"w-3 h-3"})],8,$e)]))),128))])):g("",!0),e("div",Ge,[e("button",{onClick:L,class:"btn-icon p-2"},[i(ue,{class:"w-5 h-5"})]),e("input",{type:"file",ref_key:"fileInput",ref:$,class:"hidden",multiple:"",onChange:U},null,544),ce(e("input",{"onUpdate:modelValue":n[2]||(n[2]=s=>d.value=s),onKeyup:ve(D,["enter"]),class:"input-field flex-1",placeholder:"Type a message...",autocomplete:"off"},null,544),[[de,d.value]]),e("button",{onClick:D,class:"btn-primary p-2 rounded",disabled:k.value||!d.value.trim()&&l.value.length===0},[i(pe,{class:"w-4 h-4"})],8,De)])])])}}};export{Me as _};
