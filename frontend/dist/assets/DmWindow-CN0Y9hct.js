import{u as R,s as W,a as X,r as f,c as x,w as Q,o as Y,b as r,d as o,h as e,g as b,q as Z,e as i,a2 as ee,U as te,t as m,f as se,j as w,a3 as ae,a4 as ne,a5 as V,a6 as oe,i as d,_ as j,F as C,m as I,n as k,X as re,P as ie,a7 as le,l as ce,K as ue,v as de,a8 as ve,a9 as pe,aa as fe}from"./index-DnjdbnqE.js";const me={class:"flex flex-col h-full bg-white dark:bg-gray-900"},ge={class:"flex items-center p-3 border-b dark:border-gray-700 bg-gray-50 dark:bg-gray-800 justify-between"},be={class:"flex items-center gap-2 overflow-hidden"},he={key:2,class:"w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center font-bold text-gray-700"},ye={class:"font-bold truncate"},ke={class:"flex items-center gap-1"},_e={key:0,class:"text-xs opacity-75 mb-1 font-bold text-blue-600 dark:text-blue-400"},xe=["onClick"],we={class:"text-[10px] text-gray-400 mt-1 px-1"},Ce={class:"p-3 border-t dark:border-gray-700 bg-gray-50 dark:bg-gray-800"},Ie={key:0,class:"flex gap-2 mb-2 overflow-x-auto pb-1"},Se={class:"truncate max-w-[100px]"},$e=["onClick"],Ge={class:"flex gap-2"},De=["disabled"],Me={__name:"DmWindow",props:{conversation:Object,compact:Boolean},emits:["back"],setup(g,{emit:B}){const a=g,N=B,v=R(),c=W(),S=X(),p=f(""),h=f(null),$=f(null),G=f(null),l=f([]),_=f(!1),F=x(()=>a.conversation.messages),y=x(()=>{var s;return a.conversation.isGroup?a.conversation.name:(s=a.conversation.partner)==null?void 0:s.username});x(()=>c.user);function L(){$.value.click()}function U(s){l.value=Array.from(s.target.files)}async function D(){if(!(!p.value.trim()&&l.value.length===0)){_.value=!0;try{await v.sendDirectMessage({targetId:a.conversation.id,isGroup:a.conversation.isGroup,content:p.value,files:l.value}),p.value="",l.value=[]}finally{_.value=!1}}}function T(){fe(()=>{h.value&&(h.value.scrollTop=h.value.scrollHeight)})}Q(()=>a.conversation.messages.length,T),Y(T);function O(s){S.openImageViewer({imageList:[{src:s,prompt:"DM Image"}],startIndex:0})}function A(s){return new Date(s).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}function E(s){l.value.splice(s,1)}async function K(s){confirm("Delete this message?")&&await v.deleteMessage(s)}async function z(){const s=a.conversation.isGroup?"Leave this group?":"Clear conversation history?";confirm(s)&&(await v.deleteConversation(a.conversation.id,a.conversation.isGroup),a.compact?N("back"):v.activeConversationId=null)}async function H(){await v.exportConversation(a.conversation.id,a.conversation.isGroup,y.value)}function J(){G.value.click()}async function P(s){const n=s.target.files[0];n&&(await v.importConversation(a.conversation.id,a.conversation.isGroup,n),s.target.value="")}return(s,n)=>{var M;return o(),r("div",me,[e("div",ge,[e("div",be,[g.compact?(o(),r("button",{key:0,onClick:n[0]||(n[0]=t=>s.$emit("back")),class:"p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"},[i(ee,{class:"w-5 h-5"})])):b("",!0),g.conversation.isGroup?(o(),r("div",he,m(y.value[0]),1)):(o(),Z(te,{key:1,icon:(M=g.conversation.partner)==null?void 0:M.icon,username:y.value,"size-class":"w-8 h-8"},null,8,["icon","username"])),e("span",ye,m(y.value),1)]),e("div",ke,[i(oe,{icon:"ellipsis-vertical",buttonClass:"btn-icon p-1"},{default:se(()=>[e("button",{onClick:H,class:"menu-item"},[i(ae,{class:"w-4 h-4 mr-2"}),n[3]||(n[3]=w("Export JSON"))]),e("button",{onClick:J,class:"menu-item"},[i(ne,{class:"w-4 h-4 mr-2"}),n[4]||(n[4]=w("Import JSON"))]),n[5]||(n[5]=e("div",{class:"menu-divider"},null,-1)),e("button",{onClick:z,class:"menu-item text-red-500"},[i(V,{class:"w-4 h-4 mr-2"}),w(m(g.conversation.isGroup?"Leave Group":"Clear History"),1)])]),_:1}),e("input",{type:"file",ref_key:"importInput",ref:G,class:"hidden",accept:".json",onChange:P},null,544),e("button",{onClick:n[1]||(n[1]=t=>d(S).isChatSidebarOpen=!1),class:"p-1 rounded hover:bg-gray-200 dark:hover:bg-gray-700"},[i(j,{class:"w-5 h-5"})])])]),e("div",{ref_key:"messageContainer",ref:h,class:"flex-1 overflow-y-auto p-4 space-y-3"},[(o(!0),r(C,null,I(F.value,t=>(o(),r("div",{key:t.id,class:k(["flex flex-col group",t.sender_id===d(c).user.id?"items-end":"items-start"])},[e("div",{class:k(["relative max-w-[85%] p-2 rounded-lg text-sm shadow-sm border dark:border-gray-700",t.sender_id===d(c).user.id?"bg-blue-100 dark:bg-blue-900/30 border-blue-200 dark:border-blue-800":"bg-white dark:bg-gray-800"])},[a.conversation.isGroup&&t.sender_id!==d(c).user.id?(o(),r("div",_e,m(t.sender_username),1)):b("",!0),i(re,{content:t.content},null,8,["content"]),t.image_references&&t.image_references.length>0?(o(),r("div",{key:1,class:k(["mt-2 grid gap-2",t.image_references.length>1?"grid-cols-2":"grid-cols-1"])},[(o(!0),r(C,null,I(t.image_references,u=>(o(),r("div",{key:u,class:"relative group/img cursor-pointer"},[i(le,{src:u,class:"rounded-md max-h-48 object-cover w-full border dark:border-gray-600",onClick:ie(q=>O(u),["stop"])},null,8,["src","onClick"])]))),128))],2)):b("",!0),t.sender_id===d(c).user.id||d(c).user.is_admin?(o(),r("button",{key:2,onClick:u=>K(t.id),class:k(["absolute top-0 p-1 text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity",t.sender_id===d(c).user.id?"-left-8":"-right-8"]),title:"Delete"},[i(V,{class:"w-4 h-4"})],10,xe)):b("",!0)],2),e("span",we,m(A(t.sent_at)),1)],2))),128))],512),e("div",Ce,[l.value.length>0?(o(),r("div",Ie,[(o(!0),r(C,null,I(l.value,(t,u)=>(o(),r("div",{key:u,class:"relative bg-white dark:bg-gray-700 rounded border dark:border-gray-600 p-1 text-xs flex items-center shadow-sm"},[e("span",Se,m(t.name),1),e("button",{onClick:q=>E(u),class:"ml-2 text-red-500 hover:text-red-700"},[i(j,{class:"w-3 h-3"})],8,$e)]))),128))])):b("",!0),e("div",Ge,[e("button",{onClick:L,class:"btn-icon p-2"},[i(ue,{class:"w-5 h-5"})]),e("input",{type:"file",ref_key:"fileInput",ref:$,class:"hidden",multiple:"",onChange:U},null,544),ce(e("input",{"onUpdate:modelValue":n[2]||(n[2]=t=>p.value=t),onKeyup:ve(D,["enter"]),class:"input-field flex-1",placeholder:"Type a message...",autocomplete:"off"},null,544),[[de,p.value]]),e("button",{onClick:D,class:"btn-primary p-2 rounded",disabled:_.value||!p.value.trim()&&l.value.length===0},[i(pe,{class:"w-4 h-4"})],8,De)])])])}}};export{Me as _};
