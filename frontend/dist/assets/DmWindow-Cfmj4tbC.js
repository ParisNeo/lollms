import{u as q,c as L,b as n,d as s,h as a,F as S,k as T,K as $,e as b,U as A,t as y,g as m,i as le,a as ie,M as u,w as O,o as ce,ck as ue,cl as de,a1 as ge,l as fe,_ as ve,L as P,ci as me,Q as H,C as ye,ad as pe,p as he,cd as be,c8 as W}from"./index-BX8JWUVq.js";const xe={class:"h-full bg-white dark:bg-gray-800 flex flex-col"},ke={class:"flex-grow overflow-y-auto custom-scrollbar"},_e={key:0,class:"p-4 text-center text-sm text-gray-500"},we={key:1,class:"p-8 text-center"},$e={key:2,class:"divide-y divide-gray-100 dark:divide-gray-700/50"},Ce=["onClick"],De={class:"ml-3 flex-1 min-w-0"},Se={class:"flex justify-between items-baseline"},Te={class:"font-semibold text-sm text-gray-900 dark:text-gray-100 truncate pr-2"},Le={class:"text-xs text-gray-500 dark:text-gray-400 flex-shrink-0"},Me={class:"flex justify-between items-center mt-1"},Ue={key:0,class:"flex-shrink-0 inline-flex items-center justify-center px-2 py-0.5 text-xs font-bold leading-none text-white bg-blue-600 rounded-full"},Ye={__name:"ConversationList",props:{modelValue:{type:Number,default:null}},emits:["update:modelValue"],setup(d,{emit:z}){const x=z,M=q(),f=L(()=>M.conversations),U=L(()=>M.isLoadingConversations);function k(o){x("update:modelValue",o)}function p(o){if(!o)return"";const c=new Date(o),l=new Date;return c.toDateString()===l.toDateString()?c.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):c.toLocaleDateString()}return(o,c)=>(s(),n("div",xe,[c[1]||(c[1]=a("div",{class:"p-4 border-b border-gray-200 dark:border-gray-700 flex-shrink-0"},[a("h2",{class:"text-lg font-semibold text-gray-800 dark:text-gray-100"},"Messages")],-1)),a("div",ke,[U.value&&f.value.length===0?(s(),n("div",_e," Loading conversations... ")):f.value.length===0?(s(),n("div",we,c[0]||(c[0]=[a("p",{class:"text-sm text-gray-500"},"No conversations yet.",-1)]))):(s(),n("ul",$e,[(s(!0),n(S,null,T(f.value,l=>(s(),n("li",{key:l.partner_user_id},[a("button",{onClick:C=>k(l.partner_user_id),class:$(["w-full text-left flex items-center p-3 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors relative",{"bg-blue-50 dark:bg-blue-900/20 border-l-4 border-blue-500":d.modelValue===l.partner_user_id}])},[b(A,{icon:l.partner_icon,username:l.partner_username,"size-class":"h-12 w-12 flex-shrink-0"},null,8,["icon","username"]),a("div",De,[a("div",Se,[a("p",Te,y(l.partner_username),1),a("span",Le,y(p(l.last_message_at)),1)]),a("div",Me,[a("p",{class:$(["text-xs text-gray-500 dark:text-gray-400 truncate pr-2",{"font-medium text-gray-800 dark:text-gray-200":l.unread_count>0}])},y(l.last_message),3),l.unread_count>0?(s(),n("span",Ue,y(l.unread_count),1)):m("",!0)])])],10,Ce)]))),128))]))])]))}},je={key:0,class:"absolute inset-0 bg-blue-500/20 border-4 border-dashed border-blue-500 z-50 pointer-events-none flex items-center justify-center"},Ie={class:"flex items-center p-3 border-b border-gray-200 dark:border-gray-700 flex-shrink-0"},Re={class:"ml-3"},Fe={class:"font-semibold text-gray-900 dark:text-gray-100"},Be={key:0,class:"text-center py-2 text-sm text-gray-500"},Ve={key:1,class:"text-center py-2 text-red-500 text-sm"},Ae={key:2,class:"text-center py-4"},ze={class:"text-xs text-gray-400 dark:text-gray-500"},Ne={class:"text-sm break-words whitespace-pre-wrap"},Oe={class:"p-3 border-t border-gray-200 dark:border-gray-700 flex-shrink-0 relative"},Pe={key:0,class:"absolute bottom-full left-0 right-0 mb-2 p-2 bg-white dark:bg-gray-900 border dark:border-gray-700 rounded-lg shadow-lg max-h-48 overflow-y-auto z-10"},He=["onClick"],We={class:"ml-2 text-sm font-medium"},qe={key:1,class:"flex gap-2 p-2 bg-gray-50 dark:bg-gray-900 border-t border-gray-200 dark:border-gray-700 overflow-x-auto mb-2 rounded-t-md"},Ee=["src"],Qe=["onClick"],Ke=["disabled"],Ge={key:1,class:"text-sm font-semibold px-2"},Ze={__name:"DmWindow",props:{conversation:{type:Object,required:!0},compact:{type:Boolean,default:!1}},emits:["back"],setup(d,{emit:z}){const x=d,M=le(),f=q(),U=ie(),k=L(()=>M.user),p=u(null),o=u(""),c=u(null),l=u(null),C=u(0),v=L(()=>x.conversation.partner),E=L(()=>x.conversation.messages||[]),R=u(""),D=u([]),_=u(!1);let N=null;const F=u(-1),g=u([]),j=u(!1),I=u(!1);async function B(){await W(),p.value&&(p.value.scrollTop=p.value.scrollHeight)}O(()=>E.value.length,()=>{B()});async function Q(e){const t=e.target;t.scrollTop===0&&!x.conversation.isLoading&&!x.conversation.fullyLoaded&&(C.value=t.scrollHeight,await f.fetchMoreMessages(v.value.id))}function K(){l.value.click()}function G(e){const t=Array.from(e.target.files);V(t),e.target.value=""}function V(e){for(const t of e)t.type.startsWith("image/")?g.value.push({file:t,preview:URL.createObjectURL(t)}):U.addNotification(`File ${t.name} is not an image.`,"warning")}function J(e){URL.revokeObjectURL(g.value[e].preview),g.value.splice(e,1)}function X(){if(o.value.trim()===""&&g.value.length===0)return;j.value=!0;const e=g.value.map(t=>t.file);f.sendDirectMessage({receiverUserId:v.value.id,content:o.value,files:e}).finally(()=>{j.value=!1}),o.value="",g.value.forEach(t=>URL.revokeObjectURL(t.preview)),g.value=[],_.value=!1}ce(()=>{B(),v.value&&f.markConversationAsRead(v.value.id)}),O(()=>v.value.id,e=>{e&&(f.markConversationAsRead(e),B(),o.value="",g.value=[])}),ue(()=>{if(p.value&&C.value>0){const e=p.value.scrollHeight-C.value;p.value.scrollTop=e,C.value=0}});function Y(e){return new Date(e).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}function Z(e){const t=e.target.value,h=e.target.selectionStart,i=t.substring(0,h).match(/@(\w*)$/);if(i){F.value=i.index;const w=i[1];R.value=w,_.value=!0,clearTimeout(N),N=setTimeout(async()=>{R.value===w&&(D.value=await f.searchForMentions(w))},200)}else _.value=!1,D.value=[]}function ee(e){const t=o.value.substring(0,F.value),h=o.value.substring(F.value+R.value.length+1),r=`${t}@${e.username} ${h}`;o.value=r,_.value=!1,D.value=[],W(()=>{const i=t.length+e.username.length+2;c.value.focus(),c.value.setSelectionRange(i,i)})}function te(){_.value=!1}function ae(e){e.preventDefault(),I.value=!0}function re(e){e.currentTarget.contains(e.relatedTarget)||(I.value=!1)}function se(e){e.preventDefault(),I.value=!1;const t=Array.from(e.dataTransfer.files);V(t)}function ne(e){const t=(e.clipboardData||window.clipboardData).items;for(const h of t)if(h.kind==="file"&&h.type.startsWith("image/")){const r=h.getAsFile();V([r])}}function oe(e){U.openImageViewer({imageList:[{src:e,prompt:"DM Image"}],startIndex:0})}return(e,t)=>{const h=de("on-click-outside");return d.conversation&&d.conversation.partner?(s(),n("div",{key:0,class:"flex flex-col h-full bg-white dark:bg-gray-800 border-l border-gray-200 dark:border-gray-700 shadow-lg",onDragover:ae,onDragleave:re,onDrop:se,onPaste:ne},[I.value?(s(),n("div",je,t[3]||(t[3]=[a("span",{class:"text-blue-600 font-bold text-lg bg-white/80 px-4 py-2 rounded"},"Drop images here",-1)]))):m("",!0),a("header",Ie,[d.compact?(s(),n("button",{key:0,onClick:t[0]||(t[0]=r=>e.$emit("back")),class:"mr-2 p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300"},[b(ge,{class:"w-5 h-5"})])):m("",!0),b(A,{icon:v.value.icon,username:v.value.username,"size-class":"h-9 w-9"},null,8,["icon","username"]),a("div",Re,[a("h3",Fe,y(v.value.username),1)]),t[4]||(t[4]=a("div",{class:"flex-grow"},null,-1)),a("button",{onClick:t[1]||(t[1]=r=>fe(f).closeConversation(v.value.id)),class:"p-1 rounded-full text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-600"},[b(ve,{class:"w-5 h-5"})])]),a("div",{ref_key:"messageContainer",ref:p,onScroll:Q,class:"flex-grow p-4 overflow-y-auto"},[d.conversation.isLoading?(s(),n("div",Be,"Loading...")):m("",!0),d.conversation.error?(s(),n("div",Ve,y(d.conversation.error),1)):m("",!0),d.conversation.fullyLoaded?(s(),n("div",Ae,[a("p",ze,"This is the beginning of your conversation with "+y(v.value.username)+".",1)])):m("",!0),(s(!0),n(S,null,T(d.conversation.messages,r=>(s(),n("div",{key:r.id,class:$(["flex my-2",r.sender_id===k.value.id?"justify-end":"justify-start"])},[a("div",{class:$(["max-w-[80%] px-3 py-2 rounded-lg",{"bg-blue-500 text-white":r.sender_id===k.value.id,"bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-gray-200":r.sender_id!==k.value.id,"opacity-60":r.isTemporary,"border border-red-500":r.error}])},[r.image_references&&r.image_references.length>0?(s(),n("div",{key:0,class:$(["mb-2 grid gap-1",r.image_references.length>1?"grid-cols-2":"grid-cols-1"])},[(s(!0),n(S,null,T(r.image_references,(i,w)=>(s(),n("div",{key:w,class:"relative group cursor-pointer"},[b(me,{src:i,class:"rounded-md max-h-48 object-cover w-full",onClick:P(Je=>oe(i),["stop"])},null,8,["src","onClick"])]))),128))],2)):m("",!0),a("p",Ne,y(r.content),1),a("p",{class:$(["text-xs mt-1 opacity-70",r.sender_id===k.value.id?"text-right":"text-left"])},y(Y(r.sent_at)),3)],2)],2))),128))],544),a("footer",Oe,[_.value&&D.value.length>0?H((s(),n("div",Pe,[a("ul",null,[(s(!0),n(S,null,T(D.value,r=>(s(),n("li",{key:r.id,onClick:i=>ee(r),class:"flex items-center p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer"},[b(A,{icon:r.icon,username:r.username,"size-class":"h-6 w-6"},null,8,["icon","username"]),a("span",We,y(r.username),1)],8,He))),128))])])),[[h,te]]):m("",!0),g.value.length>0?(s(),n("div",qe,[(s(!0),n(S,null,T(g.value,(r,i)=>(s(),n("div",{key:i,class:"relative w-16 h-16 flex-shrink-0 group"},[a("img",{src:r.preview,class:"w-full h-full object-cover rounded-md border dark:border-gray-600"},null,8,Ee),a("button",{onClick:w=>J(i),class:"absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity"},"Ã—",8,Qe)]))),128))])):m("",!0),a("form",{onSubmit:P(X,["prevent"]),class:"flex items-center space-x-2"},[a("input",{type:"file",ref_key:"fileInputRef",ref:l,onChange:G,multiple:"",accept:"image/*",class:"hidden"},null,544),a("button",{type:"button",onClick:K,class:"p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-500 dark:text-gray-400"},[b(ye,{class:"w-5 h-5"})]),H(a("input",{ref_key:"dmInputRef",ref:c,type:"text","onUpdate:modelValue":t[2]||(t[2]=r=>o.value=r),onInput:Z,placeholder:"Type a message...",class:"input-field flex-grow !py-2",autocomplete:"off"},null,544),[[pe,o.value]]),a("button",{type:"submit",class:"btn btn-primary p-2",disabled:j.value||o.value.trim()===""&&g.value.length===0},[j.value?(s(),he(be,{key:0,class:"w-5 h-5 animate-spin"})):(s(),n("span",Ge,"Send"))],8,Ke)],32)])],32)):m("",!0)}}};export{Ze as _,Ye as a};
