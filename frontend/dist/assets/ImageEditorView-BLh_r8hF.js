import{Q as de,b as p,d as f,h as t,cJ as ke,ae as Ce,a as Se,s as Ie,r as s,c as Me,o as _e,a1 as Re,X as Le,z as Ue,g as oe,e as i,a3 as ze,n as A,c4 as Ee,l as b,v as C,t as M,a6 as Pe,j as _,cO as $e,ak as re,W as Ve,cP as De,k as Ne,cN as je,ca as ie,G as ue,c1 as He,F as W,m as Te,cd as Xe,x as Ye}from"./index-DQQPpKTr.js";import{I as Be,a as Fe}from"./IconRedo-BmX1wgTr.js";const Ae={},We={xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24","stroke-width":"1.5",stroke:"currentColor"};function Oe(O,h){return f(),p("svg",We,h[0]||(h[0]=[t("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M21 11.25v8.25a1.5 1.5 0 0 1-1.5 1.5H5.25a1.5 1.5 0 0 1-1.5-1.5v-8.25M12 4.875A2.625 2.625 0 1 0 9.375 7.5H12m0-2.625V7.5m0-2.625A2.625 2.625 0 1 1 14.625 7.5H12m0 0V21m-8.625-9.75h18c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125h-18c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125Z"},null,-1)]))}const Ge=de(Ae,[["render",Oe]]),Ke={class:"h-full flex flex-col bg-gray-100 dark:bg-gray-900 overflow-hidden relative"},Ze={class:"h-14 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between px-4 z-20 shadow-sm"},qe={class:"flex items-center gap-4"},Je={class:"flex items-center gap-2"},Qe={key:0,class:"flex items-center gap-2 ml-4"},et={class:"text-xs w-6"},tt={class:"flex items-center gap-2"},at=["disabled"],lt=["disabled"],st={class:"flex-grow flex min-h-0 relative"},nt={class:"absolute bottom-4 left-4 bg-white/90 dark:bg-gray-800/90 backdrop-blur rounded-lg shadow p-2 flex items-center gap-2 z-10"},ot={class:"text-xs font-mono w-12 text-center"},rt={class:"w-80 bg-white dark:bg-gray-800 border-l border-gray-200 dark:border-gray-700 flex flex-col z-20 shadow-xl"},it={class:"p-4 border-b dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-gray-800/50"},ut={key:0,class:"flex items-center text-xs text-blue-500 animate-pulse"},dt={class:"flex-grow overflow-y-auto p-4 space-y-5 custom-scrollbar"},vt={class:"flex justify-between items-center mb-1"},ct=["disabled"],gt={class:"space-y-4 pt-2 border-t dark:border-gray-700/50"},mt={class:"label flex justify-between"},bt={class:"text-gray-500"},pt={class:"label flex justify-between"},ft={class:"text-gray-500"},ht={label:"Compatible Models"},wt=["value"],yt={class:"flex gap-2"},xt={class:"p-4 border-t dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50"},kt=["disabled"],Ct={__name:"ImageEditorView",props:{id:{type:String,default:null}},setup(O){const h=O;Ye();const G=Ue(),R=ke(),ve=Ce(),H=Se(),L=Ie(),U=s(null),r=s(null),n=s(null),z=s(null),u=s(null),o=s("brush"),w=s(40),S=s(1),T=s(0),X=s(0),E=s(!1),Y=s(0),B=s(0),K=s(0),Z=s(0),F=s(!1),m=s(""),P=s(""),$=s(.75),V=s(7.5),D=s(-1),y=s(""),x=s(!1),c=s([]),d=s(-1),ce=Me(()=>ve.availableTtiModels);let k=null;_e(async()=>{r.value&&n.value&&(z.value=r.value.getContext("2d"),u.value=n.value.getContext("2d")),h.id==="new"?ge():h.id&&await me(h.id),L.user&&(y.value=L.user.iti_binding_model_name||L.user.tti_binding_model_name||""),window.addEventListener("keydown",ne),window.addEventListener("resize",I)}),Re(()=>{window.removeEventListener("keydown",ne),window.removeEventListener("resize",I),k&&URL.revokeObjectURL(k)});function ge(a=1024,e=1024){q(a,e),z.value.fillStyle="#FFFFFF",z.value.fillRect(0,0,a,e),N(),I()}async function me(a){try{const e=await Le.get(`/api/image-studio/${a}/file`,{responseType:"blob"});k&&URL.revokeObjectURL(k),k=URL.createObjectURL(e.data);const l=new Image;await new Promise((g,j)=>{l.onload=g,l.onerror=j,l.src=k}),q(l.naturalWidth,l.naturalHeight),z.value.drawImage(l,0,0);const v=R.images.find(g=>g.id===a);v&&(m.value=v.prompt||"",P.value=v.negative_prompt||""),N(),I()}catch(e){console.error("Failed to load image",e),H.addNotification("Failed to load image for editing (Authentication or Network error).","error"),G.push("/image-studio")}}function q(a,e){!r.value||!n.value||(r.value.width=a,r.value.height=e,n.value.width=a,n.value.height=e)}function J(a){if(!n.value)return{x:0,y:0};const e=n.value.getBoundingClientRect(),l=n.value.width/e.width,v=n.value.height/e.height;return{x:(a.clientX-e.left)*l,y:(a.clientY-e.top)*v,rawX:a.clientX,rawY:a.clientY}}function be(a){if(a.button===0&&(E.value=!0,Y.value=a.clientX,B.value=a.clientY,o.value==="brush"||o.value==="eraser")){const{x:e,y:l}=J(a);ee(e,l)}}function pe(a){const{x:e,y:l}=J(a);if(K.value=e,Z.value=l,F.value=!0,!!E.value)if(o.value==="pan"){const v=a.clientX-Y.value,g=a.clientY-B.value;T.value+=v,X.value+=g,Y.value=a.clientX,B.value=a.clientY}else ee(e,l)}function Q(){E.value&&(o.value==="brush"||o.value==="eraser")&&N(),E.value=!1,F.value=!1}function ee(a,e){u.value&&(u.value.globalCompositeOperation=o.value==="eraser"?"destination-out":"source-over",u.value.beginPath(),u.value.arc(a,e,w.value/2,0,Math.PI*2),u.value.fillStyle="rgba(0, 0, 0, 1)",u.value.fillStyle="rgba(255, 255, 255, 1)",u.value.fill(),u.value.closePath())}function I(){if(!U.value||!r.value)return;const a=U.value.clientWidth,e=U.value.clientHeight,l=r.value.width,v=r.value.height;if(l===0||v===0)return;const g=(a-40)/l,j=(e-40)/v;S.value=Math.min(g,j,1),T.value=0,X.value=0}function fe(a){if(a.ctrlKey||o.value==="pan"){a.preventDefault();const e=-Math.sign(a.deltaY)*.1;S.value=Math.min(Math.max(.1,S.value+e),5)}}function N(){d.value<c.value.length-1&&(c.value=c.value.slice(0,d.value+1));const a=n.value.toDataURL();c.value.push({mask:a}),d.value++,c.value.length>20&&(c.value.shift(),d.value--)}function te(){d.value>0?(d.value--,le(c.value[d.value])):se()}function ae(){d.value<c.value.length-1&&(d.value++,le(c.value[d.value]))}function le(a){const e=new Image;e.src=a.mask,e.onload=()=>{u.value.clearRect(0,0,n.value.width,n.value.height),u.value.drawImage(e,0,0)}}function se(){u.value.clearRect(0,0,n.value.width,n.value.height),N()}async function he(){if(!m.value||!y.value){H.addNotification("Prompt and Model are required.","warning");return}x.value=!0;try{const a=r.value.toDataURL("image/png").split(",")[1],e=document.createElement("canvas");e.width=n.value.width,e.height=n.value.height;const l=e.getContext("2d");l.fillStyle="#000000",l.fillRect(0,0,e.width,e.height),l.drawImage(n.value,0,0);const v=e.toDataURL("image/png").split(",")[1],g={base_image_b64:a,mask:v,prompt:m.value,negative_prompt:P.value,strength:$.value,cfg_scale:V.value,seed:D.value,model:y.value,width:r.value.width,height:r.value.height},j=await R.editImage(g)}catch(a){console.error(a),H.addNotification("Generation failed.","error")}finally{x.value=!1}}async function we(){const a=r.value.toDataURL("image/png").split(",")[1];await R.saveCanvasAsNewImage({base_image_b64:a,prompt:m.value||"Edited Image",width:r.value.width,height:r.value.height,model:y.value})}async function ye(){var a;m.value&&await R.enhanceImagePrompt({prompt:m.value,target:"prompt",model:(a=L.user)==null?void 0:a.lollms_model_name})}function xe(){G.push("/image-studio")}function ne(a){a.target.tagName==="INPUT"||a.target.tagName==="TEXTAREA"||((a.key===" "||a.code==="Space")&&(o.value="pan"),a.key.toLowerCase()==="b"&&(o.value="brush"),a.key.toLowerCase()==="e"&&(o.value="eraser"),(a.ctrlKey||a.metaKey)&&a.key.toLowerCase()==="z"&&(a.preventDefault(),te()),(a.ctrlKey||a.metaKey)&&a.key.toLowerCase()==="y"&&(a.preventDefault(),ae()))}return(a,e)=>(f(),p("div",Ke,[t("div",Ze,[t("div",qe,[t("button",{onClick:xe,class:"btn-icon",title:"Back to Gallery"},[i(ze,{class:"w-5 h-5"})]),e[15]||(e[15]=t("div",{class:"h-6 w-px bg-gray-300 dark:bg-gray-600"},null,-1)),t("div",Je,[t("button",{onClick:e[0]||(e[0]=l=>o.value="pan"),class:A(["btn-icon",{"bg-blue-100 dark:bg-blue-900/50 text-blue-600":o.value==="pan"}]),title:"Pan Tool (Space)"},[i(Ge,{class:"w-5 h-5"})],2),t("button",{onClick:e[1]||(e[1]=l=>o.value="brush"),class:A(["btn-icon",{"bg-blue-100 dark:bg-blue-900/50 text-blue-600":o.value==="brush"}]),title:"Brush Tool (B)"},[i(Ee,{class:"w-5 h-5"})],2),t("button",{onClick:e[2]||(e[2]=l=>o.value="eraser"),class:A(["btn-icon",{"bg-blue-100 dark:bg-blue-900/50 text-blue-600":o.value==="eraser"}]),title:"Eraser Tool (E)"},e[13]||(e[13]=[t("svg",{xmlns:"http://www.w3.org/2000/svg",class:"w-5 h-5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},[t("path",{d:"M20 20H7L3 16C2 15 2 13 3 12L13 2L22 11L20 20Z"}),t("path",{d:"M11 11L20 20"})],-1)]),2)]),o.value!=="pan"?(f(),p("div",Qe,[e[14]||(e[14]=t("span",{class:"text-xs font-medium text-gray-500 uppercase"},"Size",-1)),b(t("input",{type:"range","onUpdate:modelValue":e[3]||(e[3]=l=>w.value=l),min:"5",max:"100",class:"w-32 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700"},null,512),[[C,w.value,void 0,{number:!0}]]),t("span",et,M(w.value),1)])):oe("",!0)]),t("div",tt,[t("button",{onClick:te,disabled:d.value<=0,class:"btn-icon",title:"Undo (Ctrl+Z)"},[i(Be,{class:"w-5 h-5"})],8,at),t("button",{onClick:ae,disabled:d.value>=c.value.length-1,class:"btn-icon",title:"Redo (Ctrl+Y)"},[i(Fe,{class:"w-5 h-5"})],8,lt),e[17]||(e[17]=t("div",{class:"h-6 w-px bg-gray-300 dark:bg-gray-600 mx-2"},null,-1)),t("button",{onClick:se,class:"btn-icon text-red-500 hover:text-red-600",title:"Clear Mask"},[i(Pe,{class:"w-5 h-5"})]),t("button",{onClick:we,class:"btn btn-secondary btn-sm gap-2"},[i($e,{class:"w-4 h-4"}),e[16]||(e[16]=_(" Save Copy "))])])]),t("div",st,[t("div",{ref_key:"containerRef",ref:U,class:"flex-grow bg-gray-200 dark:bg-gray-900 relative overflow-hidden flex items-center justify-center cursor-crosshair pattern-grid",onWheel:fe,onMousedown:be,onMousemove:pe,onMouseup:Q,onMouseleave:Q},[t("div",{style:re({transform:`translate(${T.value}px, ${X.value}px) scale(${S.value})`}),class:"relative shadow-2xl origin-center transition-transform duration-75"},[t("canvas",{ref_key:"imageCanvasRef",ref:r,class:"block bg-white"},null,512),t("canvas",{ref_key:"maskCanvasRef",ref:n,class:"absolute inset-0 opacity-60"},null,512),b(t("div",{class:"absolute pointer-events-none rounded-full border border-white bg-black/10 z-50 transform -translate-x-1/2 -translate-y-1/2",style:re({width:`${w.value}px`,height:`${w.value}px`,left:`${K.value}px`,top:`${Z.value}px`})},null,4),[[Ve,o.value!=="pan"&&F.value]])],4),t("div",nt,[t("button",{onClick:e[4]||(e[4]=(...l)=>a.zoomOut&&a.zoomOut(...l)),class:"p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded"},[i(De,{class:"w-4 h-4"})]),t("span",ot,M(Math.round(S.value*100))+"%",1),t("button",{onClick:e[5]||(e[5]=(...l)=>a.zoomIn&&a.zoomIn(...l)),class:"p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded"},[i(Ne,{class:"w-4 h-4"})]),t("button",{onClick:I,class:"p-1 hover:bg-gray-100 dark:hover:bg-gray-700 rounded ml-1",title:"Fit to Screen"},[i(je,{class:"w-4 h-4"})])])],544),t("div",rt,[t("div",it,[e[19]||(e[19]=t("h3",{class:"font-semibold"},"Edit Settings",-1)),x.value?(f(),p("div",ut,[i(ie,{class:"w-3 h-3 mr-1"}),e[18]||(e[18]=_(" Generating... "))])):oe("",!0)]),t("div",dt,[t("div",null,[t("div",vt,[e[21]||(e[21]=t("label",{class:"label"},"Prompt",-1)),t("button",{onClick:ye,class:"text-blue-500 hover:text-blue-600 text-xs flex items-center gap-1",disabled:x.value},[i(ue,{class:"w-3 h-3"}),e[20]||(e[20]=_(" Enhance "))],8,ct)]),b(t("textarea",{"onUpdate:modelValue":e[6]||(e[6]=l=>m.value=l),rows:"3",class:"input-field w-full text-sm",placeholder:"What to generate..."},null,512),[[C,m.value]])]),t("div",null,[e[22]||(e[22]=t("label",{class:"label"},"Negative Prompt",-1)),b(t("textarea",{"onUpdate:modelValue":e[7]||(e[7]=l=>P.value=l),rows:"2",class:"input-field w-full text-sm",placeholder:"What to avoid..."},null,512),[[C,P.value]])]),t("div",gt,[t("div",null,[t("label",mt,[e[23]||(e[23]=t("span",null,"Strength (Denoising)",-1)),t("span",bt,M($.value),1)]),b(t("input",{type:"range","onUpdate:modelValue":e[8]||(e[8]=l=>$.value=l),min:"0.1",max:"1.0",step:"0.05",class:"w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700"},null,512),[[C,$.value,void 0,{number:!0}]]),e[24]||(e[24]=t("p",{class:"text-[10px] text-gray-500 mt-1"},"Lower = closer to original, Higher = more creative.",-1))]),t("div",null,[t("label",pt,[e[25]||(e[25]=t("span",null,"Guidance Scale",-1)),t("span",ft,M(V.value),1)]),b(t("input",{type:"range","onUpdate:modelValue":e[9]||(e[9]=l=>V.value=l),min:"1",max:"20",step:"0.5",class:"w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700"},null,512),[[C,V.value,void 0,{number:!0}]])]),t("div",null,[e[27]||(e[27]=t("label",{class:"label"},"Model",-1)),b(t("select",{"onUpdate:modelValue":e[10]||(e[10]=l=>y.value=l),class:"input-field w-full text-sm mt-1"},[e[26]||(e[26]=t("option",{disabled:"",value:""},"Select Model",-1)),t("optgroup",ht,[(f(!0),p(W,null,Te(ce.value,l=>(f(),p("option",{key:l.id,value:l.id},M(l.name),9,wt))),128))])],512),[[He,y.value]])]),t("div",null,[e[28]||(e[28]=t("label",{class:"label"},"Seed",-1)),t("div",yt,[b(t("input",{"onUpdate:modelValue":e[11]||(e[11]=l=>D.value=l),type:"number",class:"input-field flex-grow text-sm",placeholder:"-1"},null,512),[[C,D.value,void 0,{number:!0}]]),t("button",{onClick:e[12]||(e[12]=l=>D.value=-1),class:"btn btn-secondary px-2",title:"Randomize"},[i(Xe,{class:"w-4 h-4"})])])])])]),t("div",xt,[t("button",{onClick:he,class:"btn btn-primary w-full py-3 shadow-lg hover:shadow-xl transform active:scale-95 transition-all",disabled:x.value},[x.value?(f(),p(W,{key:0},[i(ie,{class:"w-5 h-5 mr-2 animate-spin"}),e[29]||(e[29]=_(" Processing... "))],64)):(f(),p(W,{key:1},[i(ue,{class:"w-5 h-5 mr-2"}),e[30]||(e[30]=_(" Generate Edit "))],64))],8,kt)])])])]))}},Mt=de(Ct,[["__scopeId","data-v-cf13c6f4"]]);export{Mt as default};
