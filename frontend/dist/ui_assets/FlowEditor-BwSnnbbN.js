import{Z as he,a2 as me,g as we,ag as ke,L as i,c as I,k as q,j as _e,e as r,o as l,b as s,a as V,l as b,f as N,O as Me,m,F as x,n as w,J as D,t as M,K as g,au as $e,R as Ce,am as K,aD as Ie,T as Z,ap as Ne,d as De,a7 as Se,a4 as Q}from"./index-DsFmVrVf.js";import Pe from"./NodeCreatorModal-DzKGNAzN.js";import"./index-BxhruCxp.js";const Te={class:"relative w-full h-full flex overflow-hidden"},Oe={class:"w-60 bg-white dark:bg-gray-800 border-r dark:border-gray-700 flex flex-col z-10 flex-shrink-0"},He={class:"p-3 border-b dark:border-gray-700 flex justify-between items-center"},Le={key:0,class:"p-4 text-center text-gray-400 text-xs italic"},Ae={class:"p-2 space-y-2 overflow-y-auto custom-scrollbar flex-grow"},Ee=["onDblclick","onDragend","title"],Ve={class:"flex items-center justify-between"},Ye={class:"text-xs font-bold truncate pr-2"},je={class:"flex items-center gap-1"},Xe=["onClick"],Je={key:0,class:"text-[9px] text-gray-400 mt-1 line-clamp-1"},Be={class:"absolute top-0 left-0 overflow-visible pointer-events-none w-full h-full",style:{width:"1px",height:"1px"}},We=["d","onClick"],ze=["d"],Ue=["onMousedown"],Fe={class:"px-2 py-1 border-b dark:border-gray-700/50 flex justify-between items-center bg-gray-50/50 dark:bg-gray-900/20 cursor-grab active:cursor-grabbing"},Ge={class:"text-xs font-bold truncate select-none"},Re=["onClick"],qe={class:"p-2 space-y-2 relative"},Ke=["onMousedown","onMouseup","title"],Ze={class:"text-[10px] text-gray-500 ml-1 truncate flex-1 select-none"},Qe=["onUpdate:modelValue"],et=["label"],tt=["value"],ot=["onUpdate:modelValue"],nt={class:"text-[10px] text-gray-500 mr-1 truncate select-none"},st=["onMousedown","onMouseup","title"],at={key:0,class:"fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4"},lt={class:"bg-white dark:bg-gray-800 rounded-2xl shadow-2xl max-w-lg w-full p-6 animate-in fade-in zoom-in-95 border dark:border-gray-700"},rt={class:"mt-6 flex justify-end"},it={__name:"FlowEditor",props:{flow:{type:Object,required:!0}},setup(ee){const S=ee,P=me(),te=we(),Y=ke(),c=i([]),u=i([]),v=i(1),f=i({x:0,y:0}),T=i(!1),O=i(!1),$=i(null),y=i({x:0,y:0}),h=i(!1),d=i(null),j=i({x:0,y:0}),H=i(!1),L=i(null),C=i(!1),oe=I(()=>te.isAdmin);q(()=>S.flow,e=>{e&&e.data?(c.value=JSON.parse(JSON.stringify(e.data.nodes||[])),u.value=JSON.parse(JSON.stringify(e.data.edges||[]))):(c.value=[],u.value=[])},{immediate:!0}),q([c,u],()=>{S.flow&&(S.flow.data={nodes:c.value,edges:u.value})},{deep:!0}),_e(()=>{P.fetchNodeDefinitions(),Y.fetchAvailableLollmsModels(),localStorage.getItem("flow_tutorial_seen")||(C.value=!0,localStorage.setItem("flow_tutorial_seen","true"))});const X=I(()=>{const e={};return P.nodeDefinitions.forEach(o=>{e[o.name]=o}),e}),J=I(()=>P.nodeDefinitions.map(e=>({...e,type:e.name,color:e.color||"bg-gray-100 border-gray-500"})));function B(e){const o={string:"bg-gray-400",int:"bg-green-500",float:"bg-green-400",boolean:"bg-orange-500",image:"bg-pink-500",node_ref:"bg-indigo-500",list:"bg-cyan-500",model_selection:"bg-purple-400",any:"bg-white border-2 border-gray-400"};return o[e]||o.any}function A(e,o){const t=X.value[e];if(!t)return"any";const n=t.inputs.find(a=>a.name===o);return n?n.type:"any"}function W(e,o){const t=X.value[e];if(!t)return"any";const n=t.outputs.find(a=>a.name===o);return n?n.type:"any"}function ne(e,o){return u.value.some(t=>t.target===e&&t.targetHandle===o)}function se(e){console.log("Opening edit for node definition:",e.name),L.value=JSON.parse(JSON.stringify(e)),H.value=!0}function z(e){const o=(-f.value.x+(window.innerWidth/2-200))/v.value,t=(-f.value.y+window.innerHeight/2)/v.value;c.value.push({id:`node_${Date.now()}`,type:e.type,label:e.label,x:o>0?o:50,y:t>0?t:50,data:{},inputs:e.inputs.map(n=>n.name),outputs:e.outputs.map(n=>n.name),color:e.color})}function ae(e){c.value=c.value.filter(o=>o.id!==e),u.value=u.value.filter(o=>o.source!==e&&o.target!==e)}function le(e){(e.button===1||e.button===0&&e.target.classList.contains("flow-canvas"))&&(T.value=!0,y.value={x:e.clientX,y:e.clientY})}function re(e){const o=e.currentTarget.getBoundingClientRect();if(j.value={x:(e.clientX-o.left-f.value.x)/v.value,y:(e.clientY-o.top-f.value.y)/v.value},T.value)f.value.x+=e.clientX-y.value.x,f.value.y+=e.clientY-y.value.y,y.value={x:e.clientX,y:e.clientY};else if(O.value&&$.value){const t=c.value.find(n=>n.id===$.value);t&&(t.x+=(e.clientX-y.value.x)/v.value,t.y+=(e.clientY-y.value.y)/v.value,y.value={x:e.clientX,y:e.clientY})}}function ie(){T.value=!1,O.value=!1,$.value=null,h.value&&(h.value=!1,d.value=null)}function ue(e){e.preventDefault();const o=e.deltaY>0?-.1:.1;v.value=Math.min(Math.max(.1,v.value+o),5)}function de(e,o){e.button===0&&(e.stopPropagation(),O.value=!0,$.value=o,y.value={x:e.clientX,y:e.clientY})}function U(e,o,t,n){e.stopPropagation(),h.value=!0,d.value={nodeId:o,handleId:t,type:n}}function F(e,o,t,n){if(e.stopPropagation(),!h.value||!d.value)return;const a=d.value;if(a.nodeId!==o&&a.type!==n){const p=a.type==="output"?a:{nodeId:o,handleId:t},k=a.type==="input"?a:{nodeId:o,handleId:t};if(a.type===n)return;u.value.find(_=>_.source===p.nodeId&&_.sourceHandle===p.handleId&&_.target===k.nodeId&&_.targetHandle===k.handleId)||u.value.push({id:`e_${Date.now()}`,source:p.nodeId,sourceHandle:p.handleId,target:k.nodeId,targetHandle:k.handleId})}h.value=!1,d.value=null}function ce(e){u.value.splice(e,1)}function E(e,o,t){const n=c.value.find(xe=>xe.id===e);if(!n)return{x:0,y:0};const a=n.inputs||[],p=n.outputs||[],k=t==="input"?a.indexOf(o):p.indexOf(o),G=192,_=29,ve=8,R=24,fe=_+ve+k*(R+8)+R/2,ye=t==="input"?n.x:n.x+G,be=n.y+fe;return{x:ye,y:be}}function pe(e){const o=E(e.source,e.sourceHandle,"output"),t=E(e.target,e.targetHandle,"input"),n=Math.abs(t.x-o.x)*.5;return`M ${o.x} ${o.y} C ${o.x+n} ${o.y}, ${t.x-n} ${t.y}, ${t.x} ${t.y}`}const ge=I(()=>{if(!h.value||!d.value)return"";const e=E(d.value.nodeId,d.value.handleId,d.value.type),o=j.value,t=Math.abs(o.x-e.x)*.5;return`M ${e.x} ${e.y} C ${e.x+(d.value.type==="output"?t:-t)} ${e.y}, ${o.x-(d.value.type==="output"?t:-t)} ${o.y}, ${o.x} ${o.y}`});return(e,o)=>(l(),r("div",Te,[s("div",Oe,[s("div",He,[o[5]||(o[5]=s("span",{class:"font-bold text-xs uppercase text-gray-500 tracking-wider"},"Node Palette",-1)),s("button",{onClick:o[0]||(o[0]=t=>C.value=!0),class:"text-blue-500 hover:text-blue-600 transition-colors"},[N(Me,{class:"w-4 h-4"})])]),J.value.length===0?(l(),r("div",Le,o[6]||(o[6]=[m(" No nodes defined."),s("br",null,null,-1),m("Admins can create nodes. ")]))):b("",!0),s("div",Ae,[(l(!0),r(x,null,w(J.value,t=>(l(),r("div",{key:t.id,class:D(["group p-2 rounded border dark:border-gray-600 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 transition-all active:scale-95 border-l-4 shadow-sm relative overflow-hidden",t.color.split(" ").find(n=>n.startsWith("border-"))]),onDblclick:n=>z(t),draggable:"true",onDragend:n=>z(t),title:t.description},[s("div",Ve,[s("span",Ye,M(t.label),1),s("div",je,[oe.value?(l(),r("button",{key:0,onClick:g(n=>se(t),["stop"]),class:"text-gray-400 hover:text-blue-500 p-0.5 rounded opacity-0 group-hover:opacity-100 transition-opacity"},[N($e,{class:"w-3.5 h-3.5"})],8,Xe)):b("",!0),N(Ce,{class:"w-3.5 h-3.5 text-gray-400 opacity-0 group-hover:opacity-100 transition-opacity"})])]),t.description?(l(),r("div",Je,M(t.description),1)):b("",!0)],42,Ee))),128))]),o[7]||(o[7]=s("div",{class:"p-2 text-[9px] text-gray-400 text-center border-t dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50"}," Drag or Double-Click to Add ",-1))]),s("div",{class:"flex-grow relative bg-gray-100 dark:bg-gray-900 flow-canvas overflow-hidden cursor-grab active:cursor-grabbing pattern-grid",onMousedown:le,onMousemove:re,onMouseup:ie,onWheel:ue},[s("div",{class:"transform-origin-0-0 w-full h-full",style:K({transform:`translate(${f.value.x}px, ${f.value.y}px) scale(${v.value})`})},[(l(),r("svg",Be,[s("g",null,[(l(!0),r(x,null,w(u.value,(t,n)=>(l(),r("path",{key:t.id,d:pe(t),class:"stroke-gray-400 dark:stroke-gray-500 stroke-[3px] fill-none pointer-events-auto hover:stroke-blue-500 cursor-pointer",onClick:g(a=>ce(n),["stop"])},null,8,We))),128)),h.value?(l(),r("path",{key:0,d:ge.value,class:"stroke-blue-400 stroke-[3px] fill-none","stroke-dasharray":"5,5"},null,8,ze)):b("",!0)])])),(l(!0),r(x,null,w(c.value,t=>(l(),r("div",{key:t.id,class:D(["absolute w-48 rounded-lg shadow-lg border-2 bg-white dark:bg-gray-800 flex flex-col",t.color]),style:K({transform:`translate(${t.x}px, ${t.y}px)`}),onMousedown:g(n=>de(n,t.id),["stop"])},[s("div",Fe,[s("span",Ge,M(t.label),1),s("button",{onClick:g(n=>ae(t.id),["stop"]),class:"text-gray-400 hover:text-red-500 rounded"},[N(Ie,{class:"w-3 h-3"})],8,Re)]),s("div",qe,[(l(!0),r(x,null,w(t.inputs,n=>(l(),r("div",{key:n,class:"flex items-center relative h-6"},[s("div",{class:D(["w-3.5 h-3.5 rounded-full border-2 border-white dark:border-gray-800 absolute -left-[1.1rem] cursor-crosshair hover:scale-125 shadow-sm transition-transform",B(A(t.type,n))]),onMousedown:g(a=>U(a,t.id,n,"input"),["stop"]),onMouseup:g(a=>F(a,t.id,n,"input"),["stop"]),title:A(t.type,n)},null,42,Ke),s("span",Ze,M(n),1),ne(t.id,n)?b("",!0):(l(),r(x,{key:0},[A(t.type,n)==="model_selection"?Z((l(),r("select",{key:0,"onUpdate:modelValue":a=>t.data[n]=a,class:"ml-auto w-24 h-5 text-[9px] border rounded px-0 bg-gray-50 dark:bg-gray-900 focus:ring-1 focus:ring-blue-500 focus:outline-none",onMousedown:o[1]||(o[1]=g(()=>{},["stop"]))},[(l(!0),r(x,null,w(De(Y).availableLLMModelsGrouped,a=>(l(),r("optgroup",{key:a.label,label:a.label},[(l(!0),r(x,null,w(a.items,p=>(l(),r("option",{key:p.id,value:p.id},M(p.name),9,tt))),128))],8,et))),128))],40,Qe)),[[Ne,t.data[n]]]):["input_text","combiner","loop_executor"].includes(t.type)||t.type.includes("generate")?Z((l(),r("input",{key:1,"onUpdate:modelValue":a=>t.data[n]=a,class:"ml-auto w-20 h-5 text-[9px] border rounded px-1 bg-gray-50 dark:bg-gray-900 focus:ring-1 focus:ring-blue-500 focus:outline-none",placeholder:"Val",onMousedown:o[2]||(o[2]=g(()=>{},["stop"]))},null,40,ot)),[[Se,t.data[n]]]):b("",!0)],64))]))),128)),(l(!0),r(x,null,w(t.outputs,n=>(l(),r("div",{key:n,class:"flex items-center justify-end relative h-6"},[s("span",nt,M(n),1),s("div",{class:D(["w-3.5 h-3.5 rounded-full border-2 border-white dark:border-gray-800 absolute -right-[1.1rem] cursor-crosshair hover:scale-125 shadow-sm transition-transform",B(W(t.type,n))]),onMousedown:g(a=>U(a,t.id,n,"output"),["stop"]),onMouseup:g(a=>F(a,t.id,n,"output"),["stop"]),title:W(t.type,n)},null,42,st)]))),128))])],46,Ue))),128))],4)],32),(l(),V(Q,{to:"body"},[H.value?(l(),V(Pe,{key:0,nodeToEdit:L.value,onClose:o[3]||(o[3]=t=>{H.value=!1,L.value=null})},null,8,["nodeToEdit"])):b("",!0)])),(l(),V(Q,{to:"body"},[C.value?(l(),r("div",at,[s("div",lt,[o[8]||(o[8]=s("h3",{class:"text-xl font-bold mb-4 text-gray-800 dark:text-gray-100"},"Welcome to Flow Studio",-1)),o[9]||(o[9]=s("div",{class:"space-y-4 text-sm text-gray-600 dark:text-gray-300"},[s("p",null,"Build powerful AI workflows visually."),s("ul",{class:"list-disc pl-5 space-y-1"},[s("li",null,[s("strong",null,"Add Nodes:"),m(" Drag items from the left palette onto the canvas.")]),s("li",null,[s("strong",null,"Connect:"),m(" Drag from an output circle (right) to an input circle (left). Match colors for data types!")]),s("li",null,[s("strong",null,"Configure:"),m(" Type values directly into input fields or use selectors on nodes. If a link is connected, the widget hides.")]),s("li",null,[s("strong",null,"Run:"),m(' Click "Run Flow" in the top bar to execute.')]),s("li",null,[s("strong",null,"Admins:"),m(' Can define custom node logic using Python by clicking the Pencil icon or "Define Node".')])])],-1)),s("div",rt,[s("button",{onClick:o[4]||(o[4]=t=>C.value=!1),class:"btn btn-primary px-6"},"Got it")])])])):b("",!0)]))]))}},gt=he(it,[["__scopeId","data-v-577446eb"]]);export{gt as default};
