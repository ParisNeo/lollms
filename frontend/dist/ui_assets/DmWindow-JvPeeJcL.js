import{V as P,q as Q,u as W,r as f,h as _,l as X,x as Y,d as r,o,a as e,e as b,c as Z,z as i,M as ee,X as te,t as m,w as se,j as w,H as ae,ad as ne,Q as V,aj as oe,i as d,a2 as j,F as C,A as I,n as k,S as re,b as ie,K as le,f as ce,R as ue,v as de,D as ve,ak as pe,m as fe}from"./index-CGf9GErn.js";const me={class:"flex flex-col h-full bg-white dark:bg-gray-900"},ge={class:"flex items-center p-3 border-b dark:border-gray-700 bg-gray-50 dark:bg-gray-800 justify-between"},be={class:"flex items-center gap-2 overflow-hidden"},he={key:2,class:"w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center font-bold text-gray-700"},ye={class:"font-bold truncate"},ke={class:"flex items-center gap-1"},xe={key:0,class:"text-xs opacity-75 mb-1 font-bold text-blue-600 dark:text-blue-400"},_e=["onClick"],we={class:"text-[10px] text-gray-400 mt-1 px-1"},Ce={class:"p-3 border-t dark:border-gray-700 bg-gray-50 dark:bg-gray-800"},Ie={key:0,class:"flex gap-2 mb-2 overflow-x-auto pb-1"},Se={class:"truncate max-w-[100px]"},$e=["onClick"],De={class:"flex gap-2"},Ge=["disabled"],Te={__name:"DmWindow",props:{conversation:Object,compact:Boolean},emits:["back"],setup(g,{emit:B}){const a=g,N=B,v=P(),c=Q(),S=W(),p=f(""),h=f(null),$=f(null),D=f(null),l=f([]),x=f(!1),F=_(()=>a.conversation.messages),y=_(()=>{var s;return a.conversation.isGroup?a.conversation.name:(s=a.conversation.partner)==null?void 0:s.username});_(()=>c.user);function L(){$.value.click()}function A(s){l.value=Array.from(s.target.files)}async function G(){if(!(!p.value.trim()&&l.value.length===0)){x.value=!0;try{await v.sendDirectMessage({targetId:a.conversation.id,isGroup:a.conversation.isGroup,content:p.value,files:l.value}),p.value="",l.value=[]}finally{x.value=!1}}}function M(){fe(()=>{h.value&&(h.value.scrollTop=h.value.scrollHeight)})}X(()=>a.conversation.messages.length,M),Y(M);function O(s){S.openImageViewer({imageList:[{src:s,prompt:"DM Image"}],startIndex:0})}function U(s){return new Date(s).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}function z(s){l.value.splice(s,1)}async function E(s){confirm("Delete this message?")&&await v.deleteMessage(s)}async function H(){const s=a.conversation.isGroup?"Leave this group?":"Clear conversation history?";confirm(s)&&(await v.deleteConversation(a.conversation.id,a.conversation.isGroup),a.compact?N("back"):v.activeConversationId=null)}async function K(){await v.exportConversation(a.conversation.id,a.conversation.isGroup,y.value)}function J(){D.value.click()}async function R(s){const n=s.target.files[0];n&&(await v.importConversation(a.conversation.id,a.conversation.isGroup,n),s.target.value="")}return(s,n)=>{var T;return o(),r("div",me,[e("div",ge,[e("div",be,[g.compact?(o(),r("button",{key:0,onClick:n[0]||(n[0]=t=>s.$emit("back")),class:"p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"},[i(ee,{class:"w-5 h-5"})])):b("",!0),g.conversation.isGroup?(o(),r("div",he,m(y.value[0]),1)):(o(),Z(te,{key:1,icon:(T=g.conversation.partner)==null?void 0:T.icon,username:y.value,"size-class":"w-8 h-8"},null,8,["icon","username"])),e("span",ye,m(y.value),1)]),e("div",ke,[i(oe,{icon:"ellipsis-vertical",buttonClass:"btn-icon p-1"},{default:se(()=>[e("button",{onClick:K,class:"menu-item"},[i(ae,{class:"w-4 h-4 mr-2"}),n[3]||(n[3]=w("Export JSON"))]),e("button",{onClick:J,class:"menu-item"},[i(ne,{class:"w-4 h-4 mr-2"}),n[4]||(n[4]=w("Import JSON"))]),n[5]||(n[5]=e("div",{class:"menu-divider"},null,-1)),e("button",{onClick:H,class:"menu-item text-red-500"},[i(V,{class:"w-4 h-4 mr-2"}),w(m(g.conversation.isGroup?"Leave Group":"Clear History"),1)])]),_:1}),e("input",{type:"file",ref_key:"importInput",ref:D,class:"hidden",accept:".json",onChange:R},null,544),e("button",{onClick:n[1]||(n[1]=t=>d(S).isChatSidebarOpen=!1),class:"p-1 rounded hover:bg-gray-200 dark:hover:bg-gray-700"},[i(j,{class:"w-5 h-5"})])])]),e("div",{ref_key:"messageContainer",ref:h,class:"flex-1 overflow-y-auto p-4 space-y-3"},[(o(!0),r(C,null,I(F.value,t=>(o(),r("div",{key:t.id,class:k(["flex flex-col group",t.sender_id===d(c).user.id?"items-end":"items-start"])},[e("div",{class:k(["relative max-w-[85%] p-2 rounded-lg text-sm shadow-sm border dark:border-gray-700",t.sender_id===d(c).user.id?"bg-blue-100 dark:bg-blue-900/30 border-blue-200 dark:border-blue-800":"bg-white dark:bg-gray-800"])},[a.conversation.isGroup&&t.sender_id!==d(c).user.id?(o(),r("div",xe,m(t.sender_username),1)):b("",!0),i(re,{content:t.content},null,8,["content"]),t.image_references&&t.image_references.length>0?(o(),r("div",{key:1,class:k(["mt-2 grid gap-2",t.image_references.length>1?"grid-cols-2":"grid-cols-1"])},[(o(!0),r(C,null,I(t.image_references,u=>(o(),r("div",{key:u,class:"relative group/img cursor-pointer"},[i(le,{src:u,class:"rounded-md max-h-48 object-cover w-full border dark:border-gray-600",onClick:ie(q=>O(u),["stop"])},null,8,["src","onClick"])]))),128))],2)):b("",!0),t.sender_id===d(c).user.id||d(c).user.is_admin?(o(),r("button",{key:2,onClick:u=>E(t.id),class:k(["absolute top-0 p-1 text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity",t.sender_id===d(c).user.id?"-left-8":"-right-8"]),title:"Delete"},[i(V,{class:"w-4 h-4"})],10,_e)):b("",!0)],2),e("span",we,m(U(t.sent_at)),1)],2))),128))],512),e("div",Ce,[l.value.length>0?(o(),r("div",Ie,[(o(!0),r(C,null,I(l.value,(t,u)=>(o(),r("div",{key:u,class:"relative bg-white dark:bg-gray-700 rounded border dark:border-gray-600 p-1 text-xs flex items-center shadow-sm"},[e("span",Se,m(t.name),1),e("button",{onClick:q=>z(u),class:"ml-2 text-red-500 hover:text-red-700"},[i(j,{class:"w-3 h-3"})],8,$e)]))),128))])):b("",!0),e("div",De,[e("button",{onClick:L,class:"btn-icon p-2"},[i(ue,{class:"w-5 h-5"})]),e("input",{type:"file",ref_key:"fileInput",ref:$,class:"hidden",multiple:"",onChange:A},null,544),ce(e("input",{"onUpdate:modelValue":n[2]||(n[2]=t=>p.value=t),onKeyup:ve(G,["enter"]),class:"input-field flex-1",placeholder:"Type a message...",autocomplete:"off"},null,544),[[de,p.value]]),e("button",{onClick:G,class:"btn-primary p-2 rounded",disabled:x.value||!p.value.trim()&&l.value.length===0},[i(pe,{class:"w-4 h-4"})],8,Ge)])])])}}};export{Te as _};
