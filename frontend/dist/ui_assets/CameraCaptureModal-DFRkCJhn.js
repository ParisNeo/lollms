import{u as D,aM as B,N as c,m as w,$ as U,a as k,o,w as C,b as d,e as n,g as l,d as I,h as A,aB as x,n as R,f as T,t as V}from"./index-CpNEmBDf.js";import{_ as z}from"./GenericModal-DyRxZVIy.js";const F={class:"relative aspect-video bg-black rounded-lg overflow-hidden"},O=["src"],$={key:1,class:"absolute inset-0 flex items-center justify-center text-white bg-black/70 p-4 z-20"},q={key:0,class:"text-center"},L={key:1,class:"text-center"},W={key:2},H=["disabled"],Q={__name:"CameraCaptureModal",setup(G){const u=D(),_=B(),r=c(null),s=c(null),a=c("idle"),i=c(null),v=c(null),m=c(!1),P=e=>{r.value=e};function g(){s.value&&s.value.getTracks().forEach(e=>e.stop()),r.value&&(r.value.srcObject=null,r.value.onplaying=null),s.value=null,a.value="idle",v.value=null,i.value=null,m.value=!1}w(()=>u.isModalOpen("cameraCapture"),e=>{e?r.value&&b():g()}),w(r,e=>{e&&u.isModalOpen("cameraCapture")&&b()}),U(g);async function b(){if(!(a.value==="requesting"||a.value==="streaming")){if(g(),a.value="requesting",!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){i.value="Camera access is not supported by your browser.",a.value="error";return}if(!r.value){i.value="Camera component did not load correctly. Please try again.",a.value="error";return}try{s.value=await navigator.mediaDevices.getUserMedia({video:!0}),r.value&&(r.value.srcObject=s.value,r.value.onplaying=()=>{a.value="streaming"})}catch(e){e.name==="NotAllowedError"||e.name==="PermissionDeniedError"?i.value="Camera access was denied. Please allow camera permissions in your browser settings.":e.name==="NotFoundError"||e.name==="DevicesNotFoundError"?i.value="No camera found. Please ensure a camera is connected and enabled.":i.value="An error occurred while accessing the camera.",a.value="error",console.error("Camera access error:",e)}}}function S(){if(!r.value||a.value!=="streaming")return;const e=document.createElement("canvas");e.width=r.value.videoWidth,e.height=r.value.videoHeight,e.getContext("2d").drawImage(r.value,0,0,e.width,e.height),v.value=e.toDataURL("image/jpeg"),a.value="captured",s.value&&s.value.getTracks().forEach(p=>p.stop())}function N(){b()}function E(e){const t=e.split(","),p=t[0].match(/:(.*?);/);if(!p)return null;const j=p[1],h=atob(t[1]);let f=h.length;const y=new Uint8Array(f);for(;f--;)y[f]=h.charCodeAt(f);return new Blob([y],{type:j})}async function M(){if(!(a.value!=="captured"||!v.value)){m.value=!0;try{const e=E(v.value);if(e){const t=new File([e],`webcam_capture_${Date.now()}.jpg`,{type:"image/jpeg"});await _.uploadImages([t]),u.addNotification("Photo saved to gallery!","success"),u.closeModal("cameraCapture")}else throw new Error("Could not convert captured image to a file.")}catch(e){u.addNotification("Failed to save photo.","error"),console.error("Save photo error:",e)}finally{m.value=!1}}}return(e,t)=>(o(),k(z,{"modal-name":"cameraCapture",title:"Take a Photo","max-width-class":"max-w-2xl"},{body:C(()=>[d("div",F,[d("video",{ref:P,autoplay:"",playsinline:"",class:R(["w-full h-full object-contain transition-opacity",{"opacity-100":a.value==="streaming","opacity-0":a.value!=="streaming"}])},null,2),a.value==="captured"?(o(),n("img",{key:0,src:v.value,class:"absolute inset-0 w-full h-full object-contain z-10",alt:"Captured Photo Preview"},null,8,O)):l("",!0),a.value!=="streaming"?(o(),n("div",$,[a.value==="requesting"?(o(),n("div",q,[T(x,{class:"w-8 h-8 mx-auto mb-2 animate-spin"}),t[1]||(t[1]=d("p",null,"Waiting for camera permission...",-1)),t[2]||(t[2]=d("p",{class:"text-xs text-gray-400 mt-1"},"Please check for a browser pop-up.",-1))])):l("",!0),a.value==="error"?(o(),n("p",L,V(i.value),1)):l("",!0),a.value==="idle"?(o(),n("p",W,"Initializing...")):l("",!0)])):l("",!0)])]),footer:C(()=>[d("button",{onClick:t[0]||(t[0]=p=>I(u).closeModal("cameraCapture")),class:"btn btn-secondary"},"Cancel"),t[4]||(t[4]=d("div",{class:"flex-grow"},null,-1)),a.value==="streaming"?(o(),n("button",{key:0,onClick:S,class:"btn btn-primary"},"Take Photo")):l("",!0),a.value==="captured"?(o(),n("button",{key:1,onClick:N,class:"btn btn-secondary"},"Retake")):l("",!0),a.value==="captured"?(o(),n("button",{key:2,onClick:M,class:"btn btn-primary",disabled:m.value},[m.value?(o(),k(x,{key:0,class:"w-5 h-5 mr-2 animate-spin"})):l("",!0),t[3]||(t[3]=A(" Save Photo "))],8,H)):l("",!0)]),_:1}))}};export{Q as default};
