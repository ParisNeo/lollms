import{a4 as K,R as Q,u as X,i as Y,c as _,T as Z,L as h,m as C,a as v,o as n,w as j,b as s,d as o,e as r,g as f,f as g,av as ee,n as b,h as d,aF as R,t as i,aD as O,az as se,a0 as T,aG as D,aN as te,ac as ae,F as V,r as E,an as le,aC as B,cH as M,aE as F,cA as ne,J as oe,M as re,P as z,ap as ie}from"./index-iFocv_fM.js";import{_ as de}from"./GenericModal-Brlmu_NN.js";import{_ as ue}from"./JsonRenderer-B8XUrscQ.js";import{I as ce}from"./IconUser-B_trEpqr.js";const ge={class:"space-y-4"},me={class:"flex items-center justify-between flex-wrap gap-2"},ve={class:"flex items-center gap-2"},pe=["disabled"],fe=["disabled"],be=["disabled"],xe={key:0,class:"p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg border dark:border-gray-600"},ye={class:"flex items-center justify-start space-x-6"},ke={class:"flex items-center space-x-4"},we={class:"flex items-center text-sm"},_e={class:"flex items-center text-sm"},he={class:"flex items-center text-sm"},Ce={class:"grid grid-cols-1 md:grid-cols-3 gap-6 h-[60vh]"},Te={class:"md:col-span-1 bg-white dark:bg-gray-800 rounded-lg shadow-sm overflow-hidden flex flex-col"},Se={class:"p-4 border-b dark:border-gray-700 flex-shrink-0 space-y-3"},Ie={class:"relative"},Le={class:"pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3"},Ae={class:"flex-grow overflow-y-auto"},Re={key:0,class:"p-4 text-center text-gray-500"},De={key:1,class:"p-4 text-center text-gray-500"},Me={key:2,class:"divide-y dark:divide-gray-700"},Ne=["onClick"],$e={class:"flex justify-between items-center mb-1"},Ue=["title"],je={class:"w-full bg-gray-200 rounded-full h-1.5 dark:bg-gray-600 mb-2"},Oe={key:0,class:"flex items-center text-xs text-gray-500 dark:text-gray-400"},Ve={class:"md:col-span-2 bg-white dark:bg-gray-800 rounded-lg shadow-sm flex flex-col h-full overflow-hidden"},Ee={key:0,class:"h-full flex items-center justify-center text-center p-4"},Be={key:1,class:"flex flex-col h-full"},Fe={class:"p-4 border-b dark:border-gray-700 flex-shrink-0"},ze=["title"],Ge={class:"text-xs text-gray-500 dark:text-gray-400 flex items-center"},Je={class:"ml-1 mr-2"},Pe={class:"flex-grow min-h-0 flex flex-col p-4 space-y-4 overflow-y-auto"},He={class:"space-y-3 text-sm flex-shrink-0"},We={class:"flex-shrink-0 mr-4"},qe={class:"flex-grow"},Ke={class:"grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2"},Qe={key:0,class:"info-details error",open:""},Xe={key:1,class:"mt-2"},Ye={class:"flex-grow min-h-0 flex flex-col pt-4 border-t dark:border-gray-700"},Ze={class:"font-semibold mb-2 flex-shrink-0 flex items-center justify-between"},es={class:"log-timestamp font-mono"},ss={class:"log-message-wrapper"},ts={key:0,class:"text-gray-400 italic"},as={__name:"TaskManager",setup(ls){const m=Q(),p=X(),x=Y(),G=_(()=>p.modalData("tasksManager")),N=_(()=>{var l;return(l=G.value)==null?void 0:l.initialTaskId}),{tasks:J,isLoadingTasks:S,activeTasksCount:I,isClearingTasks:L}=Z(m),t=h(null),y=h(null),u=h("all"),k=h(""),c=_(()=>[...J.value].sort((l,e)=>new Date(e.created_at)-new Date(l.created_at))),$=_(()=>{if(!k.value)return c.value;const l=k.value.toLowerCase();return c.value.filter(e=>e.name&&e.name.toLowerCase().includes(l)||e.id&&e.id.toLowerCase().includes(l)||e.owner_username&&e.owner_username.toLowerCase().includes(l))});C(()=>p.isModalOpen("tasksManager"),l=>{l&&(m.fetchTasks(u.value),N.value&&c.value.length>0?t.value=c.value.find(e=>e.id===N.value)||c.value[0]:c.value.length>0?t.value=c.value[0]:t.value=null)}),C(u,l=>{m.fetchTasks(l)}),C(c,l=>{if(t.value){const e=l.find(a=>a.id===t.value.id);e?JSON.stringify(t.value.logs)!==JSON.stringify(e.logs)?t.value=e:Object.assign(t.value,e):t.value=l.length>0?l[0]:null}else l.length>0&&(t.value=l[0])}),C(()=>{var l;return(l=t.value)==null?void 0:l.logs},()=>{ie(()=>{y.value&&(y.value.scrollTop=y.value.scrollHeight)})},{deep:!0});function A(l){return l?new Date(l).toLocaleString():"N/A"}function U(l){switch(l){case"running":return{text:"Running"};case"completed":return{text:"Completed",icon:F,color:"text-green-500"};case"failed":return{text:"Failed",icon:M,color:"text-red-500"};case"cancelled":return{text:"Cancelled",icon:R,color:"text-yellow-500"};case"pending":default:return{text:"Pending"}}}function P(l){switch(l==null?void 0:l.toUpperCase()){case"ERROR":case"CRITICAL":return"text-red-500 dark:text-red-400";case"WARNING":return"text-yellow-500 dark:text-yellow-400";default:return"text-gray-600 dark:text-gray-300"}}const H=l=>{switch(l==null?void 0:l.toUpperCase()){case"ERROR":case"CRITICAL":return M;case"WARNING":return z;default:return z}};async function W(){(await p.showConfirmation({title:"Cancel All Active Tasks",message:`Are you sure you want to cancel all ${I.value} active background tasks?`,confirmText:"Cancel All"})).confirmed&&await m.cancelAllTasks()}function q(){if(!t.value||!t.value.logs)return;const l=t.value.logs.map(e=>{const a=new Date(e.timestamp).toLocaleTimeString(),w=e.level.toUpperCase();return`[${a}] [${w}] ${e.message}`}).join(`
`);p.copyToClipboard(l,"Logs copied to clipboard!")}return(l,e)=>(n(),v(de,{"modal-name":"tasksManager",title:"Background Tasks","max-width-class":"max-w-6xl"},{body:j(()=>[s("div",ge,[s("div",me,[e[10]||(e[10]=s("p",{class:"text-sm text-gray-500"},"Monitor your background processes.",-1)),s("div",ve,[s("button",{onClick:e[0]||(e[0]=a=>o(m).fetchTasks(u.value)),class:"btn btn-secondary btn-sm",disabled:o(S)},[g(ee,{class:b(["w-4 h-4",{"animate-spin":o(S)}])},null,8,["class"])],8,pe),s("button",{onClick:W,class:"btn btn-warning btn-sm",disabled:o(I)===0||o(L)},[g(R,{class:"w-4 h-4 mr-1"}),d(" Cancel All ("+i(o(I))+") ",1)],8,fe),s("button",{onClick:e[1]||(e[1]=(...a)=>o(m).clearCompletedTasks&&o(m).clearCompletedTasks(...a)),class:"btn btn-danger btn-sm",disabled:o(L)},[o(L)?(n(),v(O,{key:0,class:"w-4 h-4 mr-1 animate-spin"})):(n(),v(se,{key:1,class:"w-4 h-4 mr-1"})),e[9]||(e[9]=d(" Clear Completed "))],8,be)])]),o(x).isAdmin?(n(),r("div",xe,[s("div",ye,[e[14]||(e[14]=s("span",{class:"text-sm font-medium"},"Show tasks for:",-1)),s("div",ke,[s("label",we,[T(s("input",{type:"radio","onUpdate:modelValue":e[2]||(e[2]=a=>u.value=a),value:"all",class:"form-radio"},null,512),[[D,u.value]]),e[11]||(e[11]=s("span",{class:"ml-2"},"All Users",-1))]),s("label",_e,[T(s("input",{type:"radio","onUpdate:modelValue":e[3]||(e[3]=a=>u.value=a),value:"me",class:"form-radio"},null,512),[[D,u.value]]),e[12]||(e[12]=s("span",{class:"ml-2"},"My Tasks",-1))]),s("label",he,[T(s("input",{type:"radio","onUpdate:modelValue":e[4]||(e[4]=a=>u.value=a),value:"others",class:"form-radio"},null,512),[[D,u.value]]),e[13]||(e[13]=s("span",{class:"ml-2"},"Other Users",-1))])])])])):f("",!0),s("div",Ce,[s("div",Te,[s("div",Se,[e[15]||(e[15]=s("h3",{class:"font-semibold"},"Tasks",-1)),s("div",Ie,[s("div",Le,[g(te,{class:"h-4 w-4 text-gray-400"})]),T(s("input",{type:"text","onUpdate:modelValue":e[5]||(e[5]=a=>k.value=a),placeholder:"Search tasks...",class:"w-full text-sm pl-9 pr-4 py-1.5 rounded-md border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700"},null,512),[[ae,k.value]])])]),s("div",Ae,[o(S)&&c.value.length===0?(n(),r("div",Re,"Loading...")):$.value.length===0?(n(),r("div",De,"No tasks found.")):(n(),r("ul",Me,[(n(!0),r(V,null,E($.value,a=>(n(),r("li",{key:a.id},[s("button",{onClick:w=>t.value=a,class:b(["w-full text-left p-4 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors",{"bg-blue-50 dark:bg-blue-900/30":t.value&&t.value.id===a.id}])},[s("div",$e,[s("p",{class:"font-medium truncate text-sm",title:a.name},i(a.name),9,Ue),s("span",{class:b(["text-xs px-2 py-0.5 rounded-full",{"bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-300":a.status==="running"||a.status==="pending","bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300":a.status==="completed","bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300":a.status==="failed","bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300":a.status==="cancelled"}])},i(U(a.status).text),3)]),s("div",je,[s("div",{class:b(["h-1.5 rounded-full",{"bg-blue-500":a.status==="running"||a.status==="pending","bg-green-500":a.status==="completed","bg-red-500":a.status==="failed","bg-yellow-500":a.status==="cancelled"}]),style:le({width:a.progress+"%"})},null,6)]),o(x).isAdmin?(n(),r("div",Oe,[g(ce,{class:"w-3 h-3 mr-1.5"}),s("span",null,i(a.owner_username||"System"),1)])):f("",!0)],10,Ne)]))),128))]))])]),s("div",Ve,[t.value?(n(),r("div",Be,[s("div",Fe,[s("h3",{class:"font-semibold truncate",title:t.value.name},i(t.value.name),9,ze),s("div",Ge,[e[17]||(e[17]=d("ID: ")),s("code",Je,i(t.value.id),1),s("button",{onClick:e[6]||(e[6]=a=>o(p).copyToClipboard(t.value.id)),class:"p-0.5 rounded hover:bg-gray-200 dark:hover:bg-gray-600"},[g(B,{class:"w-3 h-3"})])])]),s("div",Pe,[s("div",He,[s("div",{class:b(["p-3 rounded-lg flex items-center",{"bg-blue-50 dark:bg-blue-900/20":t.value.status==="running"||t.value.status==="pending","bg-green-50 dark:bg-green-900/20":t.value.status==="completed","bg-red-50 dark:bg-red-900/20":t.value.status==="failed","bg-yellow-50 dark:bg-yellow-900/20":t.value.status==="cancelled"}])},[s("div",We,[t.value.status==="failed"?(n(),v(M,{key:0,class:"w-8 h-8 text-red-400"})):t.value.status==="completed"?(n(),v(F,{key:1,class:"w-8 h-8 text-green-400"})):t.value.status==="cancelled"?(n(),v(R,{key:2,class:"w-8 h-8 text-yellow-400"})):(n(),v(O,{key:3,class:"w-8 h-8 text-blue-400 animate-spin"}))]),s("div",qe,[e[18]||(e[18]=s("span",{class:"font-semibold"},"Status:",-1)),d(" "+i(U(t.value.status).text),1)]),(t.value.status==="running"||t.value.status==="pending")&&(o(x).isAdmin||t.value.owner_username===o(x).user.username)?(n(),r("button",{key:0,onClick:e[7]||(e[7]=a=>o(m).cancelTask(t.value.id)),class:"btn btn-warning btn-sm"},[g(ne,{class:"w-4 h-4 mr-1"}),e[19]||(e[19]=d("Cancel Task "))])):f("",!0)],2),s("div",Ke,[s("p",null,[e[20]||(e[20]=s("strong",null,"Owner:",-1)),d(" "+i(t.value.owner_username||"System"),1)]),s("p",null,[e[21]||(e[21]=s("strong",null,"Created:",-1)),d(" "+i(A(t.value.created_at)),1)]),s("p",null,[e[22]||(e[22]=s("strong",null,"Started:",-1)),d(" "+i(A(t.value.started_at)),1)]),s("p",null,[e[23]||(e[23]=s("strong",null,"Completed:",-1)),d(" "+i(A(t.value.completed_at)),1)])]),t.value.error?(n(),r("details",Qe,[e[24]||(e[24]=s("summary",null,"Error Details",-1)),s("pre",null,i(t.value.error),1)])):f("",!0),t.value.result?(n(),r("div",Xe,[e[25]||(e[25]=s("h4",{class:"text-xs font-semibold uppercase text-gray-500 dark:text-gray-400 mb-1"},"Result Data",-1)),g(ue,{json:t.value.result},null,8,["json"])])):f("",!0)]),s("div",Ye,[s("h4",Ze,[e[27]||(e[27]=s("span",null,"Logs",-1)),s("button",{onClick:q,class:"btn btn-secondary btn-sm"},[g(B,{class:"w-4 h-4"}),e[26]||(e[26]=d(" Copy Logs"))])]),s("div",{ref_key:"logsContainer",ref:y,class:"flex-grow bg-gray-100 dark:bg-gray-900 rounded p-2 overflow-y-auto text-xs"},[(n(!0),r(V,null,E(t.value.logs,(a,w)=>(n(),r("div",{key:w,class:b(["log-entry",P(a.level)])},[s("span",es,i(new Date(a.timestamp).toLocaleTimeString([],{hour12:!1})),1),(n(),v(oe(H(a.level)),{class:"log-icon"})),s("div",ss,[g(re,{content:a.message,class:"log-message prose dark:prose-invert prose-sm max-w-none"},null,8,["content"])])],2))),128)),!t.value.logs||t.value.logs.length===0?(n(),r("div",ts,"No logs for this task yet.")):f("",!0)],512)])])])):(n(),r("div",Ee,e[16]||(e[16]=[s("p",{class:"text-gray-500"},"Select a task to view its details and logs.",-1)])))])])])]),footer:j(()=>[s("button",{onClick:e[8]||(e[8]=a=>o(p).closeModal("tasksManager")),class:"btn btn-primary"},"Close")]),_:1}))}},ds=K(as,[["__scopeId","data-v-32b28335"]]);export{ds as default};
