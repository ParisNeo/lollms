const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["ui_assets/index-CEXks4lv.js","ui_assets/index-MA3P6vxv.css"])))=>i.map(i=>d[i]);
import{a as Z,N as ee,K as te,Q as se,c as f,s as u,w as ae,o as ie,n as oe,l as v,g as T,e,j as $,d as m,h as b,t as n,m as j,p as N,z as M,R as V,F as re,i as ne,f as A,U as le,Y as de,D as ce}from"./index-CEXks4lv.js";import{_ as ue}from"./GenericModal-Br5hR2Sz.js";import{M as ve}from"./MultiSelectMenu-C0DBz24e.js";const he={class:"space-y-6"},me={class:"bg-gray-50 dark:bg-gray-800/50 rounded-lg p-4"},fe={class:"flex items-start justify-between"},ge={class:"flex-1 min-w-0"},pe=["title"],_e={class:"flex items-center gap-4 mt-2 text-xs text-gray-500 dark:text-gray-400"},we={class:"space-y-3"},ye={class:"flex items-center justify-between"},xe={class:"font-medium text-gray-700 dark:text-gray-300"},be={key:0,class:"flex items-center gap-2"},ke={key:0,class:"flex items-center gap-2"},Se=["disabled"],Ce={key:0,class:"text-center py-8"},Le={key:1,class:"text-center py-8 border-2 border-dashed border-gray-200 dark:border-gray-700 rounded-lg"},$e={key:2,class:"max-h-64 overflow-y-auto space-y-2 pr-2"},Ne=["checked","onChange"],Me={class:"flex items-center gap-3 flex-1 min-w-0"},Ve={class:"flex-1 min-w-0"},Ae={class:"flex items-center gap-2"},De={class:"font-medium text-gray-900 dark:text-gray-100 truncate"},Ie={class:"text-xs text-gray-500 dark:text-gray-400"},Ue={class:"flex items-center gap-2 flex-shrink-0"},Fe=["onUpdate:modelValue","onChange"],ze=["onClick","title"],Be={class:"space-y-4 border-t border-gray-200 dark:border-gray-700 pt-6"},Re={class:"flex items-center justify-between"},Pe={class:"font-medium text-gray-700 dark:text-gray-300"},Te=["disabled"],je={class:"grid grid-cols-1 sm:grid-cols-2 gap-4"},Oe=["disabled"],We={class:"flex items-center justify-between w-full"},Ee={class:"flex items-center gap-2"},He={key:0,class:"text-sm text-gray-600 dark:text-gray-400"},Qe=["disabled"],qe={key:0,class:"animate-spin -ml-1 mr-2 h-4 w-4 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24"},Ze={__name:"ShareDiscussionModal",setup(Ke){const D=Z(),p=ee(),o=te(),{friends:I,isLoadingFriends:U}=se(D),F=f(()=>o.modalProps.shareDiscussion),d=f(()=>{var t;return(t=F.value)==null?void 0:t.discussionId}),z=f(()=>{var t;return(t=F.value)==null?void 0:t.title}),r=u([]),k=u(!1),c=u([]),S=u("view"),_=u(!1),C=u("");u(!1);const h=u(""),l=u(new Set),y=u(!1),B=f(()=>{const t=new Set(r.value.map(i=>i.shared_with_user_id)),s=(I.value||[]).filter(i=>!t.has(i.id)).map(i=>({id:i.id,name:i.username,icon:i.icon,email:i.email||"",lastActive:i.last_active||null}));if(!C.value)return s;const a=C.value.toLowerCase();return s.filter(i=>i.name.toLowerCase().includes(a)||i.email.toLowerCase().includes(a))}),x=f(()=>({total:r.value.length,canView:r.value.filter(t=>t.permission_level==="view").length,canInteract:r.value.filter(t=>t.permission_level==="interact").length})),R=f(()=>l.value.size>0),w=f(()=>r.value.length<50);async function L(){try{await D.fetchFriends(),o.addNotification("Friends list refreshed","success")}catch{o.addNotification("Failed to refresh friends list","error")}}async function g(){if(d.value){k.value=!0;try{const t=await(await ce(async()=>{const{default:s}=await import("./index-CEXks4lv.js").then(a=>a.ey);return{default:s}},__vite__mapDeps([0,1]))).default.get(`/api/discussions/${d.value}/shared-with`);r.value=t.data}catch(t){console.error("Failed to fetch shared with list:",t),o.addNotification("Could not load sharing information.","error"),r.value=[]}finally{k.value=!1}}}ae(d,t=>{t?(g(),L(),c.value=[],l.value.clear(),C.value=""):r.value=[]},{immediate:!0}),ie(()=>{d.value&&(g(),L())});async function O(){if(c.value.length===0){o.addNotification("Please select at least one friend to add.","warning");return}if(!w.value){o.addNotification("Maximum share limit reached.","warning");return}_.value=!0;const t=[];let s=0;try{const a=c.value.map(async i=>{var P;try{await p.shareDiscussion({discussionId:d.value,targetUserId:i,permissionLevel:S.value}),s++}catch{const J=((P=I.value.find(X=>X.id===i))==null?void 0:P.username)||"Unknown";t.push(`Failed to share with ${J}`)}});await Promise.all(a),s>0&&o.addNotification(`Successfully shared with ${s} friend${s>1?"s":""}.`,"success"),t.length>0&&t.forEach(i=>o.addNotification(i,"error")),c.value=[],await g()}finally{_.value=!1}}async function W(t){const s=t.permission_level;try{await p.shareDiscussion({discussionId:d.value,targetUserId:t.shared_with_user_id,permissionLevel:t.permission_level}),o.addNotification(`Updated ${t.shared_with_username}'s permissions to ${t.permission_level}`,"success"),await g()}catch{t.permission_level=s,o.addNotification(`Failed to update permissions for ${t.shared_with_username}`,"error")}}async function E(t){if(confirm(`Are you sure you want to revoke access for ${t.shared_with_username}?`))try{await p.revokeShare({discussionId:d.value,shareId:t.share_id}),o.addNotification(`Revoked access for ${t.shared_with_username}`,"success"),await g()}catch{o.addNotification(`Failed to revoke access for ${t.shared_with_username}`,"error")}}async function H(){if(!R.value||!h.value)return;const t=r.value.filter(s=>l.value.has(s.share_id));if(h.value==="revoke"){if(!confirm(`Are you sure you want to revoke access for ${t.length} user(s)?`))return;for(const s of t)try{await p.revokeShare({discussionId:d.value,shareId:s.share_id})}catch(a){console.error(`Failed to revoke ${s.shared_with_username}:`,a)}o.addNotification(`Revoked access for ${t.length} user(s)`,"success")}else if(h.value==="view"||h.value==="interact"){for(const s of t)try{await p.shareDiscussion({discussionId:d.value,targetUserId:s.shared_with_user_id,permissionLevel:h.value})}catch(a){console.error(`Failed to update ${s.shared_with_username}:`,a)}o.addNotification(`Updated permissions for ${t.length} user(s)`,"success")}l.value.clear(),h.value="",await g()}function Q(){l.value.size===r.value.length?l.value.clear():l.value=new Set(r.value.map(t=>t.share_id))}function q(t){l.value.has(t)?l.value.delete(t):l.value.add(t)}async function K(){try{const t=`${window.location.origin}/discussions/${d.value}`;await navigator.clipboard.writeText(t),y.value=!0,o.addNotification("Shareable link copied to clipboard","success"),setTimeout(()=>{y.value=!1},2e3)}catch{o.addNotification("Failed to copy link","error")}}function Y(t){return t==="interact"?"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400":"bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400"}function G(t){return new Intl.DateTimeFormat("en-US",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}).format(new Date(t))}return(t,s)=>(v(),oe(ue,{modalName:"shareDiscussion",title:"Share Discussion",maxWidthClass:"max-w-3xl"},{body:T(()=>[e("div",he,[e("div",me,[e("div",fe,[e("div",ge,[s[4]||(s[4]=e("p",{class:"text-sm text-gray-600 dark:text-gray-400 mb-1"},"Sharing:",-1)),e("h3",{class:"font-semibold text-gray-900 dark:text-gray-100 truncate",title:z.value},n(z.value||"Untitled Discussion"),9,pe),e("div",_e,[e("span",null,n(x.value.total)+" shares",1),e("span",null,n(x.value.canView)+" viewers",1),e("span",null,n(x.value.canInteract)+" contributors",1)])]),e("button",{onClick:K,class:N(["btn btn-secondary btn-sm",{"btn-success":y.value}])},[s[5]||(s[5]=e("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-4 w-4 mr-1",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"})],-1)),j(" "+n(y.value?"Copied!":"Copy Link"),1)],2)])]),e("div",we,[e("div",ye,[e("h3",xe,"Shared With ("+n(x.value.total)+")",1),r.value.length>0?(v(),m("div",be,[e("button",{onClick:Q,class:"text-xs text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200"},n(l.value.size===r.value.length?"Deselect All":"Select All"),1),R.value?(v(),m("div",ke,[M(e("select",{"onUpdate:modelValue":s[0]||(s[0]=a=>h.value=a),class:"input-field !py-1 !text-xs"},s[6]||(s[6]=[e("option",{value:""},"Bulk Action",-1),e("option",{value:"view"},"Set to View Only",-1),e("option",{value:"interact"},"Set to Interact",-1),e("option",{value:"revoke"},"Revoke Access",-1)]),512),[[V,h.value]]),e("button",{onClick:H,disabled:!h.value,class:"btn btn-primary btn-sm"},"Apply",8,Se)])):b("",!0)])):b("",!0)]),k.value?(v(),m("div",Ce,s[7]||(s[7]=[e("div",{class:"animate-spin inline-block w-6 h-6 border-2 border-gray-300 border-t-blue-600 rounded-full"},null,-1),e("p",{class:"text-sm text-gray-500 mt-2"},"Loading shares...",-1)]))):r.value.length===0?(v(),m("div",Le,s[8]||(s[8]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",class:"mx-auto h-12 w-12 text-gray-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"})],-1),e("p",{class:"text-sm text-gray-500 mt-2"},"Not shared with anyone yet",-1),e("p",{class:"text-xs text-gray-400"},"Add friends below to start sharing",-1)]))):(v(),m("div",$e,[(v(!0),m(re,null,ne(r.value,a=>(v(),m("div",{key:a.share_id,class:"flex items-center gap-3 p-3 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 hover:shadow-sm transition-all"},[e("input",{type:"checkbox",checked:l.value.has(a.share_id),onChange:i=>q(a.share_id),class:"rounded border-gray-300 text-blue-600 focus:ring-blue-500 dark:border-gray-600"},null,40,Ne),e("div",Me,[A(le,{icon:a.shared_with_user_icon,username:a.shared_with_username,"size-class":"h-10 w-10"},null,8,["icon","username"]),e("div",Ve,[e("div",Ae,[e("span",De,n(a.shared_with_username),1),e("span",{class:N(["inline-flex items-center px-2 py-0.5 rounded text-xs font-medium",Y(a.permission_level)])},n(a.permission_level==="interact"?"Can Interact":"View Only"),3)]),e("p",Ie,"Shared "+n(G(a.shared_at)),1)])]),e("div",Ue,[M(e("select",{"onUpdate:modelValue":i=>a.permission_level=i,onChange:i=>W(a),class:"input-field !py-1 !text-xs w-28"},s[9]||(s[9]=[e("option",{value:"view"},"View Only",-1),e("option",{value:"interact"},"Can Interact",-1)]),40,Fe),[[V,a.permission_level]]),e("button",{onClick:i=>E(a),class:"btn btn-danger btn-sm !p-1.5",title:`Revoke access for ${a.shared_with_username}`},s[10]||(s[10]=[e("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-4 w-4",viewBox:"0 0 20 20",fill:"currentColor"},[e("path",{"fill-rule":"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z","clip-rule":"evenodd"})],-1)]),8,ze)])]))),128))]))]),e("div",Be,[e("div",Re,[e("h4",Pe,"Add More Friends "+n(w.value?"":"(Limit Reached)"),1),e("button",{onClick:L,class:"btn-icon",title:"Refresh friends list",disabled:$(U)},[A(de,{class:N(["w-4 h-4",{"animate-spin":$(U)}])},null,8,["class"])],8,Te)]),A(ve,{modelValue:c.value,"onUpdate:modelValue":s[1]||(s[1]=a=>c.value=a),items:B.value,placeholder:"Select friends to share with...",disabled:B.value.length===0||!w.value,"max-selections":10},null,8,["modelValue","items","disabled"]),e("div",je,[e("div",null,[s[12]||(s[12]=e("label",{for:"permission-level-add",class:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2"},"Permission Level",-1)),M(e("select",{id:"permission-level-add","onUpdate:modelValue":s[2]||(s[2]=a=>S.value=a),class:"input-field w-full",disabled:!w.value},s[11]||(s[11]=[e("option",{value:"view"},"View Only",-1),e("option",{value:"interact"},"Can Interact",-1)]),8,Oe),[[V,S.value]])])])])])]),footer:T(()=>[e("div",We,[e("button",{onClick:s[3]||(s[3]=a=>$(o).closeModal("shareDiscussion")),type:"button",class:"btn btn-secondary"},"Close"),e("div",Ee,[c.value.length>0?(v(),m("span",He,"Selected: "+n(c.value.length),1)):b("",!0),e("button",{onClick:O,disabled:c.value.length===0||_.value||!w.value,class:"btn btn-primary"},[_.value?(v(),m("svg",qe,s[13]||(s[13]=[e("circle",{class:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"4"},null,-1),e("path",{class:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"},null,-1)]))):b("",!0),j(" "+n(_.value?"Sharing...":`Share with ${c.value.length||""}`),1)],8,Qe)])])]),_:1}))}};export{Ze as default};
