import{q as H,d as r,l as n,e as s,aa as Q,K as X,u as Y,c as _,W as ee,s as h,w as C,T as se,n as m,g as V,j as o,h as f,f as v,a0 as te,p as x,m as u,aq as M,t as i,ao as O,ai as le,z as T,as as R,ck as ae,Q as ne,F as j,i as B,a5 as oe,an as E,cV as N,ap as F,cN as re,C as ie,M as de,am as z}from"./index-jm3TVsJn.js";import{_ as ue}from"./GenericModal-DwAlicWF.js";const ce={},ge={width:"50px",height:"50px",viewBox:"0 0 16 16",fill:"none",xmlns:"http://www.w3.org/2000/svg"};function me(J,d){return n(),r("svg",ge,d[0]||(d[0]=[s("path",{d:"M8 7C9.65685 7 11 5.65685 11 4C11 2.34315 9.65685 1 8 1C6.34315 1 5 2.34315 5 4C5 5.65685 6.34315 7 8 7Z",fill:"currentColor"},null,-1),s("path",{d:"M14 12C14 10.3431 12.6569 9 11 9H5C3.34315 9 2 10.3431 2 12V15H14V12Z",fill:"currentColor"},null,-1)]))}const ve=H(ce,[["render",me]]),pe={class:"space-y-4"},fe={class:"flex items-center justify-between flex-wrap gap-2"},xe={class:"flex items-center gap-2"},be=["disabled"],ye=["disabled"],ke=["disabled"],we={key:0,class:"p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg border dark:border-gray-600"},_e={class:"flex items-center justify-start space-x-6"},he={class:"flex items-center space-x-4"},Ce={class:"flex items-center text-sm"},Te={class:"flex items-center text-sm"},Se={class:"flex items-center text-sm"},Ie={class:"grid grid-cols-1 md:grid-cols-3 gap-6 h-[60vh]"},Le={class:"md:col-span-1 bg-white dark:bg-gray-800 rounded-lg shadow-sm overflow-hidden flex flex-col"},Ae={class:"p-4 border-b dark:border-gray-700 flex-shrink-0 space-y-3"},Me={class:"relative"},Re={class:"pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3"},Ne={class:"flex-grow overflow-y-auto"},$e={key:0,class:"p-4 text-center text-gray-500"},De={key:1,class:"p-4 text-center text-gray-500"},Ue={key:2,class:"divide-y dark:divide-gray-700"},Ve=["onClick"],Oe={class:"flex justify-between items-center mb-1"},je=["title"],Be={class:"w-full bg-gray-200 rounded-full h-1.5 dark:bg-gray-600 mb-2"},Ee={key:0,class:"flex items-center text-xs text-gray-500 dark:text-gray-400"},Fe={class:"md:col-span-2 bg-white dark:bg-gray-800 rounded-lg shadow-sm flex flex-col h-full overflow-hidden"},ze={key:0,class:"h-full flex items-center justify-center text-center p-4"},He={key:1,class:"flex flex-col h-full"},Je={class:"p-4 border-b dark:border-gray-700 flex-shrink-0"},We=["title"],qe={class:"text-xs text-gray-500 dark:text-gray-400 flex items-center"},Ge={class:"ml-1 mr-2"},Ze={class:"flex-grow min-h-0 flex flex-col p-4 space-y-4 overflow-y-auto"},Ke={class:"space-y-3 text-sm flex-shrink-0"},Pe={class:"flex-shrink-0 mr-4"},Qe={class:"flex-grow"},Xe={class:"grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2"},Ye={key:0,class:"info-details error",open:""},es={key:1,class:"info-details success"},ss={class:"flex-grow min-h-0 flex flex-col pt-4 border-t dark:border-gray-700"},ts={class:"font-semibold mb-2 flex-shrink-0 flex items-center justify-between"},ls={class:"log-timestamp font-mono"},as={class:"log-message-wrapper"},ns={key:0,class:"text-gray-400 italic"},os={__name:"TasksManagerModal",setup(J){const d=Q(),p=X(),b=Y(),W=_(()=>p.modalData("tasksManager")),$=_(()=>{var a;return(a=W.value)==null?void 0:a.initialTaskId}),{tasks:q,isLoadingTasks:S,activeTasksCount:I,isClearingTasks:L}=ee(d),t=h(null),y=h(null),c=h("all"),k=h(""),g=_(()=>[...q.value].sort((a,e)=>new Date(e.created_at)-new Date(a.created_at))),D=_(()=>{if(!k.value)return g.value;const a=k.value.toLowerCase();return g.value.filter(e=>e.name&&e.name.toLowerCase().includes(a)||e.id&&e.id.toLowerCase().includes(a)||e.owner_username&&e.owner_username.toLowerCase().includes(a))});C(()=>p.isModalOpen("tasksManager"),a=>{a&&(d.fetchTasks(c.value),$.value&&g.value.length>0?t.value=g.value.find(e=>e.id===$.value)||g.value[0]:g.value.length>0?t.value=g.value[0]:t.value=null)}),C(c,a=>{d.fetchTasks(a)}),C(g,a=>{if(t.value){const e=a.find(l=>l.id===t.value.id);e?JSON.stringify(t.value.logs)!==JSON.stringify(e.logs)?t.value=e:Object.assign(t.value,e):t.value=a.length>0?a[0]:null}else a.length>0&&(t.value=a[0])}),C(()=>{var a;return(a=t.value)==null?void 0:a.logs},()=>{se(()=>{y.value&&(y.value.scrollTop=y.value.scrollHeight)})},{deep:!0});function A(a){return a?new Date(a).toLocaleString():"N/A"}function U(a){switch(a){case"running":return{text:"Running"};case"completed":return{text:"Completed",icon:F,color:"text-green-500"};case"failed":return{text:"Failed",icon:N,color:"text-red-500"};case"cancelled":return{text:"Cancelled",icon:M,color:"text-yellow-500"};case"pending":default:return{text:"Pending"}}}function G(a){switch(a==null?void 0:a.toUpperCase()){case"ERROR":case"CRITICAL":return"text-red-500 dark:text-red-400";case"WARNING":return"text-yellow-500 dark:text-yellow-400";default:return"text-gray-600 dark:text-gray-300"}}const Z=a=>{switch(a==null?void 0:a.toUpperCase()){case"ERROR":case"CRITICAL":return N;case"WARNING":return z;default:return z}};async function K(){(await p.showConfirmation({title:"Cancel All Active Tasks",message:`Are you sure you want to cancel all ${I.value} active background tasks?`,confirmText:"Cancel All"})).confirmed&&await d.cancelAllTasks()}function P(){if(!t.value||!t.value.logs)return;const a=t.value.logs.map(e=>{const l=new Date(e.timestamp).toLocaleTimeString(),w=e.level.toUpperCase();return`[${l}] [${w}] ${e.message}`}).join(`
`);p.copyToClipboard(a,"Logs copied to clipboard!")}return(a,e)=>(n(),m(ue,{"modal-name":"tasksManager",title:"Background Tasks","max-width-class":"max-w-6xl"},{body:V(()=>[s("div",pe,[s("div",fe,[e[10]||(e[10]=s("p",{class:"text-sm text-gray-500"},"Monitor your background processes.",-1)),s("div",xe,[s("button",{onClick:e[0]||(e[0]=l=>o(d).fetchTasks(c.value)),class:"btn btn-secondary btn-sm",disabled:o(S)},[v(te,{class:x(["w-4 h-4",{"animate-spin":o(S)}])},null,8,["class"])],8,be),s("button",{onClick:K,class:"btn btn-warning btn-sm",disabled:o(I)===0||o(L)},[v(M,{class:"w-4 h-4 mr-1"}),u(" Cancel All ("+i(o(I))+") ",1)],8,ye),s("button",{onClick:e[1]||(e[1]=(...l)=>o(d).clearCompletedTasks&&o(d).clearCompletedTasks(...l)),class:"btn btn-danger btn-sm",disabled:o(L)},[o(L)?(n(),m(O,{key:0,class:"w-4 h-4 mr-1 animate-spin"})):(n(),m(le,{key:1,class:"w-4 h-4 mr-1"})),e[9]||(e[9]=u(" Clear Completed "))],8,ke)])]),o(b).isAdmin?(n(),r("div",we,[s("div",_e,[e[14]||(e[14]=s("span",{class:"text-sm font-medium"},"Show tasks for:",-1)),s("div",he,[s("label",Ce,[T(s("input",{type:"radio","onUpdate:modelValue":e[2]||(e[2]=l=>c.value=l),value:"all",class:"form-radio"},null,512),[[R,c.value]]),e[11]||(e[11]=s("span",{class:"ml-2"},"All Users",-1))]),s("label",Te,[T(s("input",{type:"radio","onUpdate:modelValue":e[3]||(e[3]=l=>c.value=l),value:"me",class:"form-radio"},null,512),[[R,c.value]]),e[12]||(e[12]=s("span",{class:"ml-2"},"My Tasks",-1))]),s("label",Se,[T(s("input",{type:"radio","onUpdate:modelValue":e[4]||(e[4]=l=>c.value=l),value:"others",class:"form-radio"},null,512),[[R,c.value]]),e[13]||(e[13]=s("span",{class:"ml-2"},"Other Users",-1))])])])])):f("",!0),s("div",Ie,[s("div",Le,[s("div",Ae,[e[15]||(e[15]=s("h3",{class:"font-semibold"},"Tasks",-1)),s("div",Me,[s("div",Re,[v(ae,{class:"h-4 w-4 text-gray-400"})]),T(s("input",{type:"text","onUpdate:modelValue":e[5]||(e[5]=l=>k.value=l),placeholder:"Search tasks...",class:"w-full text-sm pl-9 pr-4 py-1.5 rounded-md border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700"},null,512),[[ne,k.value]])])]),s("div",Ne,[o(S)&&g.value.length===0?(n(),r("div",$e,"Loading...")):D.value.length===0?(n(),r("div",De,"No tasks found.")):(n(),r("ul",Ue,[(n(!0),r(j,null,B(D.value,l=>(n(),r("li",{key:l.id},[s("button",{onClick:w=>t.value=l,class:x(["w-full text-left p-4 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors",{"bg-blue-50 dark:bg-blue-900/30":t.value&&t.value.id===l.id}])},[s("div",Oe,[s("p",{class:"font-medium truncate text-sm",title:l.name},i(l.name),9,je),s("span",{class:x(["text-xs px-2 py-0.5 rounded-full",{"bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-300":l.status==="running"||l.status==="pending","bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300":l.status==="completed","bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300":l.status==="failed","bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300":l.status==="cancelled"}])},i(U(l.status).text),3)]),s("div",Be,[s("div",{class:x(["h-1.5 rounded-full",{"bg-blue-500":l.status==="running"||l.status==="pending","bg-green-500":l.status==="completed","bg-red-500":l.status==="failed","bg-yellow-500":l.status==="cancelled"}]),style:oe({width:l.progress+"%"})},null,6)]),o(b).isAdmin?(n(),r("div",Ee,[v(ve,{class:"w-3 h-3 mr-1.5"}),s("span",null,i(l.owner_username||"System"),1)])):f("",!0)],10,Ve)]))),128))]))])]),s("div",Fe,[t.value?(n(),r("div",He,[s("div",Je,[s("h3",{class:"font-semibold truncate",title:t.value.name},i(t.value.name),9,We),s("div",qe,[e[17]||(e[17]=u("ID: ")),s("code",Ge,i(t.value.id),1),s("button",{onClick:e[6]||(e[6]=l=>o(p).copyToClipboard(t.value.id)),class:"p-0.5 rounded hover:bg-gray-200 dark:hover:bg-gray-600"},[v(E,{class:"w-3 h-3"})])])]),s("div",Ze,[s("div",Ke,[s("div",{class:x(["p-3 rounded-lg flex items-center",{"bg-blue-50 dark:bg-blue-900/20":t.value.status==="running"||t.value.status==="pending","bg-green-50 dark:bg-green-900/20":t.value.status==="completed","bg-red-50 dark:bg-red-900/20":t.value.status==="failed","bg-yellow-50 dark:bg-yellow-900/20":t.value.status==="cancelled"}])},[s("div",Pe,[t.value.status==="failed"?(n(),m(N,{key:0,class:"w-8 h-8 text-red-400"})):t.value.status==="completed"?(n(),m(F,{key:1,class:"w-8 h-8 text-green-400"})):t.value.status==="cancelled"?(n(),m(M,{key:2,class:"w-8 h-8 text-yellow-400"})):(n(),m(O,{key:3,class:"w-8 h-8 text-blue-400 animate-spin"}))]),s("div",Qe,[e[18]||(e[18]=s("span",{class:"font-semibold"},"Status:",-1)),u(" "+i(U(t.value.status).text),1)]),(t.value.status==="running"||t.value.status==="pending")&&(o(b).isAdmin||t.value.owner_username===o(b).user.username)?(n(),r("button",{key:0,onClick:e[7]||(e[7]=l=>o(d).cancelTask(t.value.id)),class:"btn btn-warning btn-sm"},[v(re,{class:"w-4 h-4 mr-1"}),e[19]||(e[19]=u("Cancel Task "))])):f("",!0)],2),s("div",Xe,[s("p",null,[e[20]||(e[20]=s("strong",null,"Owner:",-1)),u(" "+i(t.value.owner_username||"System"),1)]),s("p",null,[e[21]||(e[21]=s("strong",null,"Created:",-1)),u(" "+i(A(t.value.created_at)),1)]),s("p",null,[e[22]||(e[22]=s("strong",null,"Started:",-1)),u(" "+i(A(t.value.started_at)),1)]),s("p",null,[e[23]||(e[23]=s("strong",null,"Completed:",-1)),u(" "+i(A(t.value.completed_at)),1)])]),t.value.error?(n(),r("details",Ye,[e[24]||(e[24]=s("summary",null,"Error Details",-1)),s("pre",null,i(t.value.error),1)])):f("",!0),t.value.result?(n(),r("details",es,[e[25]||(e[25]=s("summary",null,"Result Data",-1)),s("pre",null,i(JSON.stringify(t.value.result,null,2)),1)])):f("",!0)]),s("div",ss,[s("h4",ts,[e[27]||(e[27]=s("span",null,"Logs",-1)),s("button",{onClick:P,class:"btn btn-secondary btn-sm"},[v(E,{class:"w-4 h-4"}),e[26]||(e[26]=u(" Copy Logs"))])]),s("div",{ref_key:"logsContainer",ref:y,class:"flex-grow bg-gray-100 dark:bg-gray-900 rounded p-2 overflow-y-auto text-xs"},[(n(!0),r(j,null,B(t.value.logs,(l,w)=>(n(),r("div",{key:w,class:x(["log-entry",G(l.level)])},[s("span",ls,i(new Date(l.timestamp).toLocaleTimeString([],{hour12:!1})),1),(n(),m(ie(Z(l.level)),{class:"log-icon"})),s("div",as,[v(de,{content:l.message,class:"log-message prose dark:prose-invert prose-sm max-w-none"},null,8,["content"])])],2))),128)),!t.value.logs||t.value.logs.length===0?(n(),r("div",ns,"No logs for this task yet.")):f("",!0)],512)])])])):(n(),r("div",ze,e[16]||(e[16]=[s("p",{class:"text-gray-500"},"Select a task to view its details and logs.",-1)])))])])])]),footer:V(()=>[s("button",{onClick:e[8]||(e[8]=l=>o(p).closeModal("tasksManager")),class:"btn btn-primary"},"Close")]),_:1}))}},ds=H(os,[["__scopeId","data-v-a51b63b7"]]);export{ds as default};
