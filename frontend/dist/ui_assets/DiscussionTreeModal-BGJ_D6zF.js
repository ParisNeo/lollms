import{a7 as N,q as I,p as E,h as c,al as L,d as i,o,a as h,e as D,c as y,cf as j,a9 as V,t as _,z as $,j as z,d5 as q,n as F,F as C,A,L as U,u as O,k as P,r as T,l as Y,w as B,i as G,$ as H}from"./index-BztlMlxc.js";import{_ as J}from"./GenericModal-DF57XP4_.js";const K={class:"flex items-center gap-2 mb-2 text-sm font-semibold"},Q=["src","alt"],R={class:"truncate"},W={key:3,class:"text-xs text-gray-500 font-mono"},X={class:"text-xs text-gray-700 dark:text-gray-300 line-clamp-2"},Z={class:"flex items-center gap-3 text-xs text-gray-500 dark:text-gray-400 mt-2"},ee={class:"flex items-center gap-1"},te={key:0,class:"absolute -top-2 -right-2 bg-blue-500 text-white text-xs px-2 py-0.5 rounded-full shadow"},se={key:0,class:"node-children"},ae={__name:"DiscussionTreeNode",props:{node:{type:Object,required:!0},level:{type:Number,default:0},activeBranchId:{type:String,default:null}},emits:["select-branch"],setup(r,{emit:m}){const t=r,b=m,v=I(),g=E(),l=c(()=>t.node.sender_type==="user"),d=c(()=>t.node.sender_type==="assistant"),x=c(()=>{var e;return l.value?((e=v.user)==null?void 0:e.username)||"You":d.value?t.node.sender||"Assistant":t.node.sender||"System"}),p=c(()=>{var e;if(l.value)return(e=v.user)==null?void 0:e.icon;if(d.value){const s=g.allPersonalities.find(f=>f.name===t.node.sender);return s==null?void 0:s.icon_base64}return null}),w=c(()=>({"bg-gray-100 dark:bg-gray-700/50":t.level%2===0,"bg-gray-50 dark:bg-gray-900/50":t.level%2!==0,"border-blue-500 ring-2 ring-blue-500":S.value,"cursor-pointer hover:bg-opacity-80":t.node.is_leaf,"bg-green-100 dark:bg-green-900/30":t.node.is_leaf&&d.value,"bg-purple-100 dark:bg-purple-900/30":t.node.is_leaf&&l.value})),S=c(()=>t.node.id===t.activeBranchId?!0:t.node.children?t.node.children.some(e=>{const s=f=>f.id===t.activeBranchId?!0:f.children?f.children.some(k=>s(k)):!1;return s(e)}):!1);function a(){t.node.is_leaf&&b("select-branch",t.node.id)}const n=e=>{if(!e)return"";const s=e.replace(/<[^>]*>?/gm,"").trim();return s.substring(0,100)+(s.length>100?"...":"")},u=e=>e?new Date(e).toLocaleString([],{dateStyle:"short",timeStyle:"short"}):"N/A";return(e,s)=>{const f=L("DiscussionTreeNode",!0);return o(),i("div",{class:"tree-node",style:U({"margin-left":r.level*20+"px"})},[h("div",{class:F(["node-content rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm transition-all duration-150 relative",w.value]),onClick:a},[h("div",K,[p.value?(o(),i("img",{key:0,src:p.value,class:"w-6 h-6 rounded-full object-cover",alt:x.value},null,8,Q)):l.value?(o(),y(j,{key:1,class:"w-6 h-6 text-blue-500"})):d.value?(o(),y(V,{key:2,class:"w-6 h-6 text-purple-500"})):D("",!0),h("span",R,_(x.value),1),d.value&&(r.node.binding_name||r.node.model_name)?(o(),i("span",W," ("+_(r.node.model_name||r.node.binding_name)+") ",1)):D("",!0)]),h("p",X,_(n(r.node.content)),1),h("div",Z,[h("span",ee,[$(q,{class:"w-3 h-3"}),z(" "+_(r.node.token_count||0)+" tokens ",1)]),h("span",null,_(u(r.node.created_at)),1)]),r.node.is_leaf?(o(),i("div",te,"Leaf")):D("",!0)],2),r.node.children&&r.node.children.length>0?(o(),i("div",se,[(o(!0),i(C,null,A(r.node.children,k=>(o(),y(f,{key:k.id,node:k,level:r.level+1,"active-branch-id":r.activeBranchId,onSelectBranch:s[0]||(s[0]=M=>b("select-branch",M))},null,8,["node","level","active-branch-id"]))),128))])):D("",!0)],4)}}},ne=N(ae,[["__scopeId","data-v-9191d13c"]]),re={key:0,class:"flex justify-center items-center p-8"},oe={key:1,class:"text-center p-8 text-gray-500"},ie={key:2,class:"text-center p-8 text-gray-500"},ce={key:3,class:"overflow-y-auto max-h-[70vh] py-2 px-4"},le={__name:"DiscussionTreeModal",setup(r){const m=O(),t=P();I();const b=c(()=>m.modalData("discussionTree")),v=c(()=>{var a;return(a=b.value)==null?void 0:a.discussionId}),g=T(!1),l=T([]),d=c(()=>t.activeDiscussion),x=c(()=>{var a;return(a=d.value)==null?void 0:a.active_branch_id});Y(v,async a=>{a&&await p(a)},{immediate:!0});async function p(a){g.value=!0;try{const n=await t.fetchDiscussionTree(a);if(console.log("Messages received for tree:",n),!Array.isArray(n)){console.error("Error: Expected an array of messages but received:",n),l.value=[];return}l.value=w(n)}finally{g.value=!1}}function w(a){const n=new Map,u=[];return a.forEach(e=>{n.set(e.id,{...e,children:[],is_leaf:!0})}),n.forEach(e=>{if(e.parent_message_id&&n.has(e.parent_message_id)){const s=n.get(e.parent_message_id);s.children.push(e),s.is_leaf=!1,e.is_root=!1}else u.push(e),e.is_root=!0}),n.forEach(e=>{e.children.sort((s,f)=>new Date(s.created_at)-new Date(f.created_at))}),u.sort((e,s)=>new Date(e.created_at)-new Date(s.created_at)),u}function S(a){t.switchBranch(a),m.closeModal("discussionTree")}return(a,n)=>(o(),y(J,{"modal-name":"discussionTree",title:d.value?`Discussion Tree: ${d.value.title}`:"Discussion Tree","max-width-class":"max-w-4xl"},{body:B(()=>[g.value?(o(),i("div",re,[$(H,{class:"w-8 h-8 text-gray-500"}),n[1]||(n[1]=h("span",{class:"ml-3 text-gray-500"},"Loading discussion tree...",-1))])):v.value?l.value.length===0?(o(),i("div",ie," No messages found for this discussion. ")):(o(),i("div",ce,[(o(!0),i(C,null,A(l.value,u=>(o(),y(ne,{key:u.id,node:u,level:0,"active-branch-id":x.value,onSelectBranch:S},null,8,["node","active-branch-id"]))),128))])):(o(),i("div",oe," No discussion selected. "))]),footer:B(()=>[h("button",{onClick:n[0]||(n[0]=u=>G(m).closeModal("discussionTree")),class:"btn btn-secondary"},"Close")]),_:1},8,["title"]))}},fe=N(le,[["__scopeId","data-v-8039cd17"]]);export{fe as default};
