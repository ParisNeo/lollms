import{a as K,u as W,K as R,c as C,s as b,o as J,N as X,d as a,l as s,e,h as w,f as c,y as oe,z as Z,Q as ee,F as U,i as B,p as M,n as E,v as ie,U as te,t as v,H as P,cS as le,m as F,C as ue,cT as ce,ai as A,w as de,P as se,g as ge,a2 as pe,au as fe,cU as me,j as D,aq as q,M as ve,a4 as ye,aj as be,$ as he,cH as _e,T as xe,L as ke,ca as Q,k as we}from"./index-BaERX4Xe.js";const Ce={class:"flex flex-col h-full bg-white dark:bg-gray-900"},$e={class:"p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center shrink-0"},Se={key:0,class:"p-4 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800/50"},De={class:"flex justify-end gap-2"},Ge={class:"flex-1 overflow-y-auto custom-scrollbar"},Ie={key:0,class:"p-4 text-center text-gray-500 text-sm"},Te={key:1,class:"p-8 text-center text-gray-500"},Me={key:2,class:"divide-y divide-gray-100 dark:divide-gray-800"},Le=["onClick"],Ve={class:"relative shrink-0"},je={key:0,class:"w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900 flex items-center justify-center text-blue-600 dark:text-blue-300"},Ne={key:2,class:"absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center ring-2 ring-white dark:ring-gray-900"},Ue={class:"flex-1 min-w-0"},Be={class:"flex justify-between items-baseline mb-0.5"},Fe={class:"font-semibold text-sm text-gray-900 dark:text-gray-100 truncate pr-2"},Ee={class:"text-[10px] text-gray-400 shrink-0"},ze={class:"text-xs text-gray-500 dark:text-gray-400 truncate h-4"},He={key:0,class:"opacity-90"},Oe={key:1,class:"italic opacity-50"},Pe=["onClick"],Ae={key:0,class:"menu-dropdown absolute right-0 mt-1 w-32 bg-white dark:bg-gray-800 rounded shadow-lg border dark:border-gray-700 z-10 py-1"},Ke=["onClick"],Re={__name:"ConversationList",props:{modelValue:{type:Number,default:null}},emits:["update:modelValue"],setup(h,{emit:_}){const n=h,G=_,g=K(),p=W(),I=R(),f=C(()=>g.conversations),x=C(()=>g.isLoadingConversations);C(()=>p.user);const o=b(!1),y=b(""),m=b([]);function L(i){if(!i)return"";const r=new Date(i),t=new Date;return r.toDateString()===t.toDateString()?r.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):r.toLocaleDateString()}function z(i){const r=i.partner_user_id||i.id;G("update:modelValue",r)}async function T(){y.value.trim()&&(await g.createGroupConversation(y.value,m.value),o.value=!1,y.value="",m.value=[])}const k=b(null);function H(i){k.value=k.value===i?null:i}function V(i){!i.target.closest(".menu-trigger")&&!i.target.closest(".menu-dropdown")&&(k.value=null)}J(()=>{document.addEventListener("click",V)}),X(()=>{document.removeEventListener("click",V)});async function j(i){const r=!!i.is_group,t=r?`Leave "${i.name}"?`:`Delete conversation with ${i.partner_username}?`,$=r?"You will be removed from this group.":"This will delete the conversation history for you.",{confirmed:O}=await I.showConfirmation({title:t,message:$,confirmText:r?"Leave":"Delete"});if(O){const N=r?i.id:i.partner_user_id;await g.deleteConversation(N,r),k.value=null,n.modelValue===N&&G("update:modelValue",null)}}return(i,r)=>(s(),a("div",Ce,[e("div",$e,[r[3]||(r[3]=e("h2",{class:"font-bold text-lg text-gray-800 dark:text-gray-200"},"Messages",-1)),e("button",{onClick:r[0]||(r[0]=t=>o.value=!o.value),class:"p-1.5 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800 text-blue-600 dark:text-blue-400",title:"New Group"},[c(oe,{class:"w-5 h-5"})])]),o.value?(s(),a("div",Se,[Z(e("input",{"onUpdate:modelValue":r[1]||(r[1]=t=>y.value=t),type:"text",placeholder:"Group Name",class:"input-field w-full mb-2 text-sm"},null,512),[[ee,y.value]]),e("div",De,[e("button",{onClick:r[2]||(r[2]=t=>o.value=!1),class:"btn btn-secondary btn-sm"},"Cancel"),e("button",{onClick:T,class:"btn btn-primary btn-sm"},"Create")])])):w("",!0),e("div",Ge,[x.value?(s(),a("div",Ie,"Loading conversations...")):f.value.length===0?(s(),a("div",Te,r[4]||(r[4]=[e("p",null,"No conversations yet.",-1),e("p",{class:"text-xs mt-1"},"Start a chat from your Friends list.",-1)]))):(s(),a("ul",Me,[(s(!0),a(U,null,B(f.value,t=>(s(),a("li",{key:t.id+(t.is_group?"_g":"_u"),class:"relative group"},[e("button",{onClick:$=>z(t),class:M(["w-full p-3 flex items-start gap-3 hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors text-left",{"bg-blue-50 dark:bg-blue-900/20":h.modelValue===(t.partner_user_id||t.id)}])},[e("div",Ve,[t.is_group?(s(),a("div",je,[c(ie,{class:"w-6 h-6"})])):(s(),E(te,{key:1,username:t.partner_username,icon:t.partner_icon,"size-class":"w-10 h-10"},null,8,["username","icon"])),t.unread_count>0?(s(),a("span",Ne,v(t.unread_count>9?"9+":t.unread_count),1)):w("",!0)]),e("div",Ue,[e("div",Be,[e("h3",Fe,v(t.name||t.partner_username),1),e("span",Ee,v(L(t.last_message_at)),1)]),e("p",ze,[t.last_message?(s(),a("span",He,v(t.last_message),1)):(s(),a("span",Oe,"No messages"))])])],10,Le),e("div",{class:M(["absolute right-2 top-8 opacity-0 group-hover:opacity-100 transition-opacity",{"opacity-100":k.value===(t.partner_user_id||t.id)}])},[e("button",{onClick:P($=>H(t.partner_user_id||t.id),["stop"]),class:"menu-trigger p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-500"},[c(le,{class:"w-4 h-4"})],8,Pe),k.value===(t.partner_user_id||t.id)?(s(),a("div",Ae,[e("button",{onClick:P($=>j(t),["stop"]),class:"w-full text-left px-3 py-2 text-xs hover:bg-red-50 dark:hover:bg-red-900/30 text-red-600 dark:text-red-400 flex items-center gap-2"},[(s(),E(ue(t.is_group?ce:A),{class:"w-3 h-3"})),F(" "+v(t.is_group?"Leave Group":"Delete"),1)],8,Ke)])):w("",!0)],2)]))),128))]))])]))}},Je={class:"flex flex-col h-full bg-white dark:bg-gray-900"},Ye={class:"flex items-center p-3 border-b dark:border-gray-700 bg-gray-50 dark:bg-gray-800 justify-between"},qe={class:"flex items-center gap-2 overflow-hidden"},Qe={key:2,class:"w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center font-bold text-gray-700"},We={class:"font-bold truncate"},Xe={class:"flex items-center gap-1"},Ze={key:0,class:"text-xs opacity-75 mb-1 font-bold text-blue-600 dark:text-blue-400"},et=["onClick"],tt={class:"text-[10px] text-gray-400 mt-1 px-1"},st={class:"p-3 border-t dark:border-gray-700 bg-gray-50 dark:bg-gray-800"},at={key:0,class:"flex gap-2 mb-2 overflow-x-auto pb-1"},rt={class:"truncate max-w-[100px]"},nt=["onClick"],ot={class:"flex gap-2"},it=["disabled"],lt={__name:"DmWindow",props:{conversation:Object,compact:Boolean},emits:["back"],setup(h,{emit:_}){const n=h,G=_,g=K(),p=W(),I=R(),f=b(""),x=b(null),o=b(null),y=b(null),m=b([]),L=b(!1),z=C(()=>n.conversation.messages),T=C(()=>{var u;return n.conversation.isGroup?n.conversation.name:(u=n.conversation.partner)==null?void 0:u.username});C(()=>p.user);function k(){o.value.click()}function H(u){m.value=Array.from(u.target.files)}async function V(){if(!(!f.value.trim()&&m.value.length===0)){L.value=!0;try{await g.sendDirectMessage({targetId:n.conversation.id,isGroup:n.conversation.isGroup,content:f.value,files:m.value}),f.value="",m.value=[]}finally{L.value=!1}}}function j(){xe(()=>{x.value&&(x.value.scrollTop=x.value.scrollHeight)})}de(()=>n.conversation.messages.length,j),J(j);function i(u){I.openImageViewer({imageList:[{src:u,prompt:"DM Image"}],startIndex:0})}function r(u){return new Date(u).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}function t(u){m.value.splice(u,1)}async function $(u){confirm("Delete this message?")&&await g.deleteMessage(u)}async function O(){const u=n.conversation.isGroup?"Leave this group?":"Clear conversation history?";confirm(u)&&(await g.deleteConversation(n.conversation.id,n.conversation.isGroup),n.compact?G("back"):g.activeConversationId=null)}async function N(){await g.exportConversation(n.conversation.id,n.conversation.isGroup,T.value)}function ae(){y.value.click()}async function re(u){const d=u.target.files[0];d&&(await g.importConversation(n.conversation.id,n.conversation.isGroup,d),u.target.value="")}return(u,d)=>{var Y;return s(),a("div",Je,[e("div",Ye,[e("div",qe,[h.compact?(s(),a("button",{key:0,onClick:d[0]||(d[0]=l=>u.$emit("back")),class:"p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"},[c(se,{class:"w-5 h-5"})])):w("",!0),h.conversation.isGroup?(s(),a("div",Qe,v(T.value[0]),1)):(s(),E(te,{key:1,icon:(Y=h.conversation.partner)==null?void 0:Y.icon,username:T.value,"size-class":"w-8 h-8"},null,8,["icon","username"])),e("span",We,v(T.value),1)]),e("div",Xe,[c(me,{icon:"ellipsis-vertical",buttonClass:"btn-icon p-1"},{default:ge(()=>[e("button",{onClick:N,class:"menu-item"},[c(pe,{class:"w-4 h-4 mr-2"}),d[3]||(d[3]=F("Export JSON"))]),e("button",{onClick:ae,class:"menu-item"},[c(fe,{class:"w-4 h-4 mr-2"}),d[4]||(d[4]=F("Import JSON"))]),d[5]||(d[5]=e("div",{class:"menu-divider"},null,-1)),e("button",{onClick:O,class:"menu-item text-red-500"},[c(A,{class:"w-4 h-4 mr-2"}),F(v(h.conversation.isGroup?"Leave Group":"Clear History"),1)])]),_:1}),e("input",{type:"file",ref_key:"importInput",ref:y,class:"hidden",accept:".json",onChange:re},null,544),e("button",{onClick:d[1]||(d[1]=l=>D(I).isChatSidebarOpen=!1),class:"p-1 rounded hover:bg-gray-200 dark:hover:bg-gray-700"},[c(q,{class:"w-5 h-5"})])])]),e("div",{ref_key:"messageContainer",ref:x,class:"flex-1 overflow-y-auto p-4 space-y-3"},[(s(!0),a(U,null,B(z.value,l=>(s(),a("div",{key:l.id,class:M(["flex flex-col group",l.sender_id===D(p).user.id?"items-end":"items-start"])},[e("div",{class:M(["relative max-w-[85%] p-2 rounded-lg text-sm shadow-sm border dark:border-gray-700",l.sender_id===D(p).user.id?"bg-blue-100 dark:bg-blue-900/30 border-blue-200 dark:border-blue-800":"bg-white dark:bg-gray-800"])},[n.conversation.isGroup&&l.sender_id!==D(p).user.id?(s(),a("div",Ze,v(l.sender_username),1)):w("",!0),c(ve,{content:l.content},null,8,["content"]),l.image_references&&l.image_references.length>0?(s(),a("div",{key:1,class:M(["mt-2 grid gap-2",l.image_references.length>1?"grid-cols-2":"grid-cols-1"])},[(s(!0),a(U,null,B(l.image_references,S=>(s(),a("div",{key:S,class:"relative group/img cursor-pointer"},[c(ye,{src:S,class:"rounded-md max-h-48 object-cover w-full border dark:border-gray-600",onClick:P(ne=>i(S),["stop"])},null,8,["src","onClick"])]))),128))],2)):w("",!0),l.sender_id===D(p).user.id||D(p).user.is_admin?(s(),a("button",{key:2,onClick:S=>$(l.id),class:M(["absolute top-0 p-1 text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity",l.sender_id===D(p).user.id?"-left-8":"-right-8"]),title:"Delete"},[c(A,{class:"w-4 h-4"})],10,et)):w("",!0)],2),e("span",tt,v(r(l.sent_at)),1)],2))),128))],512),e("div",st,[m.value.length>0?(s(),a("div",at,[(s(!0),a(U,null,B(m.value,(l,S)=>(s(),a("div",{key:S,class:"relative bg-white dark:bg-gray-700 rounded border dark:border-gray-600 p-1 text-xs flex items-center shadow-sm"},[e("span",rt,v(l.name),1),e("button",{onClick:ne=>t(S),class:"ml-2 text-red-500 hover:text-red-700"},[c(q,{class:"w-3 h-3"})],8,nt)]))),128))])):w("",!0),e("div",ot,[e("button",{onClick:k,class:"btn-icon p-2"},[c(be,{class:"w-5 h-5"})]),e("input",{type:"file",ref_key:"fileInput",ref:o,class:"hidden",multiple:"",onChange:H},null,544),Z(e("input",{"onUpdate:modelValue":d[2]||(d[2]=l=>f.value=l),onKeyup:he(V,["enter"]),class:"input-field flex-1",placeholder:"Type a message...",autocomplete:"off"},null,544),[[ee,f.value]]),e("button",{onClick:V,class:"btn-primary p-2 rounded",disabled:L.value||!f.value.trim()&&m.value.length===0},[c(_e,{class:"w-4 h-4"})],8,it)])])])}}},ut={class:"flex h-full bg-white dark:bg-gray-900 overflow-hidden"},ct={class:"w-80 flex-shrink-0 border-r border-gray-200 dark:border-gray-700 h-full flex flex-col overflow-hidden"},dt={class:"flex-1 overflow-hidden"},gt={class:"p-4 border-t border-gray-200 dark:border-gray-700 flex-shrink-0"},pt={class:"flex-1 min-w-0 h-full flex flex-col relative"},ft={key:1,class:"h-full flex flex-col items-center justify-center text-gray-500 dark:text-gray-400 bg-gray-50 dark:bg-gray-800/50"},mt={class:"p-6 rounded-full bg-gray-100 dark:bg-gray-700 mb-4"},yt={__name:"MessagesView",setup(h){const _=K(),n=R(),G=we(),g=C(()=>_.activeConversationUserId),p=C(()=>g.value?_.activeConversations[g.value]:null);function I(x){const o=_.conversations.find(y=>y.partner_user_id===x);o&&_.openConversation({id:o.partner_user_id,username:o.partner_username,icon:o.partner_icon})}function f(){G.push("/")}return J(()=>{n.setPageTitle({title:"Messages",icon:ke(Q)}),_.fetchConversations()}),X(()=>{n.setPageTitle({title:""})}),(x,o)=>(s(),a("div",ut,[e("div",ct,[e("div",dt,[c(Re,{"model-value":g.value,"onUpdate:modelValue":I},null,8,["model-value"])]),e("div",gt,[e("button",{onClick:f,class:"w-full flex items-center gap-3 px-3 py-2.5 text-sm font-medium text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition-colors"},[c(se,{class:"w-5 h-5"}),o[0]||(o[0]=e("span",null,"Back to Discussion",-1))])])]),e("div",pt,[p.value?(s(),E(lt,{key:0,conversation:p.value,class:"h-full"},null,8,["conversation"])):(s(),a("div",ft,[e("div",mt,[c(Q,{class:"w-12 h-12 text-gray-400 dark:text-gray-500"})]),o[1]||(o[1]=e("h3",{class:"text-lg font-medium text-gray-900 dark:text-gray-200"},"Your Messages",-1)),o[2]||(o[2]=e("p",{class:"mt-1 text-sm"},"Select a conversation from the list to start chatting.",-1))]))])]))}};export{yt as default};
