import{_ as X,R as Y,u as q,Y as Q,b as _,az as Z,r as h,S as C,av as ee,f as m,o as n,w as j,a as s,A as o,c as r,h as p,g as v,aM as se,n as b,G as d,m as M,t as i,M as O,X as te,J as T,aC as R,N as le,K as ae,F as V,j as B,U as ne,aG as E,bj as N,V as F,x as oe,v as re,P as ie,aw as G}from"./index-D2Id9a0s.js";import{_ as de}from"./GenericModal-_6JiAudK.js";import{I as ue}from"./IconUser-LTGMg30m.js";const ce={class:"space-y-4"},ge={class:"flex items-center justify-between flex-wrap gap-2"},me={class:"flex items-center gap-2"},ve=["disabled"],fe=["disabled"],pe=["disabled"],be={key:0,class:"p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg border dark:border-gray-600"},ye={class:"flex items-center justify-start space-x-6"},xe={class:"flex items-center space-x-4"},ke={class:"flex items-center text-sm"},we={class:"flex items-center text-sm"},_e={class:"flex items-center text-sm"},he={class:"grid grid-cols-1 md:grid-cols-3 gap-6 h-[60vh]"},Ce={class:"md:col-span-1 bg-white dark:bg-gray-800 rounded-lg shadow-sm overflow-hidden flex flex-col"},Te={class:"p-4 border-b dark:border-gray-700 flex-shrink-0 space-y-3"},Se={class:"relative"},Ie={class:"pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3"},Le={class:"flex-grow overflow-y-auto"},Ae={key:0,class:"p-4 text-center text-gray-500"},Me={key:1,class:"p-4 text-center text-gray-500"},Re={key:2,class:"divide-y dark:divide-gray-700"},Ne=["onClick"],De={class:"flex justify-between items-center mb-1"},$e=["title"],Ue={class:"w-full bg-gray-200 rounded-full h-1.5 dark:bg-gray-600 mb-2"},je={key:0,class:"flex items-center text-xs text-gray-500 dark:text-gray-400"},Oe={class:"md:col-span-2 bg-white dark:bg-gray-800 rounded-lg shadow-sm flex flex-col h-full overflow-hidden"},Ve={key:0,class:"h-full flex items-center justify-center text-center p-4"},Be={key:1,class:"flex flex-col h-full"},Ee={class:"p-4 border-b dark:border-gray-700 flex-shrink-0"},Fe=["title"],Ge={class:"text-xs text-gray-500 dark:text-gray-400 flex items-center"},Je={class:"ml-1 mr-2"},ze={class:"flex-grow min-h-0 flex flex-col p-4 space-y-4 overflow-y-auto"},Pe={class:"space-y-3 text-sm flex-shrink-0"},We={class:"flex-shrink-0 mr-4"},He={class:"flex-grow"},Ke={class:"grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2"},Xe={key:0,class:"info-details error",open:""},Ye={key:1,class:"info-details success"},qe={class:"flex-grow min-h-0 flex flex-col pt-4 border-t dark:border-gray-700"},Qe={class:"font-semibold mb-2 flex-shrink-0 flex items-center justify-between"},Ze={class:"log-timestamp font-mono"},es={class:"log-message-wrapper"},ss={key:0,class:"text-gray-400 italic"},ts={__name:"TasksManagerModal",setup(ls){const g=Y(),f=q(),y=Q(),J=_(()=>f.modalData("tasksManager")),D=_(()=>{var a;return(a=J.value)==null?void 0:a.initialTaskId}),{tasks:z,isLoadingTasks:S,activeTasksCount:I,isClearingTasks:L}=Z(g),t=h(null),x=h(null),u=h("all"),k=h(""),c=_(()=>[...z.value].sort((a,e)=>new Date(e.created_at)-new Date(a.created_at))),$=_(()=>{if(!k.value)return c.value;const a=k.value.toLowerCase();return c.value.filter(e=>e.name&&e.name.toLowerCase().includes(a)||e.id&&e.id.toLowerCase().includes(a)||e.owner_username&&e.owner_username.toLowerCase().includes(a))});C(()=>f.isModalOpen("tasksManager"),a=>{a&&(g.fetchTasks(u.value),D.value&&c.value.length>0?t.value=c.value.find(e=>e.id===D.value)||c.value[0]:c.value.length>0?t.value=c.value[0]:t.value=null)}),C(u,a=>{g.fetchTasks(a)}),C(c,a=>{if(t.value){const e=a.find(l=>l.id===t.value.id);e?JSON.stringify(t.value.logs)!==JSON.stringify(e.logs)?t.value=e:Object.assign(t.value,e):t.value=a.length>0?a[0]:null}else a.length>0&&(t.value=a[0])}),C(()=>{var a;return(a=t.value)==null?void 0:a.logs},()=>{ee(()=>{x.value&&(x.value.scrollTop=x.value.scrollHeight)})},{deep:!0});function A(a){return a?new Date(a).toLocaleString():"N/A"}function U(a){switch(a){case"running":return{text:"Running"};case"completed":return{text:"Completed",icon:F,color:"text-green-500"};case"failed":return{text:"Failed",icon:N,color:"text-red-500"};case"cancelled":return{text:"Cancelled",icon:M,color:"text-yellow-500"};case"pending":default:return{text:"Pending"}}}function P(a){switch(a==null?void 0:a.toUpperCase()){case"ERROR":case"CRITICAL":return"text-red-500 dark:text-red-400";case"WARNING":return"text-yellow-500 dark:text-yellow-400";default:return"text-gray-600 dark:text-gray-300"}}const W=a=>{switch(a==null?void 0:a.toUpperCase()){case"ERROR":case"CRITICAL":return N;case"WARNING":return G;default:return G}};async function H(){(await f.showConfirmation({title:"Cancel All Active Tasks",message:`Are you sure you want to cancel all ${I.value} active background tasks?`,confirmText:"Cancel All"})).confirmed&&await g.cancelAllTasks()}function K(){if(!t.value||!t.value.logs)return;const a=t.value.logs.map(e=>{const l=new Date(e.timestamp).toLocaleTimeString(),w=e.level.toUpperCase();return`[${l}] [${w}] ${e.message}`}).join(`
`);f.copyToClipboard(a,"Logs copied to clipboard!")}return(a,e)=>(n(),m(de,{"modal-name":"tasksManager",title:"Background Tasks","max-width-class":"max-w-6xl"},{body:j(()=>[s("div",ce,[s("div",ge,[e[10]||(e[10]=s("p",{class:"text-sm text-gray-500"},"Monitor your background processes.",-1)),s("div",me,[s("button",{onClick:e[0]||(e[0]=l=>o(g).fetchTasks(u.value)),class:"btn btn-secondary btn-sm",disabled:o(S)},[v(se,{class:b(["w-4 h-4",{"animate-spin":o(S)}])},null,8,["class"])],8,ve),s("button",{onClick:H,class:"btn btn-warning btn-sm",disabled:o(I)===0||o(L)},[v(M,{class:"w-4 h-4 mr-1"}),d(" Cancel All ("+i(o(I))+") ",1)],8,fe),s("button",{onClick:e[1]||(e[1]=(...l)=>o(g).clearCompletedTasks&&o(g).clearCompletedTasks(...l)),class:"btn btn-danger btn-sm",disabled:o(L)},[o(L)?(n(),m(O,{key:0,class:"w-4 h-4 mr-1 animate-spin"})):(n(),m(te,{key:1,class:"w-4 h-4 mr-1"})),e[9]||(e[9]=d(" Clear Completed "))],8,pe)])]),o(y).isAdmin?(n(),r("div",be,[s("div",ye,[e[14]||(e[14]=s("span",{class:"text-sm font-medium"},"Show tasks for:",-1)),s("div",xe,[s("label",ke,[T(s("input",{type:"radio","onUpdate:modelValue":e[2]||(e[2]=l=>u.value=l),value:"all",class:"form-radio"},null,512),[[R,u.value]]),e[11]||(e[11]=s("span",{class:"ml-2"},"All Users",-1))]),s("label",we,[T(s("input",{type:"radio","onUpdate:modelValue":e[3]||(e[3]=l=>u.value=l),value:"me",class:"form-radio"},null,512),[[R,u.value]]),e[12]||(e[12]=s("span",{class:"ml-2"},"My Tasks",-1))]),s("label",_e,[T(s("input",{type:"radio","onUpdate:modelValue":e[4]||(e[4]=l=>u.value=l),value:"others",class:"form-radio"},null,512),[[R,u.value]]),e[13]||(e[13]=s("span",{class:"ml-2"},"Other Users",-1))])])])])):p("",!0),s("div",he,[s("div",Ce,[s("div",Te,[e[15]||(e[15]=s("h3",{class:"font-semibold"},"Tasks",-1)),s("div",Se,[s("div",Ie,[v(le,{class:"h-4 w-4 text-gray-400"})]),T(s("input",{type:"text","onUpdate:modelValue":e[5]||(e[5]=l=>k.value=l),placeholder:"Search tasks...",class:"w-full text-sm pl-9 pr-4 py-1.5 rounded-md border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700"},null,512),[[ae,k.value]])])]),s("div",Le,[o(S)&&c.value.length===0?(n(),r("div",Ae,"Loading...")):$.value.length===0?(n(),r("div",Me,"No tasks found.")):(n(),r("ul",Re,[(n(!0),r(V,null,B($.value,l=>(n(),r("li",{key:l.id},[s("button",{onClick:w=>t.value=l,class:b(["w-full text-left p-4 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors",{"bg-blue-50 dark:bg-blue-900/30":t.value&&t.value.id===l.id}])},[s("div",De,[s("p",{class:"font-medium truncate text-sm",title:l.name},i(l.name),9,$e),s("span",{class:b(["text-xs px-2 py-0.5 rounded-full",{"bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-300":l.status==="running"||l.status==="pending","bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300":l.status==="completed","bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300":l.status==="failed","bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300":l.status==="cancelled"}])},i(U(l.status).text),3)]),s("div",Ue,[s("div",{class:b(["h-1.5 rounded-full",{"bg-blue-500":l.status==="running"||l.status==="pending","bg-green-500":l.status==="completed","bg-red-500":l.status==="failed","bg-yellow-500":l.status==="cancelled"}]),style:ne({width:l.progress+"%"})},null,6)]),o(y).isAdmin?(n(),r("div",je,[v(ue,{class:"w-3 h-3 mr-1.5"}),s("span",null,i(l.owner_username||"System"),1)])):p("",!0)],10,Ne)]))),128))]))])]),s("div",Oe,[t.value?(n(),r("div",Be,[s("div",Ee,[s("h3",{class:"font-semibold truncate",title:t.value.name},i(t.value.name),9,Fe),s("div",Ge,[e[17]||(e[17]=d("ID: ")),s("code",Je,i(t.value.id),1),s("button",{onClick:e[6]||(e[6]=l=>o(f).copyToClipboard(t.value.id)),class:"p-0.5 rounded hover:bg-gray-200 dark:hover:bg-gray-600"},[v(E,{class:"w-3 h-3"})])])]),s("div",ze,[s("div",Pe,[s("div",{class:b(["p-3 rounded-lg flex items-center",{"bg-blue-50 dark:bg-blue-900/20":t.value.status==="running"||t.value.status==="pending","bg-green-50 dark:bg-green-900/20":t.value.status==="completed","bg-red-50 dark:bg-red-900/20":t.value.status==="failed","bg-yellow-50 dark:bg-yellow-900/20":t.value.status==="cancelled"}])},[s("div",We,[t.value.status==="failed"?(n(),m(N,{key:0,class:"w-8 h-8 text-red-400"})):t.value.status==="completed"?(n(),m(F,{key:1,class:"w-8 h-8 text-green-400"})):t.value.status==="cancelled"?(n(),m(M,{key:2,class:"w-8 h-8 text-yellow-400"})):(n(),m(O,{key:3,class:"w-8 h-8 text-blue-400 animate-spin"}))]),s("div",He,[e[18]||(e[18]=s("span",{class:"font-semibold"},"Status:",-1)),d(" "+i(U(t.value.status).text),1)]),(t.value.status==="running"||t.value.status==="pending")&&(o(y).isAdmin||t.value.owner_username===o(y).user.username)?(n(),r("button",{key:0,onClick:e[7]||(e[7]=l=>o(g).cancelTask(t.value.id)),class:"btn btn-warning btn-sm"},[v(oe,{class:"w-4 h-4 mr-1"}),e[19]||(e[19]=d("Cancel Task "))])):p("",!0)],2),s("div",Ke,[s("p",null,[e[20]||(e[20]=s("strong",null,"Owner:",-1)),d(" "+i(t.value.owner_username||"System"),1)]),s("p",null,[e[21]||(e[21]=s("strong",null,"Created:",-1)),d(" "+i(A(t.value.created_at)),1)]),s("p",null,[e[22]||(e[22]=s("strong",null,"Started:",-1)),d(" "+i(A(t.value.started_at)),1)]),s("p",null,[e[23]||(e[23]=s("strong",null,"Completed:",-1)),d(" "+i(A(t.value.completed_at)),1)])]),t.value.error?(n(),r("details",Xe,[e[24]||(e[24]=s("summary",null,"Error Details",-1)),s("pre",null,i(t.value.error),1)])):p("",!0),t.value.result?(n(),r("details",Ye,[e[25]||(e[25]=s("summary",null,"Result Data",-1)),s("pre",null,i(JSON.stringify(t.value.result,null,2)),1)])):p("",!0)]),s("div",qe,[s("h4",Qe,[e[27]||(e[27]=s("span",null,"Logs",-1)),s("button",{onClick:K,class:"btn btn-secondary btn-sm"},[v(E,{class:"w-4 h-4"}),e[26]||(e[26]=d(" Copy Logs"))])]),s("div",{ref_key:"logsContainer",ref:x,class:"flex-grow bg-gray-100 dark:bg-gray-900 rounded p-2 overflow-y-auto text-xs"},[(n(!0),r(V,null,B(t.value.logs,(l,w)=>(n(),r("div",{key:w,class:b(["log-entry",P(l.level)])},[s("span",Ze,i(new Date(l.timestamp).toLocaleTimeString([],{hour12:!1})),1),(n(),m(re(W(l.level)),{class:"log-icon"})),s("div",es,[v(ie,{content:l.message,class:"log-message prose dark:prose-invert prose-sm max-w-none"},null,8,["content"])])],2))),128)),!t.value.logs||t.value.logs.length===0?(n(),r("div",ss,"No logs for this task yet.")):p("",!0)],512)])])])):(n(),r("div",Ve,e[16]||(e[16]=[s("p",{class:"text-gray-500"},"Select a task to view its details and logs.",-1)])))])])])]),footer:j(()=>[s("button",{onClick:e[8]||(e[8]=l=>o(f).closeModal("tasksManager")),class:"btn btn-primary"},"Close")]),_:1}))}},rs=X(ts,[["__scopeId","data-v-a51b63b7"]]);export{rs as default};
