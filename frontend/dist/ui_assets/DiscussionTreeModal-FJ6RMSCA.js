import{q as $,u as M,P as L,c as d,r as V,d as c,l as a,e as l,h as _,p as B,n as D,ce as q,aq as F,t as g,f as N,m as P,d7 as U,F as A,i as j,K,N as O,s as C,w as Y,g as I,j as G,an as H}from"./index-7OJ7XwkZ.js";import{_ as J}from"./GenericModal-BayVOcWm.js";const Q={class:"tree-node-container relative"},R={class:"node-wrapper flex items-start relative z-10"},W={class:"flex items-center gap-2 mb-2 pb-2 border-b border-gray-100 dark:border-gray-700/50"},X={class:"relative"},Z=["src","alt"],ee={key:1,class:"w-6 h-6 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center"},te={class:"flex-1 min-w-0"},se={class:"flex items-center justify-between"},ae={class:"text-xs font-bold text-gray-900 dark:text-gray-100 truncate"},re={class:"text-[10px] text-gray-400 tabular-nums"},ne={key:0,class:"text-[9px] text-gray-500 dark:text-gray-400 font-mono truncate opacity-80"},oe={class:"text-xs text-gray-600 dark:text-gray-300 leading-relaxed font-sans line-clamp-3"},ie={class:"mt-2 pt-2 flex items-center gap-3 text-[10px] text-gray-400 border-t border-gray-50 dark:border-gray-700/30"},le={class:"flex items-center gap-1"},ce={key:0,class:"ml-auto text-blue-500 font-bold uppercase tracking-wider"},de={key:0,class:"absolute left-0 top-0 bottom-0 w-1 bg-blue-500 rounded-l-lg opacity-50"},ue={key:0,class:"children-container pl-8 relative mt-4"},fe={key:0,class:"absolute left-[-17px] top-6 bottom-0 w-4 bg-white dark:bg-[#1f2937] z-0"},ve={__name:"DiscussionTreeNode",props:{node:{type:Object,required:!0},level:{type:Number,default:0},activeBranchId:{type:String,default:null}},emits:["select-branch"],setup(r,{emit:m}){const t=r,x=m,b=M(),y=L(),f=d(()=>t.node.sender_type==="user"),v=d(()=>t.node.sender_type==="assistant"),p=d(()=>{var e;return f.value?((e=b.user)==null?void 0:e.username)||"You":v.value?t.node.sender||"Assistant":t.node.sender||"System"}),k=d(()=>{var e;if(f.value)return(e=b.user)==null?void 0:e.icon;if(v.value){const n=y.allPersonalities.find(h=>h.name===t.node.sender);return n==null?void 0:n.icon_base64}return null}),T=d(()=>({"bg-white dark:bg-gray-800":!0,"border-blue-500 ring-2 ring-blue-500":s.value,"border-gray-200 dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600":!s.value,"cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-750":t.node.is_leaf,"leaf-node":t.node.is_leaf})),S=d(()=>t.node.is_leaf?v.value?"bg-green-500":"bg-purple-500":"bg-gray-400"),s=d(()=>t.node.id===t.activeBranchId?!0:t.node.children?t.node.children.some(e=>{const n=h=>h.id===t.activeBranchId?!0:h.children?h.children.some(w=>n(w)):!1;return n(e)}):!1);function o(){t.node.is_leaf&&x("select-branch",t.node.id)}const u=e=>{if(!e)return"";const n=e.replace(/<[^>]*>?/gm,"").trim();return n.substring(0,120)+(n.length>120?"...":"")},i=e=>e?new Date(e).toLocaleString([],{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"";return(e,n)=>{const h=V("DiscussionTreeNode",!0);return a(),c("div",Q,[l("div",R,[l("div",{class:B(["node-card relative flex flex-col p-3 rounded-lg border shadow-sm transition-all duration-200 w-full min-w-[250px] max-w-[400px]",T.value]),onClick:o},[l("div",W,[l("div",X,[k.value?(a(),c("img",{key:0,src:k.value,class:"w-6 h-6 rounded-full object-cover border border-gray-200 dark:border-gray-700",alt:p.value},null,8,Z)):(a(),c("div",ee,[f.value?(a(),D(q,{key:0,class:"w-4 h-4 text-blue-500"})):(a(),D(F,{key:1,class:"w-4 h-4 text-purple-500"}))])),l("div",{class:B(["absolute -bottom-0.5 -right-0.5 w-2.5 h-2.5 rounded-full border-2 border-white dark:border-gray-800",S.value])},null,2)]),l("div",te,[l("div",se,[l("span",ae,g(p.value),1),l("span",re,g(i(r.node.created_at)),1)]),v.value&&(r.node.binding_name||r.node.model_name)?(a(),c("div",ne,g(r.node.binding_name)+g(r.node.model_name?"/"+r.node.model_name:""),1)):_("",!0)])]),l("div",oe,g(u(r.node.content)||"(No content)"),1),l("div",ie,[l("span",le,[N(U,{class:"w-3 h-3"}),P(" "+g(r.node.token_count||0),1)]),r.node.is_leaf?(a(),c("span",ce,"Leaf")):_("",!0)]),s.value&&!r.node.is_leaf?(a(),c("div",de)):_("",!0)],2)]),r.node.children&&r.node.children.length>0?(a(),c("div",ue,[n[2]||(n[2]=l("div",{class:"absolute left-4 top-[-20px] bottom-4 w-px bg-gray-300 dark:bg-gray-600 z-0"},null,-1)),(a(!0),c(A,null,j(r.node.children,(w,E)=>(a(),c("div",{key:w.id,class:"child-wrapper relative pl-4 pb-4 last:pb-0"},[n[1]||(n[1]=l("div",{class:"absolute left-[-16px] top-6 w-5 h-px bg-gray-300 dark:bg-gray-600 z-0"},null,-1)),E===r.node.children.length-1?(a(),c("div",fe)):_("",!0),N(h,{node:w,level:r.level+1,"active-branch-id":r.activeBranchId,onSelectBranch:n[0]||(n[0]=z=>x("select-branch",z))},null,8,["node","level","active-branch-id"])]))),128))])):_("",!0)])}}},he=$(ve,[["__scopeId","data-v-f1600cc6"]]),ge={key:0,class:"flex justify-center items-center p-8"},me={key:1,class:"text-center p-8 text-gray-500"},be={key:2,class:"text-center p-8 text-gray-500"},ye={key:3,class:"overflow-y-auto max-h-[70vh] py-2 px-4"},_e={__name:"DiscussionTreeModal",setup(r){const m=K(),t=O();M();const x=d(()=>m.modalData("discussionTree")),b=d(()=>{var s;return(s=x.value)==null?void 0:s.discussionId}),y=C(!1),f=C([]),v=d(()=>t.activeDiscussion),p=d(()=>{var s;return(s=v.value)==null?void 0:s.active_branch_id});Y(b,async s=>{s&&await k(s)},{immediate:!0});async function k(s){y.value=!0;try{const o=await t.fetchDiscussionTree(s);if(console.log("Messages received for tree:",o),!Array.isArray(o)){console.error("Error: Expected an array of messages but received:",o),f.value=[];return}f.value=T(o)}finally{y.value=!1}}function T(s){const o=new Map,u=[];return s.forEach(i=>{o.set(i.id,{...i,children:[],is_leaf:!0})}),o.forEach(i=>{if(i.parent_message_id&&o.has(i.parent_message_id)){const e=o.get(i.parent_message_id);e.children.push(i),e.is_leaf=!1,i.is_root=!1}else u.push(i),i.is_root=!0}),o.forEach(i=>{i.children.sort((e,n)=>new Date(e.created_at)-new Date(n.created_at))}),u.sort((i,e)=>new Date(i.created_at)-new Date(e.created_at)),u}function S(s){t.switchBranch(s),m.closeModal("discussionTree")}return(s,o)=>(a(),D(J,{"modal-name":"discussionTree",title:v.value?`Discussion Tree: ${v.value.title}`:"Discussion Tree","max-width-class":"max-w-4xl"},{body:I(()=>[y.value?(a(),c("div",ge,[N(H,{class:"w-8 h-8 text-gray-500"}),o[1]||(o[1]=l("span",{class:"ml-3 text-gray-500"},"Loading discussion tree...",-1))])):b.value?f.value.length===0?(a(),c("div",be," No messages found for this discussion. ")):(a(),c("div",ye,[(a(!0),c(A,null,j(f.value,u=>(a(),D(he,{key:u.id,node:u,level:0,"active-branch-id":p.value,onSelectBranch:S},null,8,["node","active-branch-id"]))),128))])):(a(),c("div",me," No discussion selected. "))]),footer:I(()=>[l("button",{onClick:o[0]||(o[0]=u=>G(m).closeModal("discussionTree")),class:"btn btn-secondary"},"Close")]),_:1},8,["title"]))}},ke=$(_e,[["__scopeId","data-v-8039cd17"]]);export{ke as default};
