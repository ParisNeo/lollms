import{L as q,aa as K,u as X,i as Y,c as _,an as Z,N as h,m as C,am as ee,a as m,o as n,w as O,b as s,d as o,e as r,g as p,f as v,at as se,n as b,h as d,aD as M,t as i,aB as j,ax as te,W as T,aE as R,aL as ae,ak as le,F as V,r as B,aj as ne,aA as E,cG as N,aC as F,cy as oe,J as re,M as ie,Q as J}from"./index-CpNEmBDf.js";import{_ as de}from"./GenericModal-DyRxZVIy.js";import{I as ue}from"./IconUser-DkFH9WaJ.js";const ce={class:"space-y-4"},ge={class:"flex items-center justify-between flex-wrap gap-2"},me={class:"flex items-center gap-2"},ve=["disabled"],fe=["disabled"],pe=["disabled"],be={key:0,class:"p-3 bg-gray-50 dark:bg-gray-700/50 rounded-lg border dark:border-gray-600"},ye={class:"flex items-center justify-start space-x-6"},xe={class:"flex items-center space-x-4"},ke={class:"flex items-center text-sm"},we={class:"flex items-center text-sm"},_e={class:"flex items-center text-sm"},he={class:"grid grid-cols-1 md:grid-cols-3 gap-6 h-[60vh]"},Ce={class:"md:col-span-1 bg-white dark:bg-gray-800 rounded-lg shadow-sm overflow-hidden flex flex-col"},Te={class:"p-4 border-b dark:border-gray-700 flex-shrink-0 space-y-3"},Se={class:"relative"},Le={class:"pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3"},Ie={class:"flex-grow overflow-y-auto"},Ae={key:0,class:"p-4 text-center text-gray-500"},Me={key:1,class:"p-4 text-center text-gray-500"},Re={key:2,class:"divide-y dark:divide-gray-700"},Ne=["onClick"],De={class:"flex justify-between items-center mb-1"},$e=["title"],Ue={class:"w-full bg-gray-200 rounded-full h-1.5 dark:bg-gray-600 mb-2"},Oe={key:0,class:"flex items-center text-xs text-gray-500 dark:text-gray-400"},je={class:"md:col-span-2 bg-white dark:bg-gray-800 rounded-lg shadow-sm flex flex-col h-full overflow-hidden"},Ve={key:0,class:"h-full flex items-center justify-center text-center p-4"},Be={key:1,class:"flex flex-col h-full"},Ee={class:"p-4 border-b dark:border-gray-700 flex-shrink-0"},Fe=["title"],Je={class:"text-xs text-gray-500 dark:text-gray-400 flex items-center"},Ge={class:"ml-1 mr-2"},We={class:"flex-grow min-h-0 flex flex-col p-4 space-y-4 overflow-y-auto"},ze={class:"space-y-3 text-sm flex-shrink-0"},Pe={class:"flex-shrink-0 mr-4"},He={class:"flex-grow"},Qe={class:"grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2"},qe={key:0,class:"info-details error",open:""},Ke={key:1,class:"info-details success"},Xe={class:"flex-grow min-h-0 flex flex-col pt-4 border-t dark:border-gray-700"},Ye={class:"font-semibold mb-2 flex-shrink-0 flex items-center justify-between"},Ze={class:"log-timestamp font-mono"},es={class:"log-message-wrapper"},ss={key:0,class:"text-gray-400 italic"},ts={__name:"TasksManagerModal",setup(as){const g=K(),f=X(),y=Y(),G=_(()=>f.modalData("tasksManager")),D=_(()=>{var l;return(l=G.value)==null?void 0:l.initialTaskId}),{tasks:W,isLoadingTasks:S,activeTasksCount:L,isClearingTasks:I}=Z(g),t=h(null),x=h(null),u=h("all"),k=h(""),c=_(()=>[...W.value].sort((l,e)=>new Date(e.created_at)-new Date(l.created_at))),$=_(()=>{if(!k.value)return c.value;const l=k.value.toLowerCase();return c.value.filter(e=>e.name&&e.name.toLowerCase().includes(l)||e.id&&e.id.toLowerCase().includes(l)||e.owner_username&&e.owner_username.toLowerCase().includes(l))});C(()=>f.isModalOpen("tasksManager"),l=>{l&&(g.fetchTasks(u.value),D.value&&c.value.length>0?t.value=c.value.find(e=>e.id===D.value)||c.value[0]:c.value.length>0?t.value=c.value[0]:t.value=null)}),C(u,l=>{g.fetchTasks(l)}),C(c,l=>{if(t.value){const e=l.find(a=>a.id===t.value.id);e?JSON.stringify(t.value.logs)!==JSON.stringify(e.logs)?t.value=e:Object.assign(t.value,e):t.value=l.length>0?l[0]:null}else l.length>0&&(t.value=l[0])}),C(()=>{var l;return(l=t.value)==null?void 0:l.logs},()=>{ee(()=>{x.value&&(x.value.scrollTop=x.value.scrollHeight)})},{deep:!0});function A(l){return l?new Date(l).toLocaleString():"N/A"}function U(l){switch(l){case"running":return{text:"Running"};case"completed":return{text:"Completed",icon:F,color:"text-green-500"};case"failed":return{text:"Failed",icon:N,color:"text-red-500"};case"cancelled":return{text:"Cancelled",icon:M,color:"text-yellow-500"};case"pending":default:return{text:"Pending"}}}function z(l){switch(l==null?void 0:l.toUpperCase()){case"ERROR":case"CRITICAL":return"text-red-500 dark:text-red-400";case"WARNING":return"text-yellow-500 dark:text-yellow-400";default:return"text-gray-600 dark:text-gray-300"}}const P=l=>{switch(l==null?void 0:l.toUpperCase()){case"ERROR":case"CRITICAL":return N;case"WARNING":return J;default:return J}};async function H(){(await f.showConfirmation({title:"Cancel All Active Tasks",message:`Are you sure you want to cancel all ${L.value} active background tasks?`,confirmText:"Cancel All"})).confirmed&&await g.cancelAllTasks()}function Q(){if(!t.value||!t.value.logs)return;const l=t.value.logs.map(e=>{const a=new Date(e.timestamp).toLocaleTimeString(),w=e.level.toUpperCase();return`[${a}] [${w}] ${e.message}`}).join(`
`);f.copyToClipboard(l,"Logs copied to clipboard!")}return(l,e)=>(n(),m(de,{"modal-name":"tasksManager",title:"Background Tasks","max-width-class":"max-w-6xl"},{body:O(()=>[s("div",ce,[s("div",ge,[e[10]||(e[10]=s("p",{class:"text-sm text-gray-500"},"Monitor your background processes.",-1)),s("div",me,[s("button",{onClick:e[0]||(e[0]=a=>o(g).fetchTasks(u.value)),class:"btn btn-secondary btn-sm",disabled:o(S)},[v(se,{class:b(["w-4 h-4",{"animate-spin":o(S)}])},null,8,["class"])],8,ve),s("button",{onClick:H,class:"btn btn-warning btn-sm",disabled:o(L)===0||o(I)},[v(M,{class:"w-4 h-4 mr-1"}),d(" Cancel All ("+i(o(L))+") ",1)],8,fe),s("button",{onClick:e[1]||(e[1]=(...a)=>o(g).clearCompletedTasks&&o(g).clearCompletedTasks(...a)),class:"btn btn-danger btn-sm",disabled:o(I)},[o(I)?(n(),m(j,{key:0,class:"w-4 h-4 mr-1 animate-spin"})):(n(),m(te,{key:1,class:"w-4 h-4 mr-1"})),e[9]||(e[9]=d(" Clear Completed "))],8,pe)])]),o(y).isAdmin?(n(),r("div",be,[s("div",ye,[e[14]||(e[14]=s("span",{class:"text-sm font-medium"},"Show tasks for:",-1)),s("div",xe,[s("label",ke,[T(s("input",{type:"radio","onUpdate:modelValue":e[2]||(e[2]=a=>u.value=a),value:"all",class:"form-radio"},null,512),[[R,u.value]]),e[11]||(e[11]=s("span",{class:"ml-2"},"All Users",-1))]),s("label",we,[T(s("input",{type:"radio","onUpdate:modelValue":e[3]||(e[3]=a=>u.value=a),value:"me",class:"form-radio"},null,512),[[R,u.value]]),e[12]||(e[12]=s("span",{class:"ml-2"},"My Tasks",-1))]),s("label",_e,[T(s("input",{type:"radio","onUpdate:modelValue":e[4]||(e[4]=a=>u.value=a),value:"others",class:"form-radio"},null,512),[[R,u.value]]),e[13]||(e[13]=s("span",{class:"ml-2"},"Other Users",-1))])])])])):p("",!0),s("div",he,[s("div",Ce,[s("div",Te,[e[15]||(e[15]=s("h3",{class:"font-semibold"},"Tasks",-1)),s("div",Se,[s("div",Le,[v(ae,{class:"h-4 w-4 text-gray-400"})]),T(s("input",{type:"text","onUpdate:modelValue":e[5]||(e[5]=a=>k.value=a),placeholder:"Search tasks...",class:"w-full text-sm pl-9 pr-4 py-1.5 rounded-md border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700"},null,512),[[le,k.value]])])]),s("div",Ie,[o(S)&&c.value.length===0?(n(),r("div",Ae,"Loading...")):$.value.length===0?(n(),r("div",Me,"No tasks found.")):(n(),r("ul",Re,[(n(!0),r(V,null,B($.value,a=>(n(),r("li",{key:a.id},[s("button",{onClick:w=>t.value=a,class:b(["w-full text-left p-4 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors",{"bg-blue-50 dark:bg-blue-900/30":t.value&&t.value.id===a.id}])},[s("div",De,[s("p",{class:"font-medium truncate text-sm",title:a.name},i(a.name),9,$e),s("span",{class:b(["text-xs px-2 py-0.5 rounded-full",{"bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-300":a.status==="running"||a.status==="pending","bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300":a.status==="completed","bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300":a.status==="failed","bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300":a.status==="cancelled"}])},i(U(a.status).text),3)]),s("div",Ue,[s("div",{class:b(["h-1.5 rounded-full",{"bg-blue-500":a.status==="running"||a.status==="pending","bg-green-500":a.status==="completed","bg-red-500":a.status==="failed","bg-yellow-500":a.status==="cancelled"}]),style:ne({width:a.progress+"%"})},null,6)]),o(y).isAdmin?(n(),r("div",Oe,[v(ue,{class:"w-3 h-3 mr-1.5"}),s("span",null,i(a.owner_username||"System"),1)])):p("",!0)],10,Ne)]))),128))]))])]),s("div",je,[t.value?(n(),r("div",Be,[s("div",Ee,[s("h3",{class:"font-semibold truncate",title:t.value.name},i(t.value.name),9,Fe),s("div",Je,[e[17]||(e[17]=d("ID: ")),s("code",Ge,i(t.value.id),1),s("button",{onClick:e[6]||(e[6]=a=>o(f).copyToClipboard(t.value.id)),class:"p-0.5 rounded hover:bg-gray-200 dark:hover:bg-gray-600"},[v(E,{class:"w-3 h-3"})])])]),s("div",We,[s("div",ze,[s("div",{class:b(["p-3 rounded-lg flex items-center",{"bg-blue-50 dark:bg-blue-900/20":t.value.status==="running"||t.value.status==="pending","bg-green-50 dark:bg-green-900/20":t.value.status==="completed","bg-red-50 dark:bg-red-900/20":t.value.status==="failed","bg-yellow-50 dark:bg-yellow-900/20":t.value.status==="cancelled"}])},[s("div",Pe,[t.value.status==="failed"?(n(),m(N,{key:0,class:"w-8 h-8 text-red-400"})):t.value.status==="completed"?(n(),m(F,{key:1,class:"w-8 h-8 text-green-400"})):t.value.status==="cancelled"?(n(),m(M,{key:2,class:"w-8 h-8 text-yellow-400"})):(n(),m(j,{key:3,class:"w-8 h-8 text-blue-400 animate-spin"}))]),s("div",He,[e[18]||(e[18]=s("span",{class:"font-semibold"},"Status:",-1)),d(" "+i(U(t.value.status).text),1)]),(t.value.status==="running"||t.value.status==="pending")&&(o(y).isAdmin||t.value.owner_username===o(y).user.username)?(n(),r("button",{key:0,onClick:e[7]||(e[7]=a=>o(g).cancelTask(t.value.id)),class:"btn btn-warning btn-sm"},[v(oe,{class:"w-4 h-4 mr-1"}),e[19]||(e[19]=d("Cancel Task "))])):p("",!0)],2),s("div",Qe,[s("p",null,[e[20]||(e[20]=s("strong",null,"Owner:",-1)),d(" "+i(t.value.owner_username||"System"),1)]),s("p",null,[e[21]||(e[21]=s("strong",null,"Created:",-1)),d(" "+i(A(t.value.created_at)),1)]),s("p",null,[e[22]||(e[22]=s("strong",null,"Started:",-1)),d(" "+i(A(t.value.started_at)),1)]),s("p",null,[e[23]||(e[23]=s("strong",null,"Completed:",-1)),d(" "+i(A(t.value.completed_at)),1)])]),t.value.error?(n(),r("details",qe,[e[24]||(e[24]=s("summary",null,"Error Details",-1)),s("pre",null,i(t.value.error),1)])):p("",!0),t.value.result?(n(),r("details",Ke,[e[25]||(e[25]=s("summary",null,"Result Data",-1)),s("pre",null,i(JSON.stringify(t.value.result,null,2)),1)])):p("",!0)]),s("div",Xe,[s("h4",Ye,[e[27]||(e[27]=s("span",null,"Logs",-1)),s("button",{onClick:Q,class:"btn btn-secondary btn-sm"},[v(E,{class:"w-4 h-4"}),e[26]||(e[26]=d(" Copy Logs"))])]),s("div",{ref_key:"logsContainer",ref:x,class:"flex-grow bg-gray-100 dark:bg-gray-900 rounded p-2 overflow-y-auto text-xs"},[(n(!0),r(V,null,B(t.value.logs,(a,w)=>(n(),r("div",{key:w,class:b(["log-entry",z(a.level)])},[s("span",Ze,i(new Date(a.timestamp).toLocaleTimeString([],{hour12:!1})),1),(n(),m(re(P(a.level)),{class:"log-icon"})),s("div",es,[v(ie,{content:a.message,class:"log-message prose dark:prose-invert prose-sm max-w-none"},null,8,["content"])])],2))),128)),!t.value.logs||t.value.logs.length===0?(n(),r("div",ss,"No logs for this task yet.")):p("",!0)],512)])])])):(n(),r("div",Ve,e[16]||(e[16]=[s("p",{class:"text-gray-500"},"Select a task to view its details and logs.",-1)])))])])])]),footer:O(()=>[s("button",{onClick:e[8]||(e[8]=a=>o(f).closeModal("tasksManager")),class:"btn btn-primary"},"Close")]),_:1}))}},rs=q(ts,[["__scopeId","data-v-a51b63b7"]]);export{rs as default};
